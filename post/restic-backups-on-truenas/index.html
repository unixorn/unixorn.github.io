<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Restic Backups on TrueNAS | unixorn.github.io</title>
<meta name="keywords" content="backups, duplicacy, freebsd, homelab, restic, truenas">
<meta name="description" content="I&rsquo;ve been backing my homelab up with duplicacy (See Backing Up the Cluster Using Duplicacy), but I&rsquo;m fed up with it returning a 0 exit code even if there&rsquo;s a problem with the backup. This makes me have to do a lot of annoying rummaging through log output to be sure that a backup actually worked, so I decided to switch to restic.
In this blog entry, I&rsquo;m going to explain how to create a jail in TrueNAS, mount directories you want to back up into the jail, install restic, and how to use it to back up to Backblaze b2.">
<meta name="author" content="Me">
<link rel="canonical" href="https://unixorn.github.io/post/restic-backups-on-truenas/">
<meta name="google-site-verification" content="UA-100853138-2">
<link crossorigin="anonymous" href="https://unixorn.github.io/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://unixorn.github.io/post/restic-backups-on-truenas/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Restic Backups on TrueNAS" />
<meta property="og:description" content="I&rsquo;ve been backing my homelab up with duplicacy (See Backing Up the Cluster Using Duplicacy), but I&rsquo;m fed up with it returning a 0 exit code even if there&rsquo;s a problem with the backup. This makes me have to do a lot of annoying rummaging through log output to be sure that a backup actually worked, so I decided to switch to restic.
In this blog entry, I&rsquo;m going to explain how to create a jail in TrueNAS, mount directories you want to back up into the jail, install restic, and how to use it to back up to Backblaze b2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://unixorn.github.io/post/restic-backups-on-truenas/" />
<meta property="og:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E" />
<meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-01-13T11:16:19-07:00" />
<meta property="article:modified_time" content="2023-01-13T11:16:19-07:00" /><meta property="og:site_name" content="The Plural of SRE is an Outage" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E" />
<meta name="twitter:title" content="Restic Backups on TrueNAS"/>
<meta name="twitter:description" content="I&rsquo;ve been backing my homelab up with duplicacy (See Backing Up the Cluster Using Duplicacy), but I&rsquo;m fed up with it returning a 0 exit code even if there&rsquo;s a problem with the backup. This makes me have to do a lot of annoying rummaging through log output to be sure that a backup actually worked, so I decided to switch to restic.
In this blog entry, I&rsquo;m going to explain how to create a jail in TrueNAS, mount directories you want to back up into the jail, install restic, and how to use it to back up to Backblaze b2."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://unixorn.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Restic Backups on TrueNAS",
      "item": "https://unixorn.github.io/post/restic-backups-on-truenas/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Restic Backups on TrueNAS",
  "name": "Restic Backups on TrueNAS",
  "description": "I\u0026rsquo;ve been backing my homelab up with duplicacy (See Backing Up the Cluster Using Duplicacy), but I\u0026rsquo;m fed up with it returning a 0 exit code even if there\u0026rsquo;s a problem with the backup. This makes me have to do a lot of annoying rummaging through log output to be sure that a backup actually worked, so I decided to switch to restic.\nIn this blog entry, I\u0026rsquo;m going to explain how to create a jail in TrueNAS, mount directories you want to back up into the jail, install restic, and how to use it to back up to Backblaze b2.",
  "keywords": [
    "backups", "duplicacy", "freebsd", "homelab", "restic", "truenas"
  ],
  "articleBody": "I’ve been backing my homelab up with duplicacy (See Backing Up the Cluster Using Duplicacy), but I’m fed up with it returning a 0 exit code even if there’s a problem with the backup. This makes me have to do a lot of annoying rummaging through log output to be sure that a backup actually worked, so I decided to switch to restic.\nIn this blog entry, I’m going to explain how to create a jail in TrueNAS, mount directories you want to back up into the jail, install restic, and how to use it to back up to Backblaze b2.\nBackground I’m tired of worrying about whether I found all the possible duplicacy error messages, or made a mistake in one of the regexes for the errors I have seen. I want my backups nice and boring so I don’t go to do a restore and find out “Oops! We had a new failure mode you hadn’t seen before, so the backups haven’t been working for three months, too bad about your data!”\nMy work had a holiday shutdown, so I decided it was past time to switch to a better backup system. Of course I’m going to keep running the old crappy one for a couple of months in parallel because I don’t want to find a problem with the new one after three months of usage when I do my next restore test. You do test your restores periodically, I hope.\nI’ve been running TrueNAS Core (formerly FreeNAS) long enough that I’ve upgraded to larger drives in the zpool three times. I picked it because FreeNAS fully supported ZFS, I could buy a chassis with 4 hot-swap bays, I could buy it from the company that makes the software, both to support the open source project and to ensure that I had fully supported hardware.\nCan I build a server from parts? Sure, I’ve done it before. Do I want to build a server from parts and have to fight with a bunch of different vendors if something goes awry? Oh hell no, especially for the server with all my photos on it. I opted to minimize my hassle factor, support the FreeNAS project, and only have to deal with one vendor in case of any hardware issues. I bought a 4 bay FreeNAS mini, and have been happy with it for 7+ years.\nAnyway, enough background on the server I’m backing up.\nWhy restic? restic is:\nOpen Source Works on macOS, Windows, Linux and (most importantly for TrueNAS) FreeBSD Written in go, so it’s a single binary blob and we don’t have to worry about installing a bunch of dependencies inside the jail Does data deduplication and compression on your backups. Since we pay Backblaze based on space usage, this reduces the backup cost Why Jails? TrueNAS Core is based on FreeBSD, so the native way of running software in an isolated environment are jails (one of the inspirations for docker containers). I could run it in a docker container, but that would burn more resources because I’d have to run it in a docker vm.\nWhy B2? I’ve been using Backblaze b2 for years. It has a s3-compatible API so a lot of s3-aware applications work with it easily, Backblaze only does storage so I don’t have to worry about it going away, and last but definitely not least, it only costs 20% of what the same amount of data would cost to store in S3.\nrestic supports a lot of other storage back ends (including local disk), but I’m only going to discuss b2 here.\nAll that said, let’s get down to it.\nSet up B2 First, create an account at Backblaze.com.\nNow that you have an account, you’ll need to create a bucket to store your backups in. Log into your account and click Buckets in the sidebar on the left, then Create a Bucket. Give your new bucket a unique name, make sure it’s set to private (which should be set by default), and click create.\nYou’ll also need an application key that restic can use to connect to b2.\nDo not use your master application key! You should restrict restic to just the bucket you want it using - don’t give it power over your entire backblaze account. Click App Keys at the bottom of the sidebar, then Add a New Application Key, give it a name (I used restic-key), select the bucket you just created from the Allow access to buckets dropdown menu, and create the key. Copy the key into your password manager, it’ll only be displayed once. Copy the keyID too, you’ll need both of them when we configure restic.\nCreate a jail for restic Use the TrueNAS wizard to create your restic jail.\nLog into your TrueNAS webui Click Jails. Click add. You should see something similar to Give it a name (make life easy for yourself and don’t include spaces or any special characters other than -), leave the jail type as default, select whatever the highest FreeBSD version is showing available in the release drop-down menu, then next It’s going to need network access, so click DHCP Autoconfigure, and if it doesn’t automatically populate the VNET checkbox, enable that too, then next It’ll show you a summary of your settings that should look something like click submit to create the new jail. Add Mount Points By default, your jail can’t see any directory trees outside itself. That’s great for security, but not so great if we want to back up files outside the jail, so we’re going to add some mount points.\nAdd the mount points before you start the new jail - you can’t add them to a running jail. You can stop the jail, add/remove mount points, then restart it, but it’s easier to set them up before starting the jail.\nSelect your new jail, and select add mountpoint .\nYou can either make individual mounts for the directories you want to back up, or you can make one for your whole zpool. Whichever you pick, I recommend setting them read-only so you can’t accidentally restore an older version of a file over the current version.\nMake a directory outside the jail to store configuration files and to restore files to, and don’t set it read-only. Segregating the config/restore directory to a separate mount point will make it easier to examine restored files before putting them back where they belong.\nNow that you have your mount points added to your jail, go ahead and start your jail. It should take less than a minute to start.\nInstall restic Now that the jail is running, you’ll have to install restic into it.\nssh into your TrueNAS server Enter the jail so you can install software by running sudo iocage console YOURJAILNAME pkg install ca_root_nss restic Configure restic \u0026 do your first backup For convenience, I store the various settings as environment variable exports in a shell script that I can source for a couple of reasons:\nThis makes it easy to do the backups via cron and also to do test backups and restores from within the jail. I don’t have to write a config file parser and overcomplicate things Install the driver script and config files ssh into your TrueNAS server and stick the following files in a directory visible inside your backups jail.\nHere’s the restic-driver script I use to run restic and trim snapshots once they age out.\n#!/usr/bin/env bash # # restic-driver-script # # License: Apache 2.0 # Copyright 2023 Joe Block set -o pipefail if [[ -n \"$DEBUG\" ]]; then set -x fi function debug() { if [[ -n \"$DEBUG\" ]]; then echo \"$@\" fi } function fail() { printf '%s\\n' \"$1\" \u003e\u00262 ## Send message to stderr. Exclude \u003e\u00262 if you don't want it that way. exit \"${2-1}\" ## Return a code specified by $2 or 1 by default. } function has() { # Check if a command is in $PATH which \"$@\" \u003e /dev/null 2\u003e\u00261 } function show_params() { debug \"BACKUP_PATHS: $BACKUP_PATHS\" debug \"EXCLUDE_FILE: $EXCLUDE_FILE\" debug \"DRY_RUN: $DRY_RUN\" debug \" \" debug \"Retention settings:\" debug \"Minimum snapshots $MINIMUM_SNAPSHOTS_RETAINED\" debug \"Hourly snapshots: $HOURS_RETAINED\" debug \"Daily snapshots: $DAYS_RETAINED\" debug \"Weekly snapshots: $WEEKS_RETAINED\" debug \"Monthly snapshots: $MONTHS_RETAINED\" debug \"Yearly snapshots: $YEARS_RETAINED\" } if ! has restic; then fail \"Can't find restic in $PATH!\" fi # Our first argument is the settings file to source to get our backup # parameters, so peel it off - we'll pass all the other arguments directly # to restic PREFS_F=\"$1\" shift if [[ ! -r \"$PREFS_F\" ]]; then fail \"Can't load $PREFS_F\" fi source \"$PREFS_F\" show_params # If you're backing up a filesystem that you're mounting by FUSE, the inode # information is misleading at best, so add --ignore-inode. restic backup --verbose=2 \\ --exclude=.duplicacy \\ --exclude=.DS_Store \\ --tag periodic \\ -o b2.connections=15 \\ $EXCLUDE_FILE $DRY_RUN $BACKUP_PATHS $@ if [[ $? != 0 ]]; then fail \"restic backup failed\" # We don't want to prune any snapshots if this backup failed fi # Prune backup snapshots restic forget --verbose \\ --tag periodic \\ --group-by \"paths,tags\" \\ --keep-last $MINIMUM_SNAPSHOTS_RETAINED \\ --keep-hourly $HOURS_RETAINED \\ --keep-daily $DAYS_RETAINED \\ --keep-weekly $WEEKS_RETAINED \\ --keep-monthly $MONTHS_RETAINED \\ --keep-yearly $YEARS_RETAINED if [[ $? != 0 ]]; then fail \"restic snapshot cleanup failed\" fi Here’s an example settings file for it:\n#!/usr/bin/env bash # # Here are our backup settings # export B2_ACCOUNT_ID='your_b2_account_id' export B2_ACCOUNT_KEY='your_b2_key' # Use different directory prefixes for each backup repo # so they can share a bucket without interference export RESTIC_REPOSITORY='b2:your-restic-backups-bucket:dir-prefix' # This is used as the encryption key for your backups. If you lose it, # you won't be able to restore anything. I keep a copy of mine in my # 1Password vault export RESTIC_PASSWORD='your-encryption-key' # If you want to exclude some directories from your backups, list # them in an exclude file and set EXCLUDE_FILE export EXCLUDE_FILE=\"--exclude-file=example-excludes\" # Uncomment if you only want to dry-run and not actually write any data # to the backup repository #export DRYRUN='--dry-run' # What paths do we want to back up? Remember to use the paths as seen inside # the jail, not the paths as seen in your TrueNAS environment export BACKUP_PATHS=\"/mnt/path-inside-jail/share /mnt/path-inside-jail/anothershare\" # How many snapshots do we want to keep around? export MINIMUM_SNAPSHOTS_RETAINED=4 export HOURS_RETAINED=48 export DAYS_RETAINED=14 export WEEKS_RETAINED=8 export MONTHS_RETAINED=12 export YEARS_RETAINED=5 And here’s an example excludes file - it’s a list of paths to directories and files we don’t want to back up - I don’t back up my downloads or installers directories since that’s all stuff I can re-download later if necessary, and I’m better off getting the current version anyway.\n/mnt/path-inside-jail/Downloads /mnt/path-inside-jail/Installers/*.dmg Test your backups You’ll have to do this from inside the backups jail you created. ssh to your server, then run sudo iocage console YOURJAILNAME\nI recommend you set BACKUPS_PATH in your settings file to a single small directory to make your testing faster. You can change it to the path to your full directory tree once you confirm your backups and restores are working as expected.\nInitialize your backup repository Now that you’re inside the jail, you’re going to have to initialize the repository directory in your B2 bucket. FreeBSD/TrueNAS uses csh as the default root shell, but our settings file is set up for bash, so start by running exec bash to get a decent shell.\nLoad the configuration file you created by running source /path/to/yoursettingsfile.sh, then run restic init.\nYou’re ready to do a backup.\nRun a backup Now that your repository has been initialized, run /path/to/restic-driver /path/to/yoursettingsfile.sh\nIt shouldn’t take long if you used a small test subdirectory.\nTest a restore First, let’s look at the list of snapshots with restic snapshots.\nNow we can list the files in the snapshot with either restic ls SNAPSHOTID or restic ls latest\nPick a file and restore it.\nMake a directory to restore to - mkdir ./restores Restore the file. We don’t want to restore the entire snapshot, just a specific file/directory, so we’ll use --include and run restic restore latest --target ./restores --include /mnt/path/to/file It put the whole directory path for that file inside ./restores, so we’ll do a simple md5 check with md5sum /path/to/test/file ./restores/path/to/test/file Run restic out of cron Great, you’re almost done. All we have to do now is add it to cron so it runs at least once a day. You need to add it to the crontab inside the jail though, or TrueNAS won’t find your script.\nI stored my restic backup script and configuration in a directory that appears as /mnt/alcatraz inside my backups jail. Change the path to match wherever you stored yours.\nRun crontab -e and add the following:\n# minute\thour\tmday\tmonth\twday\tcommand 13 */4 * * * /mnt/alcatraz/restic-driver /mnt/alcatraz/backup-settings.sh | logger -t backups I tagged all the log output with backups to make it easier to grep out of /var/log/messages, and I run mine four times a day. You may prefer a different cadence, if so set the hour field accordingly. restic locks the repository when it starts, so you don’t have to worry about repository corruption if you accidentally try to run more than one backup at a time, or one runs so long that it isn’t complete before the next run starts.\nUpdate: Jesse Alter wrote a perl version of this script, you can find it on GitHub at jessealter/restickit.\n",
  "wordCount" : "2237",
  "inLanguage": "en",
  "image": "https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished": "2023-01-13T11:16:19-07:00",
  "dateModified": "2023-01-13T11:16:19-07:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://unixorn.github.io/post/restic-backups-on-truenas/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "unixorn.github.io",
    "logo": {
      "@type": "ImageObject",
      "url": "https://unixorn.github.io/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://unixorn.github.io/" accesskey="h" title="Home (Alt + H)">
                <img src="https://unixorn.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://unixorn.github.io/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/projects/" title="projects">
                    <span>projects</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://hachyderm.io/@unixorn" title="hachyderm.io/@unixorn">
                    <span>hachyderm.io/@unixorn</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">
<link rel="stylesheet" type="text/css" href="https://unixorn.github.io/css/mastodon.css" />
<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://unixorn.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://unixorn.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      Restic Backups on TrueNAS
    </h1>
    <div class="post-meta"><span title='2023-01-13 11:16:19 -0700 MST'>January 13, 2023</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;2237 words&nbsp;·&nbsp;Me

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a></li>
    <li><a href="#why-restic">Why restic?</a></li>
    <li><a href="#why-jails">Why Jails?</a></li>
    <li><a href="#why-b2">Why B2?</a></li>
    <li><a href="#set-up-b2">Set up B2</a></li>
    <li><a href="#create-a-jail-for-restic">Create a jail for restic</a>
      <ul>
        <li><a href="#add-mount-points">Add Mount Points</a></li>
        <li><a href="#install-restic">Install restic</a></li>
        <li><a href="#configure-restic--do-your-first-backup">Configure restic &amp; do your first backup</a></li>
        <li><a href="#test-your-backups">Test your backups</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>I&rsquo;ve been backing my homelab up with <code>duplicacy</code> (See <a href="https://unixorn.github.io/post/backing-up-the-cluster-with-duplicacy/">Backing Up the Cluster Using Duplicacy</a>), but I&rsquo;m fed up with it returning a <code>0</code> exit code <em>even if there&rsquo;s a problem with the backup</em>. This makes me have to do a lot of annoying rummaging through log output to be sure that a backup actually worked, so I decided to switch to <a href="https://restic.net/">restic</a>.</p>
<!-- raw HTML omitted -->
<p>In this blog entry, I&rsquo;m going to explain how to create a jail in TrueNAS, mount directories you want to back up into the jail, install <a href="https://restic.net/">restic</a>, and how to use it to back up to <a href="https://www.backblaze.com/b2/cloud-storage.html">Backblaze b2</a>.</p>
<h2 id="background">Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h2>
<p>I&rsquo;m tired of worrying about whether I found all the possible <code>duplicacy</code> error messages, or made a mistake in one of the regexes for the errors I have seen. I want my backups nice and boring so I don&rsquo;t go to do a restore and find out &ldquo;Oops! We had a new failure mode you hadn&rsquo;t seen before, so the backups haven&rsquo;t been working for three months, too bad about your data!&rdquo;</p>
<p>My work had a holiday shutdown, so I decided it was past time to switch to a better backup system. Of course I&rsquo;m going to keep running the old crappy one for a couple of months in parallel because I don&rsquo;t want to find a problem with the new one after three months of usage when I do my next restore test. You <em>do</em> test your restores periodically, I hope.</p>
<p>I&rsquo;ve been running <a href="https://www.truenas.com/">TrueNAS Core</a> (formerly FreeNAS) long enough that I&rsquo;ve upgraded to larger drives in the zpool three times. I picked it because FreeNAS fully supported ZFS, I could buy a chassis with 4 hot-swap bays, I could buy it from the company that makes the software, both to support the open source project and to ensure that I had fully supported hardware.</p>
<p>Can I build a server from parts? Sure, I&rsquo;ve done it before. Do I <em>want</em> to build a server from parts and have to fight with a bunch of different vendors if something goes awry? Oh <em>hell</em> no, especially for the server with all my photos on it. I opted to minimize my hassle factor, support the FreeNAS project, and only have to deal with one vendor in case of any hardware issues. I bought a 4 bay FreeNAS mini, and have been happy with it for 7+ years.</p>
<p>Anyway, enough background on the server I&rsquo;m backing up.</p>
<h2 id="why-restic">Why restic?<a hidden class="anchor" aria-hidden="true" href="#why-restic">#</a></h2>
<p><code>restic</code> is:</p>
<ul>
<li>Open Source</li>
<li>Works on macOS, Windows, Linux and (most importantly for TrueNAS) FreeBSD</li>
<li>Written in <code>go</code>, so it&rsquo;s a single binary blob and we don&rsquo;t have to worry about installing a bunch of dependencies inside the jail</li>
<li>Does data deduplication and compression on your backups. Since we pay Backblaze based on space usage, this reduces the backup cost</li>
</ul>
<h2 id="why-jails">Why Jails?<a hidden class="anchor" aria-hidden="true" href="#why-jails">#</a></h2>
<p>TrueNAS Core is based on FreeBSD, so the native way of running software in an isolated environment are jails (one of the inspirations for docker containers). I <em>could</em> run it in a docker container, but that would burn more resources because I&rsquo;d have to run it in a docker vm.</p>
<h2 id="why-b2">Why B2?<a hidden class="anchor" aria-hidden="true" href="#why-b2">#</a></h2>
<p>I&rsquo;ve been using <a href="https://www.backblaze.com/b2/cloud-storage.html">Backblaze b2</a> for years. It has a s3-compatible API so a lot of s3-aware applications work with it easily, Backblaze only does storage so I don&rsquo;t have to worry about it going away, and last but definitely not least, it only costs 20% of what the same amount of data would cost to store in S3.</p>
<p><code>restic</code> supports a lot of other storage back ends (including local disk), but I&rsquo;m only going to discuss b2 here.</p>
<p>All that said, let&rsquo;s get down to it.</p>
<h2 id="set-up-b2">Set up B2<a hidden class="anchor" aria-hidden="true" href="#set-up-b2">#</a></h2>
<p>First, create an account at <a href="https://www.backblaze.com/">Backblaze.com</a>.</p>
<p>Now that you have an account, you&rsquo;ll need to create a bucket to store your backups in. Log into your account and click <strong>Buckets</strong> in the sidebar on the left, then <strong>Create a Bucket</strong>. Give your new bucket a unique name, make sure it&rsquo;s set to private (which should be set by default), and click create.</p>
<p>You&rsquo;ll also need an application key that <code>restic</code> can use to connect to b2.</p>
<p><strong>Do not use your master application key!</strong> You should restrict restic to just the bucket you want it using - don&rsquo;t give it power over your entire backblaze account. Click <strong>App Keys</strong> at the bottom of the sidebar, then <strong>Add a New Application Key</strong>, give it a name (I used <code>restic-key</code>), select the bucket you just created from the <strong>Allow access to buckets</strong> dropdown menu, and create the key. Copy the key into your password manager, it&rsquo;ll only be displayed once. Copy the <code>keyID</code> too, you&rsquo;ll need both of them when we configure <code>restic</code>.</p>
<h2 id="create-a-jail-for-restic">Create a jail for restic<a hidden class="anchor" aria-hidden="true" href="#create-a-jail-for-restic">#</a></h2>
<p>Use the TrueNAS wizard to create your <code>restic</code> jail.</p>
<ol>
<li>Log into your TrueNAS webui</li>
<li>Click <strong>Jails</strong>.</li>
<li>Click add. You should see something similar to</li>
<li>Give it a name (make life easy for yourself and don&rsquo;t include spaces or any special characters other than <code>-</code>), leave the jail type as default, select whatever the highest FreeBSD version is showing available in the release drop-down menu, then <strong>next</strong>
<img loading="lazy" src="https://unixorn.github.io/images/truenas-restic/01-make-jail.small.png" alt="Jails"  />
</li>
<li>It&rsquo;s going to need network access, so click <strong>DHCP Autoconfigure</strong>, and if it doesn&rsquo;t automatically populate the VNET checkbox, enable that too, then next
<img loading="lazy" src="https://unixorn.github.io/images/truenas-restic/02-jail-networking.small.png" alt="Jail Network Setup"  />
</li>
<li>It&rsquo;ll show you a summary of your settings that should look something like <img loading="lazy" src="https://unixorn.github.io/images/truenas-restic/03-jail-summary.small.png" alt="Jail Summary"  />
 click submit to create the new jail.</li>
</ol>
<h3 id="add-mount-points">Add Mount Points<a hidden class="anchor" aria-hidden="true" href="#add-mount-points">#</a></h3>
<p>By default, your jail can&rsquo;t see any directory trees outside itself. That&rsquo;s great for security, but not so great if we want to back up files outside the jail, so we&rsquo;re going to add some mount points.</p>
<p>Add the mount points before you start the new jail - you can&rsquo;t add them to a running jail. You <em>can</em> stop the jail, add/remove mount points, then restart it, but it&rsquo;s easier to set them up before starting the jail.</p>
<p>Select your new jail, and select add mountpoint <img loading="lazy" src="https://unixorn.github.io/images/truenas-restic/05-add-mountpoint.small.png" alt="Jails"  />
.</p>
<p>You can either make individual mounts for the directories you want to back up, or you can make one for your whole zpool. Whichever you pick, I recommend setting them read-only so you can&rsquo;t accidentally restore an older version of a file over the current version.</p>
<p>Make a directory outside the jail to store configuration files and to restore files to, and don&rsquo;t set it read-only. Segregating the config/restore directory to a separate mount point will make it easier to examine restored files before putting them back where they belong.</p>
<p>Now that you have your mount points added to your jail, go ahead and start your jail. It should take less than a minute to start.</p>
<h3 id="install-restic">Install restic<a hidden class="anchor" aria-hidden="true" href="#install-restic">#</a></h3>
<p>Now that the jail is running, you&rsquo;ll have to install <code>restic</code> into it.</p>
<ol>
<li><code>ssh</code> into your TrueNAS server</li>
<li>Enter the jail so you can install software by running <code>sudo iocage console YOURJAILNAME</code></li>
<li><code>pkg install ca_root_nss restic</code></li>
</ol>
<h3 id="configure-restic--do-your-first-backup">Configure restic &amp; do your first backup<a hidden class="anchor" aria-hidden="true" href="#configure-restic--do-your-first-backup">#</a></h3>
<p>For convenience, I store the various settings as environment variable exports in a shell script that I can source for a couple of reasons:</p>
<ol>
<li>This makes it easy to do the backups via <code>cron</code> and also to do test backups and restores from within the jail.</li>
<li>I don&rsquo;t have to write a config file parser and overcomplicate things</li>
</ol>
<h4 id="install-the-driver-script-and-config-files">Install the driver script and config files<a hidden class="anchor" aria-hidden="true" href="#install-the-driver-script-and-config-files">#</a></h4>
<p><code>ssh</code> into your TrueNAS server and stick the following files in a directory visible inside your backups jail.</p>
<p>Here&rsquo;s the <a href="https://unixorn.github.io/resources/truenas-restic/restic-driver"><code>restic-driver</code></a> script I use to run <code>restic</code> and trim snapshots once they age out.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/env bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># restic-driver-script</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># License: Apache 2.0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Copyright 2023 Joe Block &lt;jpb@unixorn.net&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$DEBUG</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">set</span> -x
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> debug<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$DEBUG</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> fail<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>  <span class="c1">## Send message to stderr. Exclude &gt;&amp;2 if you don&#39;t want it that way.</span>
</span></span><span class="line"><span class="cl">  <span class="nb">exit</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">2</span><span class="p">-1</span><span class="si">}</span><span class="s2">&#34;</span>  <span class="c1">## Return a code specified by $2 or 1 by default.</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> has<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Check if a command is in $PATH</span>
</span></span><span class="line"><span class="cl">  which <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> show_params<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;BACKUP_PATHS: </span><span class="nv">$BACKUP_PATHS</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;EXCLUDE_FILE: </span><span class="nv">$EXCLUDE_FILE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;DRY_RUN: </span><span class="nv">$DRY_RUN</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34; &#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;Retention settings:&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;Minimum snapshots </span><span class="nv">$MINIMUM_SNAPSHOTS_RETAINED</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;Hourly snapshots: </span><span class="nv">$HOURS_RETAINED</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;Daily snapshots:  </span><span class="nv">$DAYS_RETAINED</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;Weekly snapshots:  </span><span class="nv">$WEEKS_RETAINED</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;Monthly snapshots:  </span><span class="nv">$MONTHS_RETAINED</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debug <span class="s2">&#34;Yearly snapshots:  </span><span class="nv">$YEARS_RETAINED</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! has restic<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  fail <span class="s2">&#34;Can&#39;t find restic in </span><span class="nv">$PATH</span><span class="s2">!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Our first argument is the settings file to source to get our backup</span>
</span></span><span class="line"><span class="cl"><span class="c1"># parameters, so peel it off - we&#39;ll pass all the other arguments directly</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to restic</span>
</span></span><span class="line"><span class="cl"><span class="nv">PREFS_F</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">shift</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -r <span class="s2">&#34;</span><span class="nv">$PREFS_F</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  fail <span class="s2">&#34;Can&#39;t load </span><span class="nv">$PREFS_F</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">source</span> <span class="s2">&#34;</span><span class="nv">$PREFS_F</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">show_params
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># If you&#39;re backing up a filesystem that you&#39;re mounting by FUSE, the inode</span>
</span></span><span class="line"><span class="cl"><span class="c1"># information is misleading at best, so add --ignore-inode.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">restic backup --verbose<span class="o">=</span><span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --exclude<span class="o">=</span>.duplicacy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --exclude<span class="o">=</span>.DS_Store <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --tag periodic <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -o b2.connections<span class="o">=</span><span class="m">15</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">$EXCLUDE_FILE</span> <span class="nv">$DRY_RUN</span> <span class="nv">$BACKUP_PATHS</span> <span class="nv">$@</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  fail <span class="s2">&#34;restic backup failed&#34;</span> <span class="c1"># We don&#39;t want to prune any snapshots if this backup failed</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prune backup snapshots</span>
</span></span><span class="line"><span class="cl">restic forget --verbose <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --tag periodic <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --group-by <span class="s2">&#34;paths,tags&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-last <span class="nv">$MINIMUM_SNAPSHOTS_RETAINED</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-hourly <span class="nv">$HOURS_RETAINED</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-daily <span class="nv">$DAYS_RETAINED</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-weekly <span class="nv">$WEEKS_RETAINED</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-monthly <span class="nv">$MONTHS_RETAINED</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-yearly <span class="nv">$YEARS_RETAINED</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  fail <span class="s2">&#34;restic snapshot cleanup failed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>Here&rsquo;s an <a href="https://unixorn.github.io/resources/truenas-restic/example-settings.sh">example settings file</a> for it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/env bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Here are our backup settings</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">B2_ACCOUNT_ID</span><span class="o">=</span><span class="s1">&#39;your_b2_account_id&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">B2_ACCOUNT_KEY</span><span class="o">=</span><span class="s1">&#39;your_b2_key&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use different directory prefixes for each backup repo</span>
</span></span><span class="line"><span class="cl"><span class="c1"># so they can share a bucket without interference</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">RESTIC_REPOSITORY</span><span class="o">=</span><span class="s1">&#39;b2:your-restic-backups-bucket:dir-prefix&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># This is used as the encryption key for your backups. If you lose it,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># you won&#39;t be able to restore anything. I keep a copy of mine in my</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1Password vault</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">RESTIC_PASSWORD</span><span class="o">=</span><span class="s1">&#39;your-encryption-key&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># If you want to exclude some directories from your backups, list</span>
</span></span><span class="line"><span class="cl"><span class="c1"># them in an exclude file and set EXCLUDE_FILE</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">EXCLUDE_FILE</span><span class="o">=</span><span class="s2">&#34;--exclude-file=example-excludes&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Uncomment if you only want to dry-run and not actually write any data</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to the backup repository</span>
</span></span><span class="line"><span class="cl"><span class="c1">#export DRYRUN=&#39;--dry-run&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># What paths do we want to back up? Remember to use the paths as seen inside</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the jail, not the paths as seen in your TrueNAS environment</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">BACKUP_PATHS</span><span class="o">=</span><span class="s2">&#34;/mnt/path-inside-jail/share /mnt/path-inside-jail/anothershare&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># How many snapshots do we want to keep around?</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MINIMUM_SNAPSHOTS_RETAINED</span><span class="o">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HOURS_RETAINED</span><span class="o">=</span><span class="m">48</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DAYS_RETAINED</span><span class="o">=</span><span class="m">14</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">WEEKS_RETAINED</span><span class="o">=</span><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MONTHS_RETAINED</span><span class="o">=</span><span class="m">12</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">YEARS_RETAINED</span><span class="o">=</span><span class="m">5</span>
</span></span></code></pre></div><p>And here&rsquo;s an example excludes file - it&rsquo;s a list of paths to directories and files we don&rsquo;t want to back up - I don&rsquo;t back up my downloads or installers directories since that&rsquo;s all stuff I can re-download later if necessary, and I&rsquo;m better off getting the current version anyway.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/mnt/path-inside-jail/Downloads
</span></span><span class="line"><span class="cl">/mnt/path-inside-jail/Installers/*.dmg
</span></span></code></pre></div><h3 id="test-your-backups">Test your backups<a hidden class="anchor" aria-hidden="true" href="#test-your-backups">#</a></h3>
<p>You&rsquo;ll have to do this from inside the backups jail you created. <code>ssh</code> to your server, then run <code>sudo iocage console YOURJAILNAME</code></p>
<p>I recommend you set <code>BACKUPS_PATH</code> in your settings file to a single small directory to make your testing faster. You can change it to the path to your  full directory tree once you confirm your backups and restores are working as expected.</p>
<h4 id="initialize-your-backup-repository">Initialize your backup repository<a hidden class="anchor" aria-hidden="true" href="#initialize-your-backup-repository">#</a></h4>
<p>Now that you&rsquo;re inside the jail, you&rsquo;re going to have to initialize the repository directory in your B2 bucket. FreeBSD/TrueNAS uses <code>csh</code> as the default root shell, but our settings file is set up for <code>bash</code>, so start by running <code>exec bash</code> to get a decent shell.</p>
<p>Load the configuration file you created by running <code>source /path/to/yoursettingsfile.sh</code>, then run <code>restic init</code>.</p>
<p>You&rsquo;re ready to do a backup.</p>
<h4 id="run-a-backup">Run a backup<a hidden class="anchor" aria-hidden="true" href="#run-a-backup">#</a></h4>
<p>Now that your repository has been initialized, run <code>/path/to/restic-driver /path/to/yoursettingsfile.sh</code></p>
<p>It shouldn&rsquo;t take long if you used a small test subdirectory.</p>
<h4 id="test-a-restore">Test a restore<a hidden class="anchor" aria-hidden="true" href="#test-a-restore">#</a></h4>
<p>First, let&rsquo;s look at the list of snapshots with <code>restic snapshots</code>.</p>
<p>Now we can list the files in the snapshot with either <code>restic ls SNAPSHOTID</code> or <code>restic ls latest</code></p>
<p>Pick a file and restore it.</p>
<ol>
<li>Make a directory to restore to - <code>mkdir ./restores</code></li>
<li>Restore the file. We don&rsquo;t want to restore the entire snapshot, just a specific file/directory, so we&rsquo;ll use <code>--include</code> and run <code>restic restore latest --target ./restores --include /mnt/path/to/file</code></li>
<li>It put the whole directory path for that file inside <code>./restores</code>, so we&rsquo;ll do a simple md5 check with <code>md5sum /path/to/test/file ./restores/path/to/test/file</code></li>
</ol>
<h4 id="run-restic-out-of-cron">Run restic out of cron<a hidden class="anchor" aria-hidden="true" href="#run-restic-out-of-cron">#</a></h4>
<p>Great, you&rsquo;re almost done. All we have to do now is add it to <code>cron</code> so it runs at least once a day. You need to add it to the crontab <em>inside</em> the jail though, or TrueNAS won&rsquo;t find your script.</p>
<p>I stored my <code>restic</code> backup script and configuration in a directory that appears as <code>/mnt/alcatraz</code> inside my backups jail. Change the path to match wherever you stored yours.</p>
<p>Run <code>crontab -e</code> and add the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># minute	hour	mday	month	wday	command</span>
</span></span><span class="line"><span class="cl"><span class="m">13</span> */4 * * * /mnt/alcatraz/restic-driver /mnt/alcatraz/backup-settings.sh <span class="p">|</span> logger -t backups
</span></span></code></pre></div><p>I tagged all the log output with <code>backups</code> to make it easier to <code>grep</code> out of <code>/var/log/messages</code>, and I run mine four times a day. You may prefer a different cadence, if so set the hour field accordingly. <code>restic</code> locks the repository when it starts, so you don&rsquo;t have to worry about repository corruption if you accidentally try to run more than one backup at a time, or one runs so long that it isn&rsquo;t complete before the next run starts.</p>
<p>Update: Jesse Alter wrote a perl version of this script, you can find it on GitHub at <a href="https://github.com/jessealter/restickit">jessealter/restickit</a>.</p>


  </div>
  <div>
    
  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://unixorn.github.io/tags/backups/">Backups</a></li>
      <li><a href="https://unixorn.github.io/tags/duplicacy/">Duplicacy</a></li>
      <li><a href="https://unixorn.github.io/tags/freebsd/">Freebsd</a></li>
      <li><a href="https://unixorn.github.io/tags/homelab/">Homelab</a></li>
      <li><a href="https://unixorn.github.io/tags/restic/">Restic</a></li>
      <li><a href="https://unixorn.github.io/tags/truenas/">Truenas</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://unixorn.github.io/post/ha-mqtt-discoverable-0.8.0/">
    <span class="title">« Prev</span>
    <br>
    <span>Released ha-mqtt-discoverable 0.8.0</span>
  </a>
  <a class="next" href="https://unixorn.github.io/post/fix-congo-backticks/">
    <span class="title">Next »</span>
    <br>
    <span>Fix Congo Backticks</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Restic Backups on TrueNAS on x"
            href="https://x.com/intent/tweet/?text=Restic%20Backups%20on%20TrueNAS&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2frestic-backups-on-truenas%2f&amp;hashtags=backups%2cduplicacy%2cfreebsd%2chomelab%2crestic%2ctruenas">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Restic Backups on TrueNAS on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2frestic-backups-on-truenas%2f&amp;title=Restic%20Backups%20on%20TrueNAS&amp;summary=Restic%20Backups%20on%20TrueNAS&amp;source=https%3a%2f%2funixorn.github.io%2fpost%2frestic-backups-on-truenas%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Restic Backups on TrueNAS on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2funixorn.github.io%2fpost%2frestic-backups-on-truenas%2f&title=Restic%20Backups%20on%20TrueNAS">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Restic Backups on TrueNAS on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2funixorn.github.io%2fpost%2frestic-backups-on-truenas%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Restic Backups on TrueNAS on whatsapp"
            href="https://api.whatsapp.com/send?text=Restic%20Backups%20on%20TrueNAS%20-%20https%3a%2f%2funixorn.github.io%2fpost%2frestic-backups-on-truenas%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Restic Backups on TrueNAS on telegram"
            href="https://telegram.me/share/url?text=Restic%20Backups%20on%20TrueNAS&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2frestic-backups-on-truenas%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Restic Backups on TrueNAS on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Restic%20Backups%20on%20TrueNAS&u=https%3a%2f%2funixorn.github.io%2fpost%2frestic-backups-on-truenas%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>Copyright 2019-2023, Joe Block. All rights reserved.</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <a rel="me" href="https://hachyderm.io/@unixorn">Mastodon</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
