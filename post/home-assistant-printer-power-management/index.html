<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Home Assistant Printer Power Management | unixorn.github.io</title>
<meta name="keywords" content="Raspberry PI, cupsd, hass, home-assistant, homelab, printer, rpi, tech">
<meta name="description" content="I&rsquo;ve got an old HP laser printer in my basement. We barely print 10 pages a month between the two of us, so we only turn it on when we&rsquo;re going to print. That&rsquo;s a hassle though, because inevitably we forget to shut it off sometimes and it stays on overnight or even for days, and while it has a powersave mode, the 4050N is so old that even that burns a good amount of power.
Enter Home Assistant.">
<meta name="author" content="Me">
<link rel="canonical" href="https://unixorn.github.io/post/home-assistant-printer-power-management/">
<meta name="google-site-verification" content="UA-100853138-2">
<link crossorigin="anonymous" href="https://unixorn.github.io/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="https://unixorn.github.io/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Home Assistant Printer Power Management" />
<meta property="og:description" content="I&rsquo;ve got an old HP laser printer in my basement. We barely print 10 pages a month between the two of us, so we only turn it on when we&rsquo;re going to print. That&rsquo;s a hassle though, because inevitably we forget to shut it off sometimes and it stays on overnight or even for days, and while it has a powersave mode, the 4050N is so old that even that burns a good amount of power.
Enter Home Assistant." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://unixorn.github.io/post/home-assistant-printer-power-management/" /><meta property="og:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-02-13T12:08:24-07:00" />
<meta property="article:modified_time" content="2021-02-13T12:08:24-07:00" /><meta property="og:site_name" content="The Plural of SRE is an Outage" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"/>

<meta name="twitter:title" content="Home Assistant Printer Power Management"/>
<meta name="twitter:description" content="I&rsquo;ve got an old HP laser printer in my basement. We barely print 10 pages a month between the two of us, so we only turn it on when we&rsquo;re going to print. That&rsquo;s a hassle though, because inevitably we forget to shut it off sometimes and it stays on overnight or even for days, and while it has a powersave mode, the 4050N is so old that even that burns a good amount of power.
Enter Home Assistant."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://unixorn.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Home Assistant Printer Power Management",
      "item": "https://unixorn.github.io/post/home-assistant-printer-power-management/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Home Assistant Printer Power Management",
  "name": "Home Assistant Printer Power Management",
  "description": "I\u0026rsquo;ve got an old HP laser printer in my basement. We barely print 10 pages a month between the two of us, so we only turn it on when we\u0026rsquo;re going to print. That\u0026rsquo;s a hassle though, because inevitably we forget to shut it off sometimes and it stays on overnight or even for days, and while it has a powersave mode, the 4050N is so old that even that burns a good amount of power.\nEnter Home Assistant.\n",
  "keywords": [
    "Raspberry PI", "cupsd", "hass", "home-assistant", "homelab", "printer", "rpi", "tech"
  ],
  "articleBody": "I’ve got an old HP laser printer in my basement. We barely print 10 pages a month between the two of us, so we only turn it on when we’re going to print. That’s a hassle though, because inevitably we forget to shut it off sometimes and it stays on overnight or even for days, and while it has a powersave mode, the 4050N is so old that even that burns a good amount of power.\nEnter Home Assistant.\nPrerequisites You have HA configured to connect to a MQTT server The watcher script and associated tooling all presume that we can send messages to a MQTT topic that HA is watching.\nYour printer is connected to a cupsd server running in a container Your computers should be configured to print to the cupsd server instead of directly to the printer.\nI run cupsd in a container on one of my Odroids. I could run it on the same Odroid HC2 that I run Home Assistant (HA) on, but there’s no compelling reason to do so and I’m reserving that node for strictly HA containers like Home Assistant itself and my MQTT server. I picked an Odroid because it has a SATA drive attached and my /var/lib/docker is on the hard drive and not an microSD card - there’s no reason you can’t run it on a Raspberry Pi other than to prevent excessive wear on the microSD card.\nYou could modify the watcher script if you’re running cupsd directly instead of in a container, but I run my cupsd in a container, so that’s what the script is designed for.\nThere are plenty of articles about setting up cupsd, but I wrote about setting up cupsd here.\nYour printer is plugged into an outlet controlled by HA We want to be able to toggle the power from Home Assistant.\nPrinter Power Control mosquitto helper script I don’t like to install anything more on my docker hosts than I absolutely have to, so instead of installing mosquitto directly on the printserver machine, I run mosquitto_pub inside a container with the following c-mosquitto_pub helper script. You can download it from github here. Put this in /usr/local/bin.\n#!/usr/bin/env bash # # Use docker to run mosquitto_pub # # Copyright 2019, Joe Block # # Licensed under the Apache License, Version 2.0 (the \"License\"); # you may not use this file except in compliance with the License. # You may obtain a copy of the License at # # http://www.apache.org/licenses/LICENSE-2.0 # # Unless required by applicable law or agreed to in writing, software # distributed under the License is distributed on an \"AS IS\" BASIS, # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. # See the License for the specific language governing permissions and # limitations under the License. exec docker run -t --rm eclipse-mosquitto mosquitto_pub $@ cupsd Watcher Once I had cupsd configured to share the printer (as Franklin), I wrote a quick script that checks the print queue to see if it is empty or not. If there are jobs in the queue, it writes ON to an MQTT topic, hass/printers/franklin. If the queue is empty, it writes OFF. The examples here all assume your printer is named Franklin, replace Franklin with your printer’s name.\nActually, I lied. When there are jobs, it writes OFF and then ON.\nWhy? Because I don’t want HA to switch the printer off immediately once the queue drains - the printer has enough RAM that there may still be several pages left to print when it has accepted all of the job from the server.\nInstead, I’ve configured HA to restart a timer every time it sees the MQTT topic hass/printers/franklin switch from OFF to ON, and only turn the printer off after the queue has been empty for five continuous minutes.\nHere’s the ha-check-for-print-jobs script source - you can download it from github here.\nPut the script in /usr/local/bin on the same server you’re running the cupsd container on - it is designed to run a tool inside that container.\n#!/usr/bin/env bash # # ha-check-for-print-jobs # # Check if there are print jobs on $PRINT_Q. If there are, write # MQTT messages to a watched topic so HA knows to turn on the power # to the printer. # # Copyright 2021, Joe Block # # License: Apache 2 set -o pipefail # Make all these overridable easily in your cron setup PRINT_Q=${PRINT_Q:-'Franklin'} CONTAINER=${CONTAINER:-'cupsd-server'} MQTT_HOST=${MQTT_HOST:-'mqtt.example.com'} MQTT_TOPIC=${MQTT_TOPIC:-'hass/printers/franklin'} # We are run out of cron every minute, but I don't want it to take an # entire minute to turn on the power because I'm impatient and the printer # takes a bit to start up. When we print and walk downstairs, I want it # to have already started printing by the time I get there. If I was # patient, I wouldn't have bothered to write this tool :-) # # So, when we get run by cron, we check the queue CHECK_COUNT times, with # CHECK_DELAY seconds between each run. CHECK_COUNT=${CHECK_COUNT:-'11'} CHECK_DELAY=${CHECK_DELAY:-'5'} export PATH=\"$PATH:/usr/local/bin:/usr/local/sbin\" if [[ -f /tmp/printerdebug ]]; then DEBUG='true' fi # Only spam syslog when DEBUG is set debugout() { if [[ -n \"$DEBUG\" ]]; then echo \"$@\" fi } validate-settings(){ debugout \"CONTAINER: $CONTAINER\" debugout \"PRINT_Q: $PRINT_Q\" debugout \"MQTT_HOST: $MQTT_HOST\" debugout \"MQTT_TOPIC: $MQTT_TOPIC\" valid='true' if [[ -z \"$CONTAINER\" ]]; then echo \"CONTAINER is unset\" valid='false' fi if [[ -z \"$PRINT_Q\" ]]; then echo \"PRINT_Q is unset\" valid='false' fi if [[ -z \"$MQTT_HOST\" ]]; then echo \"MQTT_HOST is unset\" valid='false' fi if [[ -z \"$MQTT_TOPIC\" ]]; then echo \"MQTT_TOPIC is unset\" valid='false' fi if [[ \"$valid\" == \"false\" ]]; then echo \"Configure your settings.\" exit 1 fi } print-job-checker() { printjobs=$(docker exec -t \"$CONTAINER\" lpq -P \"$PRINT_Q\" | grep -c 'no entries') if [[ \"$printjobs\" == '1' ]]; then debugout \"No jobs in print queue, notifying HA\" c-mosquitto_pub -h \"$MQTT_HOST\" -t \"$MQTT_TOPIC\" -m OFF else echo \"jobs found in print queue, notifying HA\" docker exec -t \"$CONTAINER\" lpq -P \"$PRINT_Q\" # Set the status off, then back to on, so that the HA timer restarts # and HA doesn't turn off the printer in the middle of a job c-mosquitto_pub -h \"$MQTT_HOST\" -t \"$MQTT_TOPIC\" -m OFF c-mosquitto_pub -h \"$MQTT_HOST\" -t \"$MQTT_TOPIC\" -m ON debugout \"re-enabling printer $PRINT_Q...\" docker exec -t \"$CONTAINER\" lpadmin -p \"$PRINT_Q\" -o printer-error-policy=retry-current-job fi } validate-settings # We run the print-job-checker every 5 seconds to minimize the UI delay on the # macOs end for i in $(seq $CHECK_COUNT) do print-job-checker debugout \"waiting...\" sleep $CHECK_DELAY done Home Assistant Setup I configured my HA to watch a MQTT topic as a binary sensor. You can download this snippet here.\nbinary_sensor: - platform: mqtt name: \"Franklin Print Queue\" payload_on: \"ON\" state_topic: \"hass/printers/franklin\" Now, when the watcher writes ON and OFF to the hass/printers/franklin queue, that binary sensor will change status and we can trigger an automation for it.\nThis automation will turn the printer power on every time the binary sensor is turned on, and turn it off five minutes after the last time the binary sensor switched from ON to OFF.\nThe outlet my printer is plugged into is controlled by HA and rather unimaginatively named switch.printerpower.\nAdd this stanza to your automations.yaml file. Download it here.\n# Franklin power is controlled by MQTT - alias: 'Turn on Franklin when there are jobs in the queue' trigger: platform: state entity_id: binary_sensor.franklin_print_queue to: 'on' action: service: homeassistant.turn_on entity_id: switch.printerpower - alias: 'Turn off printer 5 minutes after print queue drains' trigger: platform: state entity_id: binary_sensor.franklin_print_queue to: 'off' for: minutes: 5 action: service: homeassistant.turn_off entity_id: switch.printerpower Test the pieces Print server check Confirm that you’ve got the print queue configured correctly by running docker exec -it cupsd-server lpq -P Franklin. If there are no jobs, it should print something like\nFranklin is ready no entries Automation test Reload your automations, and you should now be able to test that the automations are correct by running c-mosquitto_pub -h mqtt.yourdomain.com -t hass/printers/franklin -m OFF or -m ON and watch HA turn the power to your printer off and on.\nOnce that is working, print a job, and if you run ha-check-for-print-jobs the printer power should get turned on.\nRun it all automatically Now that you’ve confirmed that the power is being cycled properly when the MQTT queue recieves messages and that the print job checker is seeing the printer queue, we can add the checker job to cron.\nAdd\n* * * * * PRINT_Q=Franklin MQTT_HOST=mqtt.example.com MQTT_TOPIC=hass/printers/franklin CONTAINER=cupsd_server /usr/local/bin/ha-check-for-print-jobs | logger -t printserver to your /etc/crontab, and you’re good to go. Now every minute, the checker script will get run by cron, and it will check every five seconds for print jobs and exit before the next invocation by cron.\n",
  "wordCount" : "1461",
  "inLanguage": "en",
  "datePublished": "2021-02-13T12:08:24-07:00",
  "dateModified": "2021-02-13T12:08:24-07:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://unixorn.github.io/post/home-assistant-printer-power-management/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "unixorn.github.io",
    "logo": {
      "@type": "ImageObject",
      "url": "https://unixorn.github.io/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://unixorn.github.io/" accesskey="h" title="Home (Alt + H)">
                <img src="https://unixorn.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://unixorn.github.io/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/projects/" title="projects">
                    <span>projects</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://hachyderm.io/@unixorn" title="hachyderm.io/@unixorn">
                    <span>hachyderm.io/@unixorn</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">
<link rel="stylesheet" type="text/css" href="https://unixorn.github.io/css/mastodon.css" />
<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://unixorn.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://unixorn.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      Home Assistant Printer Power Management
    </h1>
    <div class="post-meta"><span title='2021-02-13 12:08:24 -0700 MST'>February 13, 2021</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1461 words&nbsp;·&nbsp;Me

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisites">Prerequisites</a>
      <ul>
        <li><a href="#you-have-ha-configured-to-connect-to-a-mqtt-server">You have HA configured to connect to a MQTT server</a></li>
        <li><a href="#your-printer-is-connected-to-a-cupsd-server-running-in-a-container">Your printer is connected to a cupsd server running in a container</a></li>
        <li><a href="#your-printer-is-plugged-into-an-outlet-controlled-by-ha">Your printer is plugged into an outlet controlled by HA</a></li>
      </ul>
    </li>
    <li><a href="#printer-power-control">Printer Power Control</a>
      <ul>
        <li><a href="#mosquitto-helper-script">mosquitto helper script</a></li>
        <li><a href="#cupsd-watcher">cupsd Watcher</a></li>
        <li><a href="#home-assistant-setup">Home Assistant Setup</a></li>
        <li><a href="#test-the-pieces">Test the pieces</a></li>
        <li><a href="#run-it-all-automatically">Run it all automatically</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>I&rsquo;ve got an old HP laser printer in my basement. We barely print 10 pages a month between the two of us, so we only turn it on when we&rsquo;re going to print. That&rsquo;s a hassle though, because inevitably we forget to shut it off sometimes and it stays on overnight or even for days, and while it has a powersave mode, the 4050N is so old that even that burns a good amount of power.</p>
<p>Enter Home Assistant.</p>
<h2 id="prerequisites">Prerequisites<a hidden class="anchor" aria-hidden="true" href="#prerequisites">#</a></h2>
<h3 id="you-have-ha-configured-to-connect-to-a-mqtt-server">You have HA configured to connect to a MQTT server<a hidden class="anchor" aria-hidden="true" href="#you-have-ha-configured-to-connect-to-a-mqtt-server">#</a></h3>
<p>The watcher script and associated tooling all presume that we can send messages to a MQTT topic that HA is watching.</p>
<h3 id="your-printer-is-connected-to-a-cupsd-server-running-in-a-container">Your printer is connected to a cupsd server running in a container<a hidden class="anchor" aria-hidden="true" href="#your-printer-is-connected-to-a-cupsd-server-running-in-a-container">#</a></h3>
<p>Your computers should be configured to print to the cupsd server instead of directly to the printer.</p>
<p>I run <code>cupsd</code> in a container on one of my Odroids. I could run it on the same Odroid HC2 that I run Home Assistant (HA) on, but there&rsquo;s no compelling reason to do so and I&rsquo;m reserving that node for strictly HA containers like Home Assistant itself and my MQTT server. I picked an Odroid because it has a SATA drive attached and my <code>/var/lib/docker</code> is on the hard drive and not an microSD card - there&rsquo;s no reason you can&rsquo;t run it on a Raspberry Pi other than to prevent excessive wear on the microSD card.</p>
<p>You could modify the watcher script if you&rsquo;re running <code>cupsd</code> directly instead of in a container, but I run my <code>cupsd</code> in a container, so that&rsquo;s what the script is designed for.</p>
<p>There are plenty of articles about setting up <code>cupsd</code>, but I wrote about setting up <code>cupsd</code> <a href="https://unixorn.github.io/post/cupsd-setup/">here</a>.</p>
<h3 id="your-printer-is-plugged-into-an-outlet-controlled-by-ha">Your printer is plugged into an outlet controlled by HA<a hidden class="anchor" aria-hidden="true" href="#your-printer-is-plugged-into-an-outlet-controlled-by-ha">#</a></h3>
<p>We want to be able to toggle the power from Home Assistant.</p>
<h2 id="printer-power-control">Printer Power Control<a hidden class="anchor" aria-hidden="true" href="#printer-power-control">#</a></h2>
<h3 id="mosquitto-helper-script">mosquitto helper script<a hidden class="anchor" aria-hidden="true" href="#mosquitto-helper-script">#</a></h3>
<p>I don&rsquo;t like to install anything more on my docker hosts than I absolutely have to, so instead of installing mosquitto directly on the printserver machine, I run <code>mosquitto_pub</code> inside a container with the following <code>c-mosquitto_pub</code> helper script. You can download it from github <a href="https://github.com/unixorn/blog-scripts/blob/master/cupsd-hass/c-mosquitto_pub">here</a>. Put this in <code>/usr/local/bin</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/env bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Use docker to run mosquitto_pub</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Copyright 2019, Joe Block &lt;jpb@unixorn.net&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class="line"><span class="cl"><span class="c1"># you may not use this file except in compliance with the License.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You may obtain a copy of the License at</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class="line"><span class="cl"><span class="c1"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># See the License for the specific language governing permissions and</span>
</span></span><span class="line"><span class="cl"><span class="c1"># limitations under the License.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> docker run -t --rm eclipse-mosquitto mosquitto_pub <span class="nv">$@</span>
</span></span></code></pre></div><h3 id="cupsd-watcher">cupsd Watcher<a hidden class="anchor" aria-hidden="true" href="#cupsd-watcher">#</a></h3>
<p>Once I had cupsd configured to share the printer (as Franklin), I wrote a quick script that checks the print queue to see if it is empty or not. If there are jobs in the queue, it writes <strong>ON</strong> to an MQTT topic, <code>hass/printers/franklin</code>. If the queue is empty, it writes <strong>OFF</strong>. The examples here all assume your printer is named Franklin, replace Franklin with your printer&rsquo;s name.</p>
<p>Actually, I lied. When there are jobs, it writes <strong>OFF</strong> and <em>then</em> <strong>ON</strong>.</p>
<p>Why? Because I don&rsquo;t want HA to switch the printer off immediately once the queue drains - the printer has enough RAM that there may still be several pages left to print when it has accepted all of the job from the server.</p>
<p>Instead, I&rsquo;ve configured HA to restart a timer every time it sees the MQTT topic <code>hass/printers/franklin</code> switch from <strong>OFF</strong> to <strong>ON</strong>, and only turn the printer off after the queue has been empty for five continuous minutes.</p>
<p>Here&rsquo;s the <code>ha-check-for-print-jobs</code> script source - you can download it from github <a href="https://github.com/unixorn/blog-scripts/blob/master/cupsd-hass/ha-check-for-print-jobs">here</a>.</p>
<p>Put the script in <code>/usr/local/bin</code> on the same server you&rsquo;re running the cupsd container on - it is designed to run a tool inside that container.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/env bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ha-check-for-print-jobs</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Check if there are print jobs on $PRINT_Q. If there are, write</span>
</span></span><span class="line"><span class="cl"><span class="c1"># MQTT messages to a watched topic so HA knows to turn on the power</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to the printer.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Copyright 2021, Joe Block &lt;jpb@unixorn.net&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># License: Apache 2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Make all these overridable easily in your cron setup</span>
</span></span><span class="line"><span class="cl"><span class="nv">PRINT_Q</span><span class="o">=</span><span class="si">${</span><span class="nv">PRINT_Q</span><span class="k">:-</span><span class="s1">&#39;Franklin&#39;</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">CONTAINER</span><span class="o">=</span><span class="si">${</span><span class="nv">CONTAINER</span><span class="k">:-</span><span class="s1">&#39;cupsd-server&#39;</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">MQTT_HOST</span><span class="o">=</span><span class="si">${</span><span class="nv">MQTT_HOST</span><span class="k">:-</span><span class="s1">&#39;mqtt.example.com&#39;</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">MQTT_TOPIC</span><span class="o">=</span><span class="si">${</span><span class="nv">MQTT_TOPIC</span><span class="k">:-</span><span class="s1">&#39;hass/printers/franklin&#39;</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We are run out of cron every minute, but I don&#39;t want it to take an</span>
</span></span><span class="line"><span class="cl"><span class="c1"># entire minute to turn on the power because I&#39;m impatient and the printer</span>
</span></span><span class="line"><span class="cl"><span class="c1"># takes a bit to start up. When we print and walk downstairs, I want it</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to have already started printing by the time I get there. If I was</span>
</span></span><span class="line"><span class="cl"><span class="c1"># patient, I wouldn&#39;t have bothered to write this tool :-)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, when we get run by cron, we check the queue CHECK_COUNT times, with</span>
</span></span><span class="line"><span class="cl"><span class="c1"># CHECK_DELAY seconds between each run.</span>
</span></span><span class="line"><span class="cl"><span class="nv">CHECK_COUNT</span><span class="o">=</span><span class="si">${</span><span class="nv">CHECK_COUNT</span><span class="k">:-</span><span class="s1">&#39;11&#39;</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">CHECK_DELAY</span><span class="o">=</span><span class="si">${</span><span class="nv">CHECK_DELAY</span><span class="k">:-</span><span class="s1">&#39;5&#39;</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$PATH</span><span class="s2">:/usr/local/bin:/usr/local/sbin&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> -f /tmp/printerdebug <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nv">DEBUG</span><span class="o">=</span><span class="s1">&#39;true&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Only spam syslog when DEBUG is set</span>
</span></span><span class="line"><span class="cl">debugout<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$DEBUG</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">validate-settings<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  debugout <span class="s2">&#34;CONTAINER: </span><span class="nv">$CONTAINER</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debugout <span class="s2">&#34;PRINT_Q: </span><span class="nv">$PRINT_Q</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debugout <span class="s2">&#34;MQTT_HOST: </span><span class="nv">$MQTT_HOST</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  debugout <span class="s2">&#34;MQTT_TOPIC: </span><span class="nv">$MQTT_TOPIC</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">valid</span><span class="o">=</span><span class="s1">&#39;true&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$CONTAINER</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;CONTAINER is unset&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">valid</span><span class="o">=</span><span class="s1">&#39;false&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$PRINT_Q</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;PRINT_Q is unset&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">valid</span><span class="o">=</span><span class="s1">&#39;false&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$MQTT_HOST</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;MQTT_HOST is unset&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">valid</span><span class="o">=</span><span class="s1">&#39;false&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$MQTT_TOPIC</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;MQTT_TOPIC is unset&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">valid</span><span class="o">=</span><span class="s1">&#39;false&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$valid</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;false&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Configure your settings.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">print-job-checker<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">printjobs</span><span class="o">=</span><span class="k">$(</span>docker <span class="nb">exec</span> -t <span class="s2">&#34;</span><span class="nv">$CONTAINER</span><span class="s2">&#34;</span> lpq -P <span class="s2">&#34;</span><span class="nv">$PRINT_Q</span><span class="s2">&#34;</span> <span class="p">|</span> grep -c <span class="s1">&#39;no entries&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$printjobs</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    debugout <span class="s2">&#34;No jobs in print queue, notifying HA&#34;</span>
</span></span><span class="line"><span class="cl">    c-mosquitto_pub -h <span class="s2">&#34;</span><span class="nv">$MQTT_HOST</span><span class="s2">&#34;</span> -t <span class="s2">&#34;</span><span class="nv">$MQTT_TOPIC</span><span class="s2">&#34;</span> -m OFF
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;jobs found in print queue, notifying HA&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    docker <span class="nb">exec</span> -t <span class="s2">&#34;</span><span class="nv">$CONTAINER</span><span class="s2">&#34;</span> lpq -P <span class="s2">&#34;</span><span class="nv">$PRINT_Q</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set the status off, then back to on, so that the HA timer restarts</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># and HA doesn&#39;t turn off the printer in the middle of a job</span>
</span></span><span class="line"><span class="cl">    c-mosquitto_pub -h <span class="s2">&#34;</span><span class="nv">$MQTT_HOST</span><span class="s2">&#34;</span> -t <span class="s2">&#34;</span><span class="nv">$MQTT_TOPIC</span><span class="s2">&#34;</span> -m OFF
</span></span><span class="line"><span class="cl">    c-mosquitto_pub -h <span class="s2">&#34;</span><span class="nv">$MQTT_HOST</span><span class="s2">&#34;</span> -t <span class="s2">&#34;</span><span class="nv">$MQTT_TOPIC</span><span class="s2">&#34;</span> -m ON
</span></span><span class="line"><span class="cl">    debugout <span class="s2">&#34;re-enabling printer </span><span class="nv">$PRINT_Q</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">    docker <span class="nb">exec</span> -t <span class="s2">&#34;</span><span class="nv">$CONTAINER</span><span class="s2">&#34;</span> lpadmin -p <span class="s2">&#34;</span><span class="nv">$PRINT_Q</span><span class="s2">&#34;</span> -o printer-error-policy<span class="o">=</span>retry-current-job
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">validate-settings
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We run the print-job-checker every 5 seconds to minimize the UI delay on the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># macOs end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="k">$(</span>seq <span class="nv">$CHECK_COUNT</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">  print-job-checker
</span></span><span class="line"><span class="cl">  debugout <span class="s2">&#34;waiting...&#34;</span>
</span></span><span class="line"><span class="cl">  sleep <span class="nv">$CHECK_DELAY</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><h3 id="home-assistant-setup">Home Assistant Setup<a hidden class="anchor" aria-hidden="true" href="#home-assistant-setup">#</a></h3>
<p>I configured my HA to watch a MQTT topic as a binary sensor. You can download this snippet <a href="https://github.com/unixorn/blog-scripts/blob/master/cupsd-hass/printer-binary-sensor.yaml">here</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">binary_sensor</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l">mqtt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Franklin Print Queue&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">payload_on</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ON&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state_topic</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;hass/printers/franklin&#34;</span><span class="w">
</span></span></span></code></pre></div><p>Now, when the watcher writes <strong>ON</strong> and <strong>OFF</strong> to the <code>hass/printers/franklin</code> queue, that binary sensor will change status and we can trigger an automation for it.</p>
<p>This automation will turn the printer power on every time the binary sensor is turned on, and turn it off five minutes after the last time the binary sensor switched from <strong>ON</strong> to <strong>OFF</strong>.</p>
<p>The outlet my printer is plugged into is controlled by HA and rather unimaginatively named <code>switch.printerpower</code>.</p>
<p>Add this stanza to your automations.yaml file. Download it <a href="https://github.com/unixorn/blog-scripts/blob/master/cupsd-hass/printer-automations.yaml">here</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Franklin power is controlled by MQTT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Turn on Franklin when there are jobs in the queue&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l">state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l">binary_sensor.franklin_print_queue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;on&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l">homeassistant.turn_on</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l">switch.printerpower</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Turn off printer 5 minutes after print queue drains&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l">state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l">binary_sensor.franklin_print_queue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">for</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">minutes</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l">homeassistant.turn_off</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">entity_id</span><span class="p">:</span><span class="w"> </span><span class="l">switch.printerpower</span><span class="w">
</span></span></span></code></pre></div><h3 id="test-the-pieces">Test the pieces<a hidden class="anchor" aria-hidden="true" href="#test-the-pieces">#</a></h3>
<h4 id="print-server-check">Print server check<a hidden class="anchor" aria-hidden="true" href="#print-server-check">#</a></h4>
<p>Confirm that you&rsquo;ve got the print queue configured correctly by running <code>docker exec -it cupsd-server lpq -P Franklin</code>. If there are no jobs, it should print something like</p>
<pre tabindex="0"><code>Franklin is ready
no entries
</code></pre><h4 id="automation-test">Automation test<a hidden class="anchor" aria-hidden="true" href="#automation-test">#</a></h4>
<p>Reload your automations, and you should now be able to test that the automations are correct by running <code>c-mosquitto_pub -h mqtt.yourdomain.com -t hass/printers/franklin -m OFF</code> or <code>-m ON</code> and watch HA turn the power to your printer off and on.</p>
<p>Once that is working, print a job, and if you run <code>ha-check-for-print-jobs</code> the printer power should get turned on.</p>
<h3 id="run-it-all-automatically">Run it all automatically<a hidden class="anchor" aria-hidden="true" href="#run-it-all-automatically">#</a></h3>
<p>Now that you&rsquo;ve confirmed that the power is being cycled properly when the MQTT queue recieves messages and that the print job checker is seeing the printer queue, we can add the checker job to cron.</p>
<p>Add</p>
<pre tabindex="0"><code>* * * * * PRINT_Q=Franklin MQTT_HOST=mqtt.example.com MQTT_TOPIC=hass/printers/franklin CONTAINER=cupsd_server /usr/local/bin/ha-check-for-print-jobs | logger -t printserver
</code></pre><p>to your <code>/etc/crontab</code>, and you&rsquo;re good to go. Now every minute, the checker script will get run by <code>cron</code>, and it will check every five seconds for print jobs and exit before the next invocation by <code>cron</code>.</p>

  </div>
  <div>
    
  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://unixorn.github.io/tags/raspberry-pi/">Raspberry PI</a></li>
      <li><a href="https://unixorn.github.io/tags/cupsd/">cupsd</a></li>
      <li><a href="https://unixorn.github.io/tags/hass/">hass</a></li>
      <li><a href="https://unixorn.github.io/tags/home-assistant/">home-assistant</a></li>
      <li><a href="https://unixorn.github.io/tags/homelab/">homelab</a></li>
      <li><a href="https://unixorn.github.io/tags/printer/">printer</a></li>
      <li><a href="https://unixorn.github.io/tags/rpi/">rpi</a></li>
      <li><a href="https://unixorn.github.io/tags/tech/">tech</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://unixorn.github.io/post/setting-up-shinobi-and-a-wyze-g2-camera/">
    <span class="title">« Prev</span>
    <br>
    <span>Setting up Shinobi and a Wyze G2 Camera</span>
  </a>
  <a class="next" href="https://unixorn.github.io/post/cupsd-setup/">
    <span class="title">Next »</span>
    <br>
    <span>Run a CUPSD print server on Raspberry Pi</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Home Assistant Printer Power Management on twitter"
        href="https://twitter.com/intent/tweet/?text=Home%20Assistant%20Printer%20Power%20Management&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhome-assistant-printer-power-management%2f&amp;hashtags=RaspberryPI%2ccupsd%2chass%2chome-assistant%2chomelab%2cprinter%2crpi%2ctech">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Home Assistant Printer Power Management on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhome-assistant-printer-power-management%2f&amp;title=Home%20Assistant%20Printer%20Power%20Management&amp;summary=Home%20Assistant%20Printer%20Power%20Management&amp;source=https%3a%2f%2funixorn.github.io%2fpost%2fhome-assistant-printer-power-management%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Home Assistant Printer Power Management on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2funixorn.github.io%2fpost%2fhome-assistant-printer-power-management%2f&title=Home%20Assistant%20Printer%20Power%20Management">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Home Assistant Printer Power Management on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2funixorn.github.io%2fpost%2fhome-assistant-printer-power-management%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Home Assistant Printer Power Management on whatsapp"
        href="https://api.whatsapp.com/send?text=Home%20Assistant%20Printer%20Power%20Management%20-%20https%3a%2f%2funixorn.github.io%2fpost%2fhome-assistant-printer-power-management%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Home Assistant Printer Power Management on telegram"
        href="https://telegram.me/share/url?text=Home%20Assistant%20Printer%20Power%20Management&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhome-assistant-printer-power-management%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>Copyright 2019-2023, Joe Block. All rights reserved.</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <a rel="me" href="https://hachyderm.io/@unixorn">Mastodon</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
