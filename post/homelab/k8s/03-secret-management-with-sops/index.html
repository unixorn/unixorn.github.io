<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Secret Management with SOPS | unixorn.github.io</title>
<meta name="keywords" content="age, cert-manager, gpg, homelab, k8s, kubernetes, letsencrypt, macos, r53, sops, ssl, talos">
<meta name="description" content="This is part 3 of my Kubernetes homelab cluster setup series - Secrets Management with SOPS.

Part 1 - Setting up Talos with a Cilium CNI on proxmox
Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53
Part 3 - Secret Management with SOPS
Part 4 - Back up your Talos etcd cluster to a SMB share

The cluster is up, but it isn&rsquo;t very usable yet. Before we and any services, we need to set up secrets management.">
<meta name="author" content="Me">
<link rel="canonical" href="https://unixorn.github.io/post/homelab/k8s/03-secret-management-with-sops/">
<meta name="google-site-verification" content="UA-100853138-2">
<link crossorigin="anonymous" href="https://unixorn.github.io/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css" integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF&#43;13Dyqob6ASlTrTye8=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://unixorn.github.io/post/homelab/k8s/03-secret-management-with-sops/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://unixorn.github.io/post/homelab/k8s/03-secret-management-with-sops/">
  <meta property="og:site_name" content="unixorn.github.io">
  <meta property="og:title" content="Secret Management with SOPS">
  <meta property="og:description" content="This is part 3 of my Kubernetes homelab cluster setup series - Secrets Management with SOPS.
Part 1 - Setting up Talos with a Cilium CNI on proxmox Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53 Part 3 - Secret Management with SOPS Part 4 - Back up your Talos etcd cluster to a SMB share The cluster is up, but it isn’t very usable yet. Before we and any services, we need to set up secrets management.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2026-01-19T14:19:03-07:00">
    <meta property="article:modified_time" content="2026-01-19T14:19:03-07:00">
    <meta property="article:tag" content="Age">
    <meta property="article:tag" content="Cert-Manager">
    <meta property="article:tag" content="Gpg">
    <meta property="article:tag" content="Homelab">
    <meta property="article:tag" content="K8s">
    <meta property="article:tag" content="Kubernetes">
      <meta property="og:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:title" content="Secret Management with SOPS">
<meta name="twitter:description" content="This is part 3 of my Kubernetes homelab cluster setup series - Secrets Management with SOPS.

Part 1 - Setting up Talos with a Cilium CNI on proxmox
Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53
Part 3 - Secret Management with SOPS
Part 4 - Back up your Talos etcd cluster to a SMB share

The cluster is up, but it isn&rsquo;t very usable yet. Before we and any services, we need to set up secrets management.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://unixorn.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Secret Management with SOPS",
      "item": "https://unixorn.github.io/post/homelab/k8s/03-secret-management-with-sops/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Secret Management with SOPS",
  "name": "Secret Management with SOPS",
  "description": "This is part 3 of my Kubernetes homelab cluster setup series - Secrets Management with SOPS.\nPart 1 - Setting up Talos with a Cilium CNI on proxmox Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53 Part 3 - Secret Management with SOPS Part 4 - Back up your Talos etcd cluster to a SMB share The cluster is up, but it isn\u0026rsquo;t very usable yet. Before we and any services, we need to set up secrets management.\n",
  "keywords": [
    "age", "cert-manager", "gpg", "homelab", "k8s", "kubernetes", "letsencrypt", "macos", "r53", "sops", "ssl", "talos"
  ],
  "articleBody": "This is part 3 of my Kubernetes homelab cluster setup series - Secrets Management with SOPS.\nPart 1 - Setting up Talos with a Cilium CNI on proxmox Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53 Part 3 - Secret Management with SOPS Part 4 - Back up your Talos etcd cluster to a SMB share The cluster is up, but it isn’t very usable yet. Before we and any services, we need to set up secrets management.\nIn this post, we’re going to add secret management to the cluster with sops and age so we can safely check our configuration into git.\nPrerequisites A working kubernetes cluster. I’m using Talos for mine, but regular kubernetes or k3s clusters will work too. If you need to set up a new cluster, or configure an existing one to use Cilum, read part one of this series. cilium, kubectl \u0026 helm - if you don’t want to brew install them, install instructions are at cilium.io, helm.sh and kubectl. sops and age. On a Mac, you can run brew install sops age. If you’re using Linux or Windows, use the age installation instructions and sops installation instructions. Goal I have my cluster configuration in git so that it’s easy to recreate if I break something while experimenting. I don’t want to commit secrets into git in cleartext though. Instead, I want to encrypt our secrets in a way that the cluster can decrypt them, but they’re safe to check into source control.\nTo do this, we’re going to use sops to encrypt the sensitive parts of our manifest files.\nWhy sops and not something else? Sops supports encrypting individual keys in yaml, json, env and ini files. It will let you encrypt with many of the cloud services like AWS KMS or GCP KMS (and others, check the site), but since we’re doing this in a home lab, we’re going to use age. It also supports using GPG, but age is what the sops maintainers recommend, and it’s a lot more user friendly than GPG.\nSoftware Versions Here are the versions of the software I used while writing this post. Later versions should work, but this is what these instructions were tested with.\nSoftware Version age 1.3.1. helm 4.0.1 kubectl 1.34 kubernetes 1.34.1 sops 3.11.0 talos 1.11.5 Set up age First, generate a key pair Create a key pair with age-keygen\n$ age-keygen # created: 2026-01-18T18:12:39-07:00 # public key: age1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890A AGE-SECRET-KEY-1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890A $ It does not create any files. It’s up to you to store both the secret and private key. Don’t commit the secret key or there’s no point in encrypting.\nmacOS On my Mac, I store the secret key in the system keychain, using keychainctl from my tumult macOS cli helper script collection.\nUse keychainctl to add the private key with\nkeychainctl set cluster-age-secret-key password data for new item: Paste in your secret key.\nsops allows you to specify a command to run to retrieve the secret key - it will run it and read the key from the command’s stdout.\nWe can use keychainctl to retrieve the private key when decrypting a file with sops so we don’t have to store the file on disk unencrypted by adding SOPS_AGE_KEY_CMD to our environment\nexport SOPS_AGE_KEY_CMD=keychainctl get cluster-age-secret-key Linux sops will automatically look in $HOME/.config/sops/age/keys.txt (or $XDG_CONFIG_HOME/sops/age/keys.txt if set) for the age secret key. If you want to use an alternate location, set SOPS_AGE_KEY_FILE in your environment. This unfortunately leaves your key decrypted on the filesystem.\nIf you’re using a password manager, I recommend storing the secret key in that and setting SOPS_AGE_KEY_CMD as shown in the macOS section above.\nYou can also store the age private key in the SOPS_AGE_KEY environment variable.\nSet up sops Now that you have an age key pair, let’s configure sops to use it.\nCreate .sops.yaml sops stores its configuration in .sops.yaml. At the top level of your git checkout, .sops.yaml with these contents:\n# .sops.yaml creation_rules: - path_regex: /*?.yaml encrypted_regex: \"^(id|password|password_file|app-password|web-password|secret|secretboxencryptionsecret|bootstraptoken|secretboxencryption|token|ca|crt|key|access-key-id|secret-access-key|hostedZoneID|email|data|stringdata|api-token|encryption-token|encryption-key)$\" age: age1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890A This file sets keys to control sops’ behavior. Key Description path_regex Let sops know what files it should examine for encryptable keys encrypted_regex A golang regex that tells sops which keys in our files need encryption age The public key to use for encrypting the secrets Add the sops operator to your cluster We’re going to add the sops operator to the cluster. This will handle automatically decrypting keys in manifests so you don’t have to decrypt them before running kubectl apply -f\nAdd the age private key to the cluster Put the private key in cluster-age-private.key, then\nkubectl create secret generic sops-age-key-file \\ --from-file=key=cluster-age-private.key \\ --namespace sops Add an operator configuration Create a values file we can use with helm\n--- # sops-values.yaml secretsAsFiles: - mountPath: /etc/sops-age-key-file name: sops-age-key-file secretName: sops-age-key-file extraEnv: - name: SOPS_AGE_KEY_FILE value: /etc/sops-age-key-file/key Install the sops operator Now that we have created a secret containing the age private key and a values file to configure the operator, we can install it with helm.\nhelm repo add sops https://isindir.github.io/sops-secrets-operator \u0026\u0026 \\ helm update \u0026\u0026 \\ helm upgrade --install sops sops/sops-secrets-operator \\ --namespace sops --create-namespace \\ -f sops-values.yaml Usage examples Now that the operator is in place, here are some usage examples. Note - never edit the files after sops has encrypted them. Not even the unencrypted keys - sops calculates a checksum of the entire file and your edits will make the validation fail.\nInstead, run sops decrypt -i something.yaml, edit it, then sops encrypt -i something.yaml.\nEncrypting keys in place Here’s an example ClusterIssuer manifest I use to configure cert-manager to use LetsEncrypt and Route 53 DNS challenges.\n# example.yaml apiVersion: cert-manager.io/v1 kind: ClusterIssuer metadata: name: letsencrypt-dns-r53 spec: acme: # Use the production server for real certificates; switch to the staging URL while testing. server: https://acme-v02.api.letsencrypt.org/directory # staging: https://acme-staging-v02.api.letsencrypt.org/directory email: user@example.com privateKeySecretRef: name: letsencrypt-dns-r53-account-key solvers: - dns01: route53: # Region where your hosted zone lives region: us-east-1 hostedZoneID: Z1234567890AB accessKeyIDSecretRef: name: route53-aws-secret key: access-key-id secretAccessKeySecretRef: name: route53-aws-secret key: secret-access-key I have my cluster configuration on GitHub, but I don’t want my hostedZoneID visible to people trying to use my manifests as an example. I also want to make sure that if they copy the file to use to start their configuration for their own cluster they don’t accidentally use my email.\nThe .sops.yaml example I gave is configured to encrypt email and hostedZoneID keys, so let’s encrypt this with sops encrypt -i example.yaml. We’re using -i so that sops encrypts the file in place, otherwise you’d have to run something like sops encrypt example.yaml \u003e example.encrypted.yaml.\nThe resulting file will look something like this:\n# example.yaml apiVersion: cert-manager.io/v1 kind: ClusterIssuer metadata: name: letsencrypt-dns-r53 spec: acme: # Use the production server for real certificates; switch to the staging URL while testing. server: https://acme-v02.api.letsencrypt.org/directory # staging: https://acme-staging-v02.api.letsencrypt.org/directory email: ENC[AES256_GCM,data:Ds7Zyk8e7DNCFcqrIHUvgA==,iv:h3MatsiOfK7IEG/kPY1QexGfOGtq/npxPovrFz4arDs=,tag:VOSyK4loBzk7+XfhpIUczg==,type:str] privateKeySecretRef: name: letsencrypt-dns-r53-account-key solvers: - dns01: route53: # Region where your hosted zone lives region: us-east-1 hostedZoneID: ENC[AES256_GCM,data:H52qvjdhqf2zmgyK2A==,iv:zI+N6nH17lch9H756+hABpRc28A/E82wxvaoaLB4RRw=,tag:AATtcJLJlggJjWheIpoiSQ==,type:str] accessKeyIDSecretRef: name: route53-aws-secret key: ENC[AES256_GCM,data:RzULmAT9/ZvgO2fLqw==,iv:Afyhbn8z9n+1Nf1LxsttGbmbncUDoNLJPHZY21LN1zk=,tag:0sH9ZX41xgW7nvE4kJM1VA==,type:str] secretAccessKeySecretRef: name: route53-aws-secret key: ENC[AES256_GCM,data:dyXBYf0R1XUUWejHH2uQyso=,iv:hKxW7otsTkF5f5/kXbAa0Yw0WPxa13NrN8N1Lo/Nbfo=,tag:21FyiXBxd1Bor9SARXaW7g==,type:str] sops: age: - recipient: age1t2fr4u6yvfja69s59rwt70rwa7vhu06sen0m6lxygsyn2dpgzc4s0ma7wy enc: | -----BEGIN AGE ENCRYPTED FILE----- YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBUUWNoZzFMUmdQQTI0RE8w VC8vQzQyV3VTdEhtTkdNS3dwcENKM3hkcjBFCnhLN2xDUVUvQWlLRTV5ZkRyd0lX YUZsWEZseGlrY0hOZUI1Zm1xYnZMWE0KLS0tIGVBdE0vVkdFUEJYcUZwRm1Icy9h OWd4TUZKL2NIOXI5SjRITmhHSkZaZTQKn6+S5b8rfGADzTGNazfiH+Li/se/2as3 g6LFWUkDMLq6CCRJoybbGFl/K/HdT+Eni3WMAL0ZYWIn5gh3qD2LRQ== -----END AGE ENCRYPTED FILE----- lastmodified: \"2026-01-19T19:58:51Z\" mac: ENC[AES256_GCM,data:dSgG36sbNaAqo1TyCEqWBVveniUNKHpsBT5A0A5wto6A+ohA6OmX3w/soGn0T4NU+5dIs8s0gJWZpR67rtwKu9+Wtf1dELw27NGpZu8Jak6zPZwqt0iktkOE7JYdtmyRR3VP3ykkkKOxEd4KoRhLdLkPPC3VrScwzbSX4K0AJVA=,iv:xzNZNTM0rYEf8Btexggmtum6H/iI6iexcIQYSG36zwk=,tag:G1pzGu+6RoC2WyhRfovUMA==,type:str] encrypted_regex: ^(id|password|password_file|app-password|web-password|secret|secretboxencryptionsecret|bootstraptoken|secretboxencryption|token|ca|crt|key|access-key-id|secret-access-key|hostedZoneID|email|data|stringdata|api-token|encryption-token|encryption-key)$ version: 3.11.0 Note that it’s added a sops section to the file, the confidential keys are encrypted, but the non-sensitive keys were left alone so the file is still readable by humans, it’s just had the secrets redacted.\nCreating k8s secrets with sops What if we want to create actual k8s secrets? Ones with key names that aren’t found by .sops.yaml’s encrypted_regex?\nThe sops operator creates a SopsSecret resource. If you create secretTemplates resources in a SopsSecret, the operator will create those keys when you apply the manifest, update them when you apply changes, and delete all secrets created by the SopsSecret when it is deleted.\nHere’s an example\n# sample-secret.raw.yaml apiVersion: isindir.github.com/v1alpha3 kind: SopsSecret metadata: name: foo-sopssecret namespace: blog spec: secretTemplates: - name: foo-secret stringData: username: myUsername password: 'Pa$$word' - name: some-token stringData: token: 8675309thx1138 After running sops encrypt -i sample-secret.raw.yaml\n# sample-secret.raw.yaml apiVersion: isindir.github.com/v1alpha3 kind: SopsSecret metadata: name: foo-sopssecret namespace: blog spec: secretTemplates: - name: foo-secret stringData: username: myUsername password: ENC[AES256_GCM,data:gz3TVX4rEB8=,iv:ifDsVjQmYbwAHy073rP8uI2NNu073WqOnw/JZ+e6TqI=,tag:tgb0RkiZe6Xlhx4UOItIgg==,type:str] - name: some-token stringData: token: ENC[AES256_GCM,data:paithquCOGuWL0zG/Q4=,iv:7P+yp62d9e4wLb8JUCFwYcO14swntguAr8wwO6z22fc=,tag:VOkL/leu5zT20Ufj5GGskQ==,type:str] sops: age: - recipient: age1t2fr4u6yvfja69s59rwt70rwa7vhu06sen0m6lxygsyn2dpgzc4s0ma7wy enc: | -----BEGIN AGE ENCRYPTED FILE----- YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBJdWNPYmQyTEtvTkZ0OHk3 N2tHNS9sRU5PTml3OFUxUGR2aW9CbXdZMTB3ClhXWi9LbHlDYi82bEliVkNDY3R0 eCs1VUFSZm45Y0ZwaVZ3SzhYWjZ4NmMKLS0tIHF1RGZSY21SZWtkSXZsUG5MQjV4 TlNsZGR3WnVCZ05WWEQzN2tIMjhEQzQKXznPaFWnV8/qx1XGbSio/0XAa5/1SrrI EXm2by6UikdkSyngKk1sgvycM4z+JuvkKoxahH89RYe8ZX+9it4u1w== -----END AGE ENCRYPTED FILE----- lastmodified: \"2026-01-19T20:11:54Z\" mac: ENC[AES256_GCM,data:yo4wpmN9JXvE0DLjhG87me2470ezpQ1rFt9++yD06HnItyWQQhPRCkF0o8Z5J6JyJ++lM8pZLuzYjqJMy//Gt0neMFI1yPf7NzH3JzlO9fy8qpdFpQ0iyYdzTURNZ1qgZ9+dfeji5bqwHiLYY/GffcJvLPQoJUzD1+FHIWz4hXo=,iv:dmbQ/QKpWg6CXm/3cXNwlg71536SAKCl9CCE0R/I4xM=,tag:p3twWZya0nU/jQ5XSfsolg==,type:str] encrypted_regex: ^(id|password|password_file|app-password|web-password|secret|secretboxencryptionsecret|bootstraptoken|secretboxencryption|token|ca|crt|key|access-key-id|secret-access-key|hostedZoneID|email|data|stringdata|api-token|encryption-token|encryption-key)$ version: 3.11.0 Now I can run\n$ kubectl apply -f sample-secret.raw.yaml sopssecret.isindir.github.com/foo-sopssecret created $ and the operator will decrypt the keys and create the secrets, so when I run\n$ kubectl get secret -n blog foo-secret Opaque 2 11s some-token Opaque 1 11s $ I see the two secrets defined in the SopsSecret resource. And when I delete the SopsSecret, we can see that it deletes the regular kubernetes secrets defined by it.\n$ kubectl delete -n blog sopssecrets.isindir.github.com foo-sopssecret sopssecret.isindir.github.com \"foo-sopssecret\" deleted $ kubectl get secret -n blog No resources found in blog namespace. $ You should now be able to create secrets and encrypt individual yaml keys for your cluster using SOPS.\nGotchas I can’t decrypt a file I encrypted with sops There are two common reasons this can happen\nYou edited the file after you encrypted it. If you opened the encrypted file and saved it, your editor may have trimmed trailing whitespace from lines, which broke the checksumming. You should have SOPS_AGE_KEY, SOPS_AGE_KEY_FILE or SOPS_AGE_KEY_CMD defined in your environment Kubectl apply failed Confirm that you created the sops-age-key-file secret, and that it’s in the same namespace you installed sops.\nkubectl get secret -A | grep sops sops sh.helm.release.v1.sops.v1 helm.sh/release.v1 1 1d sops sops-age-key-file Opaque 1 1d ",
  "wordCount" : "1608",
  "inLanguage": "en",
  "image": "https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished": "2026-01-19T14:19:03-07:00",
  "dateModified": "2026-01-19T14:19:03-07:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://unixorn.github.io/post/homelab/k8s/03-secret-management-with-sops/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "unixorn.github.io",
    "logo": {
      "@type": "ImageObject",
      "url": "https://unixorn.github.io/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://unixorn.github.io/" accesskey="h" title="Home (Alt + H)">
                <img src="https://unixorn.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://unixorn.github.io/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/projects/" title="projects">
                    <span>projects</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://hachyderm.io/@unixorn" title="hachyderm.io/@unixorn">
                    <span>hachyderm.io/@unixorn</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">
<link rel="stylesheet" type="text/css" href="https://unixorn.github.io/css/mastodon.css" />
<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://unixorn.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://unixorn.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      Secret Management with SOPS
    </h1>
    <div class="post-meta"><span title='2026-01-19 14:19:03 -0700 MST'>January 19, 2026</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1608 words&nbsp;·&nbsp;Me

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#goal">Goal</a></li>
    <li><a href="#software-versions">Software Versions</a></li>
    <li><a href="#set-up-age">Set up <code>age</code></a>
      <ul>
        <li><a href="#first-generate-a-key-pair">First, generate a key pair</a></li>
      </ul>
    </li>
    <li><a href="#set-up-sops">Set up <code>sops</code></a>
      <ul>
        <li><a href="#create-sopsyaml">Create <code>.sops.yaml</code></a></li>
      </ul>
    </li>
    <li><a href="#add-the-sops-operator-to-your-cluster">Add the sops operator to your cluster</a>
      <ul>
        <li><a href="#add-the-age-private-key-to-the-cluster">Add the <code>age</code> private key to the cluster</a></li>
        <li><a href="#add-an-operator-configuration">Add an operator configuration</a></li>
        <li><a href="#install-the-sops-operator">Install the sops operator</a></li>
      </ul>
    </li>
    <li><a href="#usage-examples">Usage examples</a>
      <ul>
        <li><a href="#encrypting-keys-in-place">Encrypting keys in place</a></li>
        <li><a href="#creating-k8s-secrets-with-sops">Creating k8s secrets with <code>sops</code></a></li>
      </ul>
    </li>
    <li></li>
    <li><a href="#gotchas">Gotchas</a>
      <ul>
        <li><a href="#i-cant-decrypt-a-file-i-encrypted-with-sops">I can&rsquo;t decrypt a file I encrypted with sops</a></li>
        <li><a href="#kubectl-apply-failed">Kubectl apply failed</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>This is part 3 of my Kubernetes homelab cluster setup series - Secrets Management with <a href="https://github.com/getsops/sops">SOPS</a>.</p>
<ul>
<li><a href="../01-talos-with-cilium-cni-on-proxmox/">Part 1 - Setting up Talos with a Cilium CNI on proxmox</a></li>
<li><a href="../02-k8s-cilium-r53-and-cert-manager/">Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53</a></li>
<li>Part 3 - Secret Management with SOPS</li>
<li><a href="../04-backup-talos-etcd-to-smb/">Part 4 - Back up your Talos etcd cluster to a SMB share</a></li>
</ul>
<p>The cluster is up, but it isn&rsquo;t very usable yet. Before we and any services, we need to set up secrets management.</p>
<p>In this post, we&rsquo;re going to add secret management to the cluster with <a href="https://github.com/getsops/sops">sops</a> and <a href="https://age-encryption.org">age</a> so we can safely check our configuration into <code>git</code>.</p>
<h2 id="prerequisites">Prerequisites<a hidden class="anchor" aria-hidden="true" href="#prerequisites">#</a></h2>
<ul>
<li>A working kubernetes cluster. I&rsquo;m using <a href="https://www.talos.dev/">Talos</a> for mine, but regular <a href="https://kubernetes.io">kubernetes</a> or <a href="https://k3s.io">k3s</a> clusters will work too. If you need to set up a new cluster, or configure an existing one to use Cilum, read <a href="(../01-talos-with-cilium-cni-on-proxmox/)">part one</a> of this series.</li>
<li><code>cilium</code>, <code>kubectl</code> &amp; <code>helm</code> - if you don&rsquo;t want to <code>brew install</code> them, install instructions are at <a href="https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#install-the-cilium-cli">cilium.io</a>, <a href="https://helm.sh">helm.sh</a> and <a href="https://kubernetes.io/docs/tasks/tools/">kubectl</a>.</li>
<li><code>sops</code> and <code>age</code>. On a Mac, you can run <code>brew install sops age</code>. If you&rsquo;re using Linux or Windows, use the <a href="https://github.com/FiloSottile/age#installation">age installation instructions</a> and <a href="https://github.com/getsops/sops?tab=readme-ov-file#1download">sops installation instructions</a>.</li>
</ul>
<h2 id="goal">Goal<a hidden class="anchor" aria-hidden="true" href="#goal">#</a></h2>
<p>I have my cluster configuration in <code>git</code> so that it&rsquo;s easy to recreate if I break something while experimenting. I don&rsquo;t want to commit secrets into <code>git</code> in cleartext though. Instead, I want to encrypt our secrets in a way that the cluster can decrypt them, but they&rsquo;re safe to check into source control.</p>
<p>To do this, we&rsquo;re going to use <a href="https://github.com/getsops/sops">sops</a> to encrypt the sensitive parts of our manifest files.</p>
<p>Why sops and not something else? Sops supports encrypting individual keys in yaml, json, env and ini files. It will let you encrypt with many of the cloud services like AWS KMS or GCP KMS (and others, check the site), but since we&rsquo;re doing this in a home lab, we&rsquo;re going to use <a href="https://age-encryption.org/">age</a>. It also supports using GPG, but <code>age</code> is what the <code>sops</code> maintainers recommend, and it&rsquo;s a lot more user friendly than GPG.</p>
<h2 id="software-versions">Software Versions<a hidden class="anchor" aria-hidden="true" href="#software-versions">#</a></h2>
<p>Here are the versions of the software I used while writing this post. Later versions should work, but this is what these instructions were tested with.</p>
<table>
  <thead>
      <tr>
          <th>Software</th>
          <th>Version</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>age</code></td>
          <td>1.3.1.</td>
      </tr>
      <tr>
          <td><code>helm</code></td>
          <td>4.0.1</td>
      </tr>
      <tr>
          <td><code>kubectl</code></td>
          <td>1.34</td>
      </tr>
      <tr>
          <td><code>kubernetes</code></td>
          <td>1.34.1</td>
      </tr>
      <tr>
          <td><code>sops</code></td>
          <td>3.11.0</td>
      </tr>
      <tr>
          <td><code>talos</code></td>
          <td>1.11.5</td>
      </tr>
  </tbody>
</table>
<h2 id="set-up-age">Set up <code>age</code><a hidden class="anchor" aria-hidden="true" href="#set-up-age">#</a></h2>
<h3 id="first-generate-a-key-pair">First, generate a key pair<a hidden class="anchor" aria-hidden="true" href="#first-generate-a-key-pair">#</a></h3>
<p>Create a key pair with <code>age-keygen</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ age-keygen
</span></span><span class="line"><span class="cl"><span class="c1"># created: 2026-01-18T18:12:39-07:00</span>
</span></span><span class="line"><span class="cl"><span class="c1"># public key: age1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890A</span>
</span></span><span class="line"><span class="cl">AGE-SECRET-KEY-1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890A
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></div><p>It does <em>not</em> create any files. It&rsquo;s up to you to store both the secret and private key. Don&rsquo;t commit the secret key or there&rsquo;s no point in encrypting.</p>
<h4 id="macos">macOS<a hidden class="anchor" aria-hidden="true" href="#macos">#</a></h4>
<p>On my Mac, I store the secret key in the system keychain, using <a href="https://github.com/unixorn/tumult.plugin.zsh/blob/main/bin/keychainctl">keychainctl</a> from my <a href="https://github.com/unixorn/tumult.plugin.zsh">tumult</a> macOS cli helper script collection.</p>
<p>Use <code>keychainctl</code> to add the private key with</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">keychainctl <span class="nb">set</span> cluster-age-secret-key
</span></span><span class="line"><span class="cl">password data <span class="k">for</span> new item:
</span></span></code></pre></div><p>Paste in your secret key.</p>
<p><code>sops</code> allows you to specify a command to run to retrieve the secret key - it will run it and read the key from the command&rsquo;s stdout.</p>
<p>We can use <code>keychainctl</code> to retrieve the private key when decrypting a file with <code>sops</code> so we don&rsquo;t have to store the file on disk unencrypted by adding <code>SOPS_AGE_KEY_CMD</code> to our environment</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">SOPS_AGE_KEY_CMD</span><span class="o">=</span>keychainctl get cluster-age-secret-key
</span></span></code></pre></div><h4 id="linux">Linux<a hidden class="anchor" aria-hidden="true" href="#linux">#</a></h4>
<p><code>sops</code> will automatically look in <code>$HOME/.config/sops/age/keys.txt</code> (or <code>$XDG_CONFIG_HOME/sops/age/keys.txt</code> if set) for the age secret key. If you want to use an alternate location, set <code>SOPS_AGE_KEY_FILE</code> in your environment. This unfortunately leaves your key decrypted on the filesystem.</p>
<p>If you&rsquo;re using a password manager, I recommend storing the secret key in that and setting <code>SOPS_AGE_KEY_CMD</code> as shown in the macOS section above.</p>
<p>You can also store the <code>age</code> private key in the <code>SOPS_AGE_KEY</code> environment variable.</p>
<h2 id="set-up-sops">Set up <code>sops</code><a hidden class="anchor" aria-hidden="true" href="#set-up-sops">#</a></h2>
<p>Now that you have an <code>age</code> key pair, let&rsquo;s configure <code>sops</code> to use it.</p>
<h3 id="create-sopsyaml">Create <code>.sops.yaml</code><a hidden class="anchor" aria-hidden="true" href="#create-sopsyaml">#</a></h3>
<p><code>sops</code> stores its configuration in <code>.sops.yaml</code>. At the top level of your git checkout, <code>.sops.yaml</code> with these contents:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># .sops.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">creation_rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">path_regex</span><span class="p">:</span><span class="w"> </span><span class="l">/*?.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">encrypted_regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^(id|password|password_file|app-password|web-password|secret|secretboxencryptionsecret|bootstraptoken|secretboxencryption|token|ca|crt|key|access-key-id|secret-access-key|hostedZoneID|email|data|stringdata|api-token|encryption-token|encryption-key)$&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">age</span><span class="p">:</span><span class="w"> </span><span class="l">age1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890A</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>This file sets keys to control <code>sops</code>&rsquo; behavior.</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Key</strong></td>
          <td><strong>Description</strong></td>
      </tr>
      <tr>
          <td><code>path_regex</code></td>
          <td>Let sops know what files it should examine for encryptable keys</td>
      </tr>
      <tr>
          <td><code>encrypted_regex</code></td>
          <td>A golang regex that tells sops which keys in our files need encryption</td>
      </tr>
      <tr>
          <td><code>age</code></td>
          <td>The public key to use for encrypting the secrets</td>
      </tr>
  </tbody>
</table>
<h2 id="add-the-sops-operator-to-your-cluster">Add the sops operator to your cluster<a hidden class="anchor" aria-hidden="true" href="#add-the-sops-operator-to-your-cluster">#</a></h2>
<p>We&rsquo;re going to add the sops operator to the cluster. This will handle automatically decrypting keys in manifests so you don&rsquo;t have to decrypt them before running <code>kubectl apply -f</code></p>
<h3 id="add-the-age-private-key-to-the-cluster">Add the <code>age</code> private key to the cluster<a hidden class="anchor" aria-hidden="true" href="#add-the-age-private-key-to-the-cluster">#</a></h3>
<p>Put the private key in <code>cluster-age-private.key</code>, then</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create secret generic sops-age-key-file <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --from-file<span class="o">=</span><span class="nv">key</span><span class="o">=</span>cluster-age-private.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --namespace sops
</span></span></code></pre></div><h3 id="add-an-operator-configuration">Add an operator configuration<a hidden class="anchor" aria-hidden="true" href="#add-an-operator-configuration">#</a></h3>
<p>Create a values file we can use with <code>helm</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># sops-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">secretsAsFiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/sops-age-key-file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sops-age-key-file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">sops-age-key-file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">extraEnv</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">SOPS_AGE_KEY_FILE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/sops-age-key-file/key</span><span class="w">
</span></span></span></code></pre></div><h3 id="install-the-sops-operator">Install the sops operator<a hidden class="anchor" aria-hidden="true" href="#install-the-sops-operator">#</a></h3>
<p>Now that we have created a secret containing the <code>age</code> private key and a values file to configure the operator, we can install it with <code>helm</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">helm repo add sops https://isindir.github.io/sops-secrets-operator <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  helm update <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  helm upgrade --install sops sops/sops-secrets-operator <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      --namespace sops --create-namespace <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      -f sops-values.yaml
</span></span></code></pre></div><h2 id="usage-examples">Usage examples<a hidden class="anchor" aria-hidden="true" href="#usage-examples">#</a></h2>
<p>Now that the operator is in place, here are some usage examples. Note - <em>never</em> edit the files after <code>sops</code> has encrypted them. Not even the unencrypted keys - <code>sops</code> calculates a checksum of the entire file and your edits will make the validation fail.</p>
<p>Instead, run <code>sops decrypt -i something.yaml</code>, edit it, then <code>sops encrypt -i something.yaml</code>.</p>
<h3 id="encrypting-keys-in-place">Encrypting keys in place<a hidden class="anchor" aria-hidden="true" href="#encrypting-keys-in-place">#</a></h3>
<p>Here&rsquo;s an example <code>ClusterIssuer</code> manifest I use to configure <code>cert-manager</code> to use LetsEncrypt and Route 53 DNS challenges.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># example.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-dns-r53</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># Use the production server for real certificates; switch to the staging URL while testing.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># staging: https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">user@example.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-dns-r53-account-key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">dns01</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">route53</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c"># Region where your hosted zone lives</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">us-east-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">hostedZoneID</span><span class="p">:</span><span class="w"> </span><span class="l">Z1234567890AB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">accessKeyIDSecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">route53-aws-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">access-key-id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">secretAccessKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">route53-aws-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">secret-access-key</span><span class="w">
</span></span></span></code></pre></div><p>I have my cluster configuration on GitHub, but I don&rsquo;t want my <code>hostedZoneID</code> visible to people trying to use my manifests as an example. I also want to make sure that if they copy the file to use to start their configuration for their own cluster they don&rsquo;t accidentally use my email.</p>
<p>The <code>.sops.yaml</code> example I gave is configured to encrypt email and <code>hostedZoneID</code> keys, so let&rsquo;s encrypt this with <code>sops encrypt -i example.yaml</code>. We&rsquo;re using <code>-i</code> so that <code>sops</code> encrypts the file in place, otherwise you&rsquo;d have to run something like <code>sops encrypt example.yaml &gt; example.encrypted.yaml</code>.</p>
<p>The resulting file will look something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># example.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-dns-r53</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># Use the production server for real certificates; switch to the staging URL while testing.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># staging: https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">ENC[AES256_GCM,data:Ds7Zyk8e7DNCFcqrIHUvgA==,iv:h3MatsiOfK7IEG/kPY1QexGfOGtq/npxPovrFz4arDs=,tag:VOSyK4loBzk7+XfhpIUczg==,type:str]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-dns-r53-account-key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">dns01</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">route53</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c"># Region where your hosted zone lives</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">us-east-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">hostedZoneID</span><span class="p">:</span><span class="w"> </span><span class="l">ENC[AES256_GCM,data:H52qvjdhqf2zmgyK2A==,iv:zI+N6nH17lch9H756+hABpRc28A/E82wxvaoaLB4RRw=,tag:AATtcJLJlggJjWheIpoiSQ==,type:str]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">accessKeyIDSecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">route53-aws-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">ENC[AES256_GCM,data:RzULmAT9/ZvgO2fLqw==,iv:Afyhbn8z9n+1Nf1LxsttGbmbncUDoNLJPHZY21LN1zk=,tag:0sH9ZX41xgW7nvE4kJM1VA==,type:str]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">secretAccessKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">route53-aws-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">ENC[AES256_GCM,data:dyXBYf0R1XUUWejHH2uQyso=,iv:hKxW7otsTkF5f5/kXbAa0Yw0WPxa13NrN8N1Lo/Nbfo=,tag:21FyiXBxd1Bor9SARXaW7g==,type:str]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">sops</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">age</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">recipient</span><span class="p">:</span><span class="w"> </span><span class="l">age1t2fr4u6yvfja69s59rwt70rwa7vhu06sen0m6lxygsyn2dpgzc4s0ma7wy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enc</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            -----BEGIN AGE ENCRYPTED FILE-----
</span></span></span><span class="line"><span class="cl"><span class="sd">            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBUUWNoZzFMUmdQQTI0RE8w
</span></span></span><span class="line"><span class="cl"><span class="sd">            VC8vQzQyV3VTdEhtTkdNS3dwcENKM3hkcjBFCnhLN2xDUVUvQWlLRTV5ZkRyd0lX
</span></span></span><span class="line"><span class="cl"><span class="sd">            YUZsWEZseGlrY0hOZUI1Zm1xYnZMWE0KLS0tIGVBdE0vVkdFUEJYcUZwRm1Icy9h
</span></span></span><span class="line"><span class="cl"><span class="sd">            OWd4TUZKL2NIOXI5SjRITmhHSkZaZTQKn6+S5b8rfGADzTGNazfiH+Li/se/2as3
</span></span></span><span class="line"><span class="cl"><span class="sd">            g6LFWUkDMLq6CCRJoybbGFl/K/HdT+Eni3WMAL0ZYWIn5gh3qD2LRQ==
</span></span></span><span class="line"><span class="cl"><span class="sd">            -----END AGE ENCRYPTED FILE-----</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lastmodified</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2026-01-19T19:58:51Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mac</span><span class="p">:</span><span class="w"> </span><span class="l">ENC[AES256_GCM,data:dSgG36sbNaAqo1TyCEqWBVveniUNKHpsBT5A0A5wto6A+ohA6OmX3w/soGn0T4NU+5dIs8s0gJWZpR67rtwKu9+Wtf1dELw27NGpZu8Jak6zPZwqt0iktkOE7JYdtmyRR3VP3ykkkKOxEd4KoRhLdLkPPC3VrScwzbSX4K0AJVA=,iv:xzNZNTM0rYEf8Btexggmtum6H/iI6iexcIQYSG36zwk=,tag:G1pzGu+6RoC2WyhRfovUMA==,type:str]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">encrypted_regex</span><span class="p">:</span><span class="w"> </span><span class="l">^(id|password|password_file|app-password|web-password|secret|secretboxencryptionsecret|bootstraptoken|secretboxencryption|token|ca|crt|key|access-key-id|secret-access-key|hostedZoneID|email|data|stringdata|api-token|encryption-token|encryption-key)$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">3.11.0</span><span class="w">
</span></span></span></code></pre></div><p>Note that it&rsquo;s added a <code>sops</code> section to the file, the confidential keys are encrypted, but the non-sensitive keys were left alone so the file is still readable by humans, it&rsquo;s just had the secrets redacted.</p>
<h3 id="creating-k8s-secrets-with-sops">Creating k8s secrets with <code>sops</code><a hidden class="anchor" aria-hidden="true" href="#creating-k8s-secrets-with-sops">#</a></h3>
<p>What if we want to create actual k8s secrets? Ones with key names that aren&rsquo;t found by <code>.sops.yaml</code>&rsquo;s <code>encrypted_regex</code>?</p>
<p>The sops operator creates a <code>SopsSecret</code> resource. If you create <code>secretTemplates</code> resources in a <code>SopsSecret</code>, the operator will create those keys when you apply the manifest, update them when you apply changes, and delete all secrets created by the <code>SopsSecret</code> when it is deleted.</p>
<p>Here&rsquo;s an example</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># sample-secret.raw.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">isindir.github.com/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">SopsSecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo-sopssecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">blog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secretTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">myUsername</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Pa$$word&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">some-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">8675309thx1138</span><span class="w">
</span></span></span></code></pre></div><p>After running <code>sops encrypt -i sample-secret.raw.yaml</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># sample-secret.raw.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">isindir.github.com/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">SopsSecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo-sopssecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">blog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">myUsername</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">ENC[AES256_GCM,data:gz3TVX4rEB8=,iv:ifDsVjQmYbwAHy073rP8uI2NNu073WqOnw/JZ+e6TqI=,tag:tgb0RkiZe6Xlhx4UOItIgg==,type:str]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">some-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">ENC[AES256_GCM,data:paithquCOGuWL0zG/Q4=,iv:7P+yp62d9e4wLb8JUCFwYcO14swntguAr8wwO6z22fc=,tag:VOkL/leu5zT20Ufj5GGskQ==,type:str]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">sops</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">age</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">recipient</span><span class="p">:</span><span class="w"> </span><span class="l">age1t2fr4u6yvfja69s59rwt70rwa7vhu06sen0m6lxygsyn2dpgzc4s0ma7wy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enc</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            -----BEGIN AGE ENCRYPTED FILE-----
</span></span></span><span class="line"><span class="cl"><span class="sd">            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBJdWNPYmQyTEtvTkZ0OHk3
</span></span></span><span class="line"><span class="cl"><span class="sd">            N2tHNS9sRU5PTml3OFUxUGR2aW9CbXdZMTB3ClhXWi9LbHlDYi82bEliVkNDY3R0
</span></span></span><span class="line"><span class="cl"><span class="sd">            eCs1VUFSZm45Y0ZwaVZ3SzhYWjZ4NmMKLS0tIHF1RGZSY21SZWtkSXZsUG5MQjV4
</span></span></span><span class="line"><span class="cl"><span class="sd">            TlNsZGR3WnVCZ05WWEQzN2tIMjhEQzQKXznPaFWnV8/qx1XGbSio/0XAa5/1SrrI
</span></span></span><span class="line"><span class="cl"><span class="sd">            EXm2by6UikdkSyngKk1sgvycM4z+JuvkKoxahH89RYe8ZX+9it4u1w==
</span></span></span><span class="line"><span class="cl"><span class="sd">            -----END AGE ENCRYPTED FILE-----</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lastmodified</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2026-01-19T20:11:54Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mac</span><span class="p">:</span><span class="w"> </span><span class="l">ENC[AES256_GCM,data:yo4wpmN9JXvE0DLjhG87me2470ezpQ1rFt9++yD06HnItyWQQhPRCkF0o8Z5J6JyJ++lM8pZLuzYjqJMy//Gt0neMFI1yPf7NzH3JzlO9fy8qpdFpQ0iyYdzTURNZ1qgZ9+dfeji5bqwHiLYY/GffcJvLPQoJUzD1+FHIWz4hXo=,iv:dmbQ/QKpWg6CXm/3cXNwlg71536SAKCl9CCE0R/I4xM=,tag:p3twWZya0nU/jQ5XSfsolg==,type:str]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">encrypted_regex</span><span class="p">:</span><span class="w"> </span><span class="l">^(id|password|password_file|app-password|web-password|secret|secretboxencryptionsecret|bootstraptoken|secretboxencryption|token|ca|crt|key|access-key-id|secret-access-key|hostedZoneID|email|data|stringdata|api-token|encryption-token|encryption-key)$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">3.11.0</span><span class="w">
</span></span></span></code></pre></div><p>Now I can run</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f sample-secret.raw.yaml
</span></span><span class="line"><span class="cl">sopssecret.isindir.github.com/foo-sopssecret created
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></div><p>and the operator will decrypt the keys and create the secrets, so when I run</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get secret -n blog
</span></span><span class="line"><span class="cl">foo-secret   Opaque   <span class="m">2</span>      11s
</span></span><span class="line"><span class="cl">some-token   Opaque   <span class="m">1</span>      11s
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></div><p>I see the two secrets defined in the <code>SopsSecret</code> resource. And when I delete the SopsSecret, we can see that it deletes the regular kubernetes secrets defined by it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl delete -n blog sopssecrets.isindir.github.com foo-sopssecret
</span></span><span class="line"><span class="cl">sopssecret.isindir.github.com <span class="s2">&#34;foo-sopssecret&#34;</span> deleted
</span></span><span class="line"><span class="cl">$ kubectl get secret -n blog
</span></span><span class="line"><span class="cl">No resources found in blog namespace.
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></div><h2></h2>
<p>You should now be able to create secrets and encrypt individual yaml keys for your cluster using SOPS.</p>
<h2 id="gotchas">Gotchas<a hidden class="anchor" aria-hidden="true" href="#gotchas">#</a></h2>
<h3 id="i-cant-decrypt-a-file-i-encrypted-with-sops">I can&rsquo;t decrypt a file I encrypted with sops<a hidden class="anchor" aria-hidden="true" href="#i-cant-decrypt-a-file-i-encrypted-with-sops">#</a></h3>
<p>There are two common reasons this can happen</p>
<ol>
<li>You edited the file after you encrypted it. If you opened the encrypted file and saved it, your editor may have trimmed trailing whitespace from lines, which broke the checksumming.</li>
<li>You should have <code>SOPS_AGE_KEY</code>, <code>SOPS_AGE_KEY_FILE</code> or <code>SOPS_AGE_KEY_CMD</code> defined in your environment</li>
</ol>
<h3 id="kubectl-apply-failed">Kubectl apply failed<a hidden class="anchor" aria-hidden="true" href="#kubectl-apply-failed">#</a></h3>
<p>Confirm that you created the <code>sops-age-key-file</code> secret, and that it&rsquo;s in the same namespace you installed <code>sops</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get secret -A <span class="p">|</span> grep sops
</span></span><span class="line"><span class="cl">sops             sh.helm.release.v1.sops.v1                helm.sh/release.v1              <span class="m">1</span>      1d
</span></span><span class="line"><span class="cl">sops             sops-age-key-file                         Opaque                          <span class="m">1</span>      1d
</span></span></code></pre></div>

  </div>
  <div>
    
<div class="article-content">
  <h2>Comments</h2>
  <p>You can use your Mastodon account to reply to this<a class="button" href="https://hachyderm.io/@unixorn/115923870650028223">post</a></p>
  <p><button class="button" id="replyButton" href="https://hachyderm.io/@unixorn/115923870650028223">Reply</button></p>
  <dialog id="toot-reply" class="mastodon" data-component="dialog">
    <h3>Reply to unixorn's post</h3>
    <p>
      With an account on the Fediverse or Mastodon, you can respond to this post.
      Since Mastodon is decentralized, you can use your existing account hosted by another Mastodon server or compatible platform if you don't have an account on this one.
    </p>
    <p>Copy and paste this URL into the search field of your favourite Fediverse app or the web interface of your Mastodon server.</p>
    <div class="copypaste">
      <input type="text" readonly="" value="https://hachyderm.io/@unixorn/115923870650028223">
      <button class="button" id="copyButton">Copy</button>
      <button class="button" id="cancelButton">Close</button>
    </div>
  </dialog>
  <p id="mastodon-comments-list"><button id="load-comment" class="button">Load comments</button></p>
  <noscript><p>You need JavaScript to view the comments.</p></noscript>
  <script src="https://unixorn.github.io/assets/js/purify.min.js"></script>
  <script type="text/javascript">
    const dialog = document.querySelector('dialog');

    document.getElementById('replyButton').addEventListener('click', () => {
      dialog.showModal();
    });

    document.getElementById('copyButton').addEventListener('click', () => {
      navigator.clipboard.writeText('https://hachyderm.io/@unixorn/115923870650028223');
    });

    document.getElementById('cancelButton').addEventListener('click', () => {
      dialog.close();
    });

    dialog.addEventListener('keydown', e => {
      if (e.key === 'Escape') dialog.close();
    });

    const dateOptions = {
      year: "numeric",
      month: "numeric",
      day: "numeric",
      hour: "numeric",
      minute: "numeric",
    };

    function escapeHtml(unsafe) {
      return unsafe
           .replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#039;");
   }

    document.getElementById("load-comment").addEventListener("click", function() {
      document.getElementById("load-comment").innerHTML = "Loading";
      fetch('https://hachyderm.io/api/v1/statuses/115923870650028223/context')
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          if(data['descendants'] &&
             Array.isArray(data['descendants']) &&
            data['descendants'].length > 0) {
              document.getElementById('mastodon-comments-list').innerHTML = "";
              data['descendants'].forEach(function(reply) {
                reply.account.display_name = escapeHtml(reply.account.display_name);
                reply.account.reply_class = reply.in_reply_to_id == "115923870650028223" ? "reply-original" : "reply-child";
                reply.account.emojis.forEach(emoji => {
                  reply.account.display_name = reply.account.display_name.replace(`:${emoji.shortcode}:`,
                    `<img src="${escapeHtml(emoji.static_url)}" alt="Emoji ${emoji.shortcode}" height="20" width="20" />`);
                });
                mastodonComment =
                  `<div class="mastodon-wrapper">
                    <div class="comment-level ${reply.account.reply_class}"><svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="none" transform="rotate(180)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path stroke="#535358" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.608 12.526l7.04-6.454C13.931 4.896 16 5.806 16 7.546V11c13 0 11 16 11 16s-4-10-11-10v3.453c0 1.74-2.069 2.65-3.351 1.475l-7.04-6.454a2 2 0 010-2.948z"></path> </g></svg></div>
                    <div class="mastodon-comment">
                     <div class="avatar">
                       <img src="${escapeHtml(reply.account.avatar_static)}" height=60 width=60 alt="">
                     </div>
                     <div class="content">
                       <div class="author">
                         <a href="${reply.account.url}" rel="nofollow">
                           <span>${reply.account.display_name}</span>
                           <span class="disabled">${escapeHtml(reply.account.acct)}</span>
                         </a>
                         <a class="date" href="${reply.uri}" rel="nofollow">
                           ${reply.created_at.substr(0, 10)}
                         </a>
                       </div>
                       <div class="mastodon-comment-content">${reply.content}</div>
                     </div>
                   </div>
                  </div>`;
                document.getElementById('mastodon-comments-list').appendChild(DOMPurify.sanitize(mastodonComment, {'RETURN_DOM_FRAGMENT': true}));
              });
          } else {
            document.getElementById('mastodon-comments-list').innerHTML = "<p>No comments found</p>";
          }
        });
      });
  </script>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://unixorn.github.io/tags/age/">Age</a></li>
      <li><a href="https://unixorn.github.io/tags/cert-manager/">Cert-Manager</a></li>
      <li><a href="https://unixorn.github.io/tags/gpg/">Gpg</a></li>
      <li><a href="https://unixorn.github.io/tags/homelab/">Homelab</a></li>
      <li><a href="https://unixorn.github.io/tags/k8s/">K8s</a></li>
      <li><a href="https://unixorn.github.io/tags/kubernetes/">Kubernetes</a></li>
      <li><a href="https://unixorn.github.io/tags/letsencrypt/">Letsencrypt</a></li>
      <li><a href="https://unixorn.github.io/tags/macos/">Macos</a></li>
      <li><a href="https://unixorn.github.io/tags/r53/">R53</a></li>
      <li><a href="https://unixorn.github.io/tags/sops/">Sops</a></li>
      <li><a href="https://unixorn.github.io/tags/ssl/">Ssl</a></li>
      <li><a href="https://unixorn.github.io/tags/talos/">Talos</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://unixorn.github.io/post/homelab/k8s/04-backup-talos-etcd-to-smb/">
    <span class="title">« Prev</span>
    <br>
    <span>Back up your Talos etcd cluster to a smb share</span>
  </a>
  <a class="next" href="https://unixorn.github.io/post/homelab/k8s/02-k8s-cilium-r53-and-cert-manager/">
    <span class="title">Next »</span>
    <br>
    <span>Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Secret Management with SOPS on x"
            href="https://x.com/intent/tweet/?text=Secret%20Management%20with%20SOPS&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f03-secret-management-with-sops%2f&amp;hashtags=age%2ccert-manager%2cgpg%2chomelab%2ck8s%2ckubernetes%2cletsencrypt%2cmacos%2cr53%2csops%2cssl%2ctalos">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Secret Management with SOPS on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f03-secret-management-with-sops%2f&amp;title=Secret%20Management%20with%20SOPS&amp;summary=Secret%20Management%20with%20SOPS&amp;source=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f03-secret-management-with-sops%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Secret Management with SOPS on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f03-secret-management-with-sops%2f&title=Secret%20Management%20with%20SOPS">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Secret Management with SOPS on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f03-secret-management-with-sops%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Secret Management with SOPS on whatsapp"
            href="https://api.whatsapp.com/send?text=Secret%20Management%20with%20SOPS%20-%20https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f03-secret-management-with-sops%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Secret Management with SOPS on telegram"
            href="https://telegram.me/share/url?text=Secret%20Management%20with%20SOPS&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f03-secret-management-with-sops%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Secret Management with SOPS on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Secret%20Management%20with%20SOPS&u=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f03-secret-management-with-sops%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>Copyright 2019-2024, Joe Block. All rights reserved.</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <a rel="me" href="https://hachyderm.io/@unixorn">Mastodon</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
