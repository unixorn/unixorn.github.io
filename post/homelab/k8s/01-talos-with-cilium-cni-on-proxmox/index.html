<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Creating a Talos cluster with a Cilium CNI on Proxmox | unixorn.github.io</title>
<meta name="keywords" content="cert-manager, homelab, k8s, letsencrypt, r53, talos">
<meta name="description" content="I&rsquo;ve been meaning to set up a talos cluster in my homelab for a while and set one up over the holiday break. Here&rsquo;s how I did it.">
<meta name="author" content="Me">
<link rel="canonical" href="https://unixorn.github.io/post/homelab/k8s/01-talos-with-cilium-cni-on-proxmox/">
<meta name="google-site-verification" content="UA-100853138-2">
<link crossorigin="anonymous" href="https://unixorn.github.io/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css" integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF&#43;13Dyqob6ASlTrTye8=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://unixorn.github.io/post/homelab/k8s/01-talos-with-cilium-cni-on-proxmox/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://unixorn.github.io/post/homelab/k8s/01-talos-with-cilium-cni-on-proxmox/">
  <meta property="og:site_name" content="unixorn.github.io">
  <meta property="og:title" content="Creating a Talos cluster with a Cilium CNI on Proxmox">
  <meta property="og:description" content="I‚Äôve been meaning to set up a talos cluster in my homelab for a while and set one up over the holiday break. Here‚Äôs how I did it.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2026-01-04T09:27:42-07:00">
    <meta property="article:modified_time" content="2026-01-04T09:27:42-07:00">
    <meta property="article:tag" content="Cert-Manager">
    <meta property="article:tag" content="Homelab">
    <meta property="article:tag" content="K8s">
    <meta property="article:tag" content="Letsencrypt">
    <meta property="article:tag" content="R53">
    <meta property="article:tag" content="Talos">
      <meta property="og:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:title" content="Creating a Talos cluster with a Cilium CNI on Proxmox">
<meta name="twitter:description" content="I&rsquo;ve been meaning to set up a talos cluster in my homelab for a while and set one up over the holiday break. Here&rsquo;s how I did it.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://unixorn.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Creating a Talos cluster with a Cilium CNI on Proxmox",
      "item": "https://unixorn.github.io/post/homelab/k8s/01-talos-with-cilium-cni-on-proxmox/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Creating a Talos cluster with a Cilium CNI on Proxmox",
  "name": "Creating a Talos cluster with a Cilium CNI on Proxmox",
  "description": "I\u0026rsquo;ve been meaning to set up a talos cluster in my homelab for a while and set one up over the holiday break. Here\u0026rsquo;s how I did it.\n",
  "keywords": [
    "cert-manager", "homelab", "k8s", "letsencrypt", "r53", "talos"
  ],
  "articleBody": "I‚Äôve been meaning to set up a talos cluster in my homelab for a while and set one up over the holiday break. Here‚Äôs how I did it.\nAll the blogs and videos I looked at used the nginx ingress, which would be fine, except that the nginx ingress is a dead man walking and will be unsupported starting in March of 2026. No patches, no security updates, completely unsupported.\nBased on some advice on the hangops slack (Thanks, Brandon!) I wanted to use Cilium since it supports the Gateway API and can also do ARP announcements like MetallB.\nCreate a Proxmox VM control plane node There are a ton of videos and blogs so I‚Äôm not going to go into a lot of detail here. The TL;DR is:\nGo to the Talos image factory. Create an image. Start with the Cloud Server option Select the latest Talos version Pick nocloud from the cloud type screen since it explicitly mentions proxmox in the description Select your architecture You should now be on the System Extensions page. Pick qemu-guest-agent and util-linux-tools Pick auto for the bootloader. You should now see Schematic Ready. Copy the ISO link Download the ISO into your Proxmox host‚Äôs ISO storage Start a new VM with at least 4 CPUs, 4 GB of RAM and a 16GB drive. Make sure you enable the qemu agent. If you‚Äôre planning to use this for real workloads later, you‚Äôll want to go bigger - have a look at Sidero‚Äôs System Requirements page. Wait until the Talos Dashboard appears, then copy the new node‚Äôs IP address On your DHCP server, find the IP from step 6, and set that as a static assignment. The server will reboot multiple times during installation, and if it changes IP you will have to update your kubeconfig and talosconfig files. If it changes IP addresses after you add a worker node, things will break so spare yourself future aggravation and give it a static assignment. Once the Talos dashboard on the VM console shows that is in maintenance mode you can start to configure it. Again, make sure your DHCP is assigning it a static IP, that will save you aggravation later.\nWe‚Äôre going to make this a single node cluster to simplify things since it‚Äôs just for learning. You can add worker nodes later very easily once you want to put real workloads in the cluster.\nConfigure the cluster control plane Setup some environment variables Set a CONTROL_PLANE_IP environment variable to make copying commands from the post easier.\nexport CLUSTER_NAME=sisyphus export CONTROL_PLANE_IP=10.0.1.51 Find out what disks are on the server talosctl get disks --insecure --nodes \"$CONTROL_PLANE_IP\" You‚Äôll see something like\nNODE NAMESPACE TYPE ID VERSION SIZE READ ONLY TRANSPORT ROTATIONAL WWID MODEL SERIAL 10.0.1.51 runtime Disk loop0 2 73 MB true 10.0.1.51 runtime Disk sda 2 17 GB false virtio true QEMU HARDDISK 10.0.1.51 runtime Disk sr0 2 317 MB false ata true QEMU DVD-ROM QEMU_DVD-ROM_QM00003 Our node‚Äôs hard drive is sda, so\nexport DISK_NAME=sda Create a cluster patch file We‚Äôre going to use Cilium as the CNI and also have it replace kube-proxy, so let‚Äôs create the cluster with no CNI and disable kube-proxy. To do that, we‚Äôre going to create a patch file we can use when we generate the cluster‚Äôs configuration with talosctl.\n# cluster-patch.yaml cluster: network: cni: name: none proxy: # Disable kube-proxy, Cilium will replace it too disabled: true Generate the talos configuration talosctl gen config $CLUSTER_NAME \"https://$CONTROL_PLANE_IP:6443\" --install-disk \"/dev/$DISK_NAME\" --config-patch @cluster-patch.yaml export TALOSCONFIG=\"$(pwd)/talosconfig\" Initialize the cluster I like to test things in short-lived clusters so I don‚Äôt have to worry about breaking things that my internal services depend on. I like naming nodes clustername-role-number so that when I look at their proxmox console, it‚Äôs nice and clear what cluster the node is and what its role is.\nHere‚Äôs how to create a patch file that sets the node name when we apply our configuration. We also want to enable scheduling on the control plane node since we‚Äôre setting up a single-node cluster.\nCreate a controlplane-1-patch.yaml that includes the hostname you want and sets allowSchedulingOnControlPlanes to true.\n# controlplane-1-hostname-patch.yaml machine: network: hostname: sisyphus-cn-1 cluster: allowSchedulingOnControlPlanes: true Apply the configuration to your control plane node to initialize the cluster with the merged controlpane.yaml and controlplane-1-patch.yaml files.\ntalosctl apply-config --insecure \\ --nodes $CONTROL_PLANE_IP \\ --file controlplane.yaml \\ --insecure \\ --config-patch @controlplane-1-patch.yaml Bootstrap etcd in the cluster ONLY DO THIS ONCE! Wait until you see etcd is waiting to join the cluster in the bottom portion of the dashboard. Depending on how fast your proxmox host is, this can take 5-10 minutes.\nCreate a kubeconfig file talosctl kubeconfig sisyphus-kubeconfig --nodes $(CONTROL_PLANE_IP) export KUBECONFIG=\"$(pwd)/sisyphus-kubeconfig\" Confirm that the cluster came up kubectl get nodes You‚Äôll see something similar to\nNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME sisyphus-cn-1 Ready control-plane 5m v1.34.1 10.0.1.51 Talos (v1.11.5) 6.12.57-talos containerd://2.1.5 Install cilium First install the CRDs kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_grpcroutes.yaml kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml # Confirm gateway classes kubectl get crd gatewayclasses.gateway.networking.k8s.io gateways.gateway.networking.k8s.io httproutes.gateway.networking.k8s.io Confirm the gateway classes are present kubectl get crd gatewayclasses.gateway.networking.k8s.io gateways.gateway.networking.k8s.io httproutes.gateway.networking.k8s.io You should see something like this:\nNAME CREATED AT gatewayclasses.gateway.networking.k8s.io 2026-01-02T04:20:13Z gateways.gateway.networking.k8s.io 2026-01-02T04:20:14Z httproutes.gateway.networking.k8s.io 2026-01-02T04:20:15Z Set up the cilium helm repo helm repo add cilium https://helm.cilium.io/ helm repo update Install cilium cilium install \\ --version 1.18.1 \\ --helm-set=ipam.mode=kubernetes \\ --helm-set=kubeProxyReplacement=true \\ --helm-set=securityContext.capabilities.ciliumAgent=\"{CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}\" \\ --helm-set=securityContext.capabilities.cleanCiliumState=\"{NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}\" \\ --helm-set=cgroup.autoMount.enabled=false \\ --helm-set=cgroup.hostRoot=/sys/fs/cgroup \\ --helm-set=l2announcements.enabled=true \\ --helm-set=externalIPs.enabled=true \\ --set gatewayAPI.enabled=true \\ --helm-set=devices=e+ \\ --helm-set=operator.replicas=1 You‚Äôll see something like\n‚ÑπÔ∏è Using Cilium version 1.18.1 üîÆ Auto-detected cluster name: sisyphus üîÆ Auto-detected kube-proxy has not been installed ‚ÑπÔ∏è Cilium will fully replace all functionalities of kube-proxy I0101 21:25:52.110400 48637 warnings.go:110] \"Warning: spec.SessionAffinity is ignored for headless services\" This took several minutes to come up on my sisyphus cluster controller with 2 cores and 4GB RAM\nConfirm cilium status ‚ùØ cilium status /¬Ø¬Ø\\ /¬Ø¬Ø\\__/¬Ø¬Ø\\ Cilium: OK \\__/¬Ø¬Ø\\__/ Operator: OK /¬Ø¬Ø\\__/¬Ø¬Ø\\ Envoy DaemonSet: OK \\__/¬Ø¬Ø\\__/ Hubble Relay: disabled \\__/ ClusterMesh: disabled DaemonSet cilium Desired: 1, Ready: 1/1, Available: 1/1 DaemonSet cilium-envoy Desired: 1, Ready: 1/1, Available: 1/1 Deployment cilium-operator Desired: 1, Ready: 1/1, Available: 1/1 Containers: cilium Running: 1 cilium-envoy Running: 1 cilium-operator Running: 1 clustermesh-apiserver hubble-relay Cluster Pods: 2/2 managed by Cilium Helm chart version: 1.18.1 Image versions cilium quay.io/cilium/cilium:v1.18.1@sha256:65ab17c052d8758b2ad157ce766285e04173722df59bdee1ea6d5fda7149f0e9: 1 cilium-envoy quay.io/cilium/cilium-envoy:v1.34.4-1754895458-68cffdfa568b6b226d70a7ef81fc65dda3b890bf@sha256:247e908700012f7ef56f75908f8c965215c26a27762f296068645eb55450bda2: 1 cilium-operator quay.io/cilium/operator-generic:v1.18.1@sha256:97f4553afa443465bdfbc1cc4927c93f16ac5d78e4dd2706736e7395382201bc: 1 Update talosconfig The beginning of your talosconfig file will start with something like this:\ncontext: sisyphus contexts: sisyphus: endpoints: - 10.0.1.51 ca: Update it to include a nodes entry\ncontext: sisyphus contexts: sisyphus: endpoints: - 10.0.1.51 nodes: - 10.0.1.51 ca: This will keep you from contantly having to specify --nodes for your talosctl commands.\nConfirm that the cluster is showing healthy talosctl health Check external connectivity to cluster services First, test a LoadBalancer service Make a playground directory and put the following files in it.\nCreate the playground namespace # 01-create-namespace.yaml apiVersion: v1 kind: Namespace metadata: labels: kubernetes.io/metadata.name: playground name: playground Create an IP Pool and Announcement Policy # 02-cilium-setup.yaml # Create our list of IPs apiVersion: \"cilium.io/v2alpha1\" kind: CiliumLoadBalancerIPPool metadata: name: \"default-pool\" spec: blocks: - start: \"10.0.1.160\" # Use IPs that are outside of your DHCP range but on stop: \"10.0.1.170\" # the same /24 as your talos VM. --- apiVersion: \"cilium.io/v2alpha1\" kind: CiliumL2AnnouncementPolicy metadata: name: l2-announcement-policy spec: serviceSelector: {} nodeSelector: {} # On a multi-node cluster, you may not want the control-plane nodes # making arp announcements. Uncomment the nodeSelector stanza here # to disable that. # nodeSelector: # matchExpressions: # - key: node-role.kubernetes.io/control-plane # operator: DoesNotExist externalIPs: true loadBalancerIPs: true # Different hardware will show different network device names. # This list of regexes (in Golang format) will find all the common # naming schemes I've seen for network devices so that Cilium can # find a network interface to make arp announcements. interfaces: - ^eth+ - ^enp+ - ^ens+ - ^wlan+ - ^vmbr+ - ^wlp+ Create a deployment and service in the playground Talos is focused on giving you a default secure cluster out of the box, so you can‚Äôt just use kubectl create deployment hello-server --image=gcr.io/google-samples/hello-app:1.0 - talos requires you to configure the securityContext. Here‚Äôs an example deployment for nginx that runs as a non-root user and specifies the pod‚Äôs resource requirements to satisfy the Pod Security Admission configuration that ships with talos. More info about that here.\n# 03-playground-nginx.yaml apiVersion: v1 kind: Service metadata: name: playground-nginx-service namespace: playground annotations: # Tells Cilium to manage this IP via LB IPAM cilium.io/lb-ipam-pool-name: \"default-pool\" # Optional: For L2/BGP to announce this IP cilium.io/assign-internal-ip: \"true\" # Or use externalIPs: # If using externalIPs: # kubernetes.io/ingress.class: \"cilium\" # For Ingress # For a specific IP # lbipam.cilium.io/ips: \"192.168.1.50\" # The specific IP you want Cilium to answer on spec: type: LoadBalancer selector: app: playground-nginx-pod ports: - name: http port: 80 targetPort: 8080 --- apiVersion: apps/v1 kind: Deployment metadata: name: playground-nginx-app namespace: playground spec: selector: matchLabels: app: playground-nginx-pod # \u003c-- must match pod labels exactly replicas: 1 template: metadata: labels: app: playground-nginx-pod spec: # Talos is very security oriented, so we have to set up the # security context explicitly # ---------- Pod‚Äëlevel security settings ---------- securityContext: runAsNonRoot: true runAsUser: 101 # non‚Äëroot UID that the image can run as seccompProfile: type: RuntimeDefault # Uncomment if you need a shared FS group for volume writes # fsGroup: 101 # ---------- Containers ---------- containers: - name: nginx-playground-container image: nginxinc/nginx-unprivileged:latest # Alpine, but we force a non‚Äëroot UID imagePullPolicy: IfNotPresent ports: - containerPort: 8080 # talos requires us to specify our resources instead of # letting k8s YOLO them resources: requests: memory: \"64Mi\" cpu: \"250m\" limits: memory: \"128Mi\" cpu: \"500m\" securityContext: allowPrivilegeEscalation: false capabilities: drop: - ALL Deploy the playground If you pass a directory name to kubectl with -f, it will apply (or delete) all resources found in the .yaml files in that directory.\nkubectl apply -f playground See what IP the playground is using It will almost certainly be the first IP address in your IP Pool, but confirm that.\nkubectl get service -n playground You‚Äôll see something like:\nNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE playground-nginx-service LoadBalancer 10.111.180.4 10.0.1.160 80:30597/TCP 1m15s Confirm Connectivity curl http://THE_EXTERNAL_IP You should see the nginx default page! Don‚Äôt delete the playground yet, we‚Äôre going to use it to confirm that the Cilium Gateway API is working.\nTest Cilium‚Äôs Gateway API We configured Cilium to provide Gateway API services to the cluster when we installed it. Let‚Äôs confirm that it‚Äôs working correctly.\nMake a new gateway-tests directory.\nCreate a Gateway Create gateway-tests/01-create-gateway.yaml. For ease of testing we‚Äôre going to configure the gateway to allow it to be used by services in any namespace.\napiVersion: gateway.networking.k8s.io/v1 kind: Gateway metadata: name: playground-gateway spec: gatewayClassName: cilium listeners: - name: http protocol: HTTP port: 80 allowedRoutes: namespaces: from: All Update the playground-nginx-service Before we can add a HTTPRoute, we‚Äôre going to need to update the playground-nginx-service so it isn‚Äôt a LoadBalancer, so create gateway-tests/02-playground-service.yaml with the following contents:\napiVersion: v1 kind: Service metadata: name: playground-nginx-service namespace: playground spec: selector: app: playground-nginx-pod ports: - name: http port: 80 targetPort: 8080 # Port _service_ is listening on, not pods! Create a HTTPRoute Create gateway-tests/03-http-route.yaml to route all incoming requests for ip-160.mydomain.com to our playground-nginx-service.\napiVersion: gateway.networking.k8s.io/v1 kind: HTTPRoute metadata: name: playground-http-route namespace: playground spec: parentRefs: - name: playground-gateway namespace: default hostnames: - \"ip-160.mydomain.com\" rules: - backendRefs: - name: playground-nginx-service port: 80 Create the Gateway test resources kubectl apply -f gateway-tests Confirm it worked curl http://ip-160.mydomain.com It should display a ‚ÄúWelcome to nginx!‚Äù document that looks like this:\n\u003c!DOCTYPE html\u003e Welcome to nginx! Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\nFor online documentation and support please refer to nginx.org. Commercial support is available at nginx.com.\nThank you for using nginx.\nCongrats, you have a working talos cluster.\nI will cover setting up SSL by creating certificates with cert-manager, LetsEncrypt and Route 53 in a follow-up post.\nAdding a worker node I originally planned to make that another post, but it‚Äôs only two steps.\nCreate another VM The talos website recommends at least 2 CPUs and 2 GB RAM. I set mine to 16G of disk. You can use the same ISO you used when creating the control plane node.\nMake sure it has a static IP assignment in DHCP.\nAdd it to the cluster Create a patch file with the node name you want\n# worker-1-patch.yaml machine: network: hostname: clustername-worker-1 When the worker node console gets to Maintenance, you can add it with a one line talosctl command\ntalosctl apply-config --insecure --nodes \"$WORKER_IP\" --file worker.yaml --config-patch @worker-1-patch.yaml My proxmox cluster isn‚Äôt on beefy hardware so it took a couple of minutes for the new node to join the cluster and start accepting workload.\nProblems I ran into When I was making this post, I ran into a couple of problems because I was redoing everything to run on a single node blog cluster and made some mistakes tidying things up for a post.\nCurl fails to connect While testing the LoadBalancer service, even though the service LoadBalancer shows that it has an external IP, when you test with curl, it gives an error message similar to this:\n$ curl http://10.0.1.160/ curl: (7) Failed to connect to 10.0.1.160 port 80 after 16 ms: Could not connect to server And when you check the pods\nkubectl get pods -n playground it shows the worker pod as pending, not crash loop backoff, not creating, just pending.\nNAMESPACE NAME READY STATUS RESTARTS AGE playground pod/playground-nginx-app-6d7ddb5b95-lv82x 0/1 Pending 0 12s When I ran into this with the fresh blog cluster while writing this post, it was because I made it a single node cluster and then forgot to set allowSchedulingOnControlPlanes to true, so there was no place to schedule the pods. You can fix this by applying an updated configuration.\ntalosctl apply-config --insecure \\ --nodes $(CONTROL_PLANE_IP) \\ --file controlplane.yaml \\ --config-patch @controlplane-1-patch.yaml curl connects, but you get a 404 While testing the gateway, curl connects to the IP but you get a 404 error.\ncurl -v http://ip-160.mydomain.com/index.html * Host ip-160.mydomain.com:80 was resolved. * IPv6: (none) * IPv4: 10.0.1.160 * Trying 10.0.1.160:80... * Established connection to ip-160.mydomain.com (10.0.1.160 port 80) from 10.0.1.121 port 61150 * using HTTP/1.x \u003e GET /index.html HTTP/1.1 \u003e Host: ip-160.mydomain.com \u003e User-Agent: curl/8.17.0 \u003e Accept: */* \u003e * Request completely sent off \u003c HTTP/1.1 404 Not Found \u003c date: Sun, 04 Jan 2026 00:36:07 GMT \u003c server: envoy \u003c content-length: 0 \u003c * Connection #0 to host ip-160.mydomain.com:80 left intact I ran into this during testing because I forgot to update the gateway yaml file to allow all namespaces after I moved all the test manifests into the playground namespace.\nTalos reboots so fast that when I make settings changes to a single node cluster I always reboot the control plane node with talosctl reboot -n $CONTROL_PLANE_IP.\nYou changed cilium settings but they don‚Äôt appear to have any affect Some changes to cilium settings require you to restart cilium pods to pick them up.\nkubectl -n kube-system rollout restart ds/cilium kubectl -n kube-system rollout restart ds/cilium-envoy kubectl -n kube-system rollout restart deployment/cilium-operator ",
  "wordCount" : "2567",
  "inLanguage": "en",
  "image": "https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished": "2026-01-04T09:27:42-07:00",
  "dateModified": "2026-01-04T09:27:42-07:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://unixorn.github.io/post/homelab/k8s/01-talos-with-cilium-cni-on-proxmox/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "unixorn.github.io",
    "logo": {
      "@type": "ImageObject",
      "url": "https://unixorn.github.io/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://unixorn.github.io/" accesskey="h" title="Home (Alt + H)">
                <img src="https://unixorn.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://unixorn.github.io/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/projects/" title="projects">
                    <span>projects</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://hachyderm.io/@unixorn" title="hachyderm.io/@unixorn">
                    <span>hachyderm.io/@unixorn</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">
<link rel="stylesheet" type="text/css" href="https://unixorn.github.io/css/mastodon.css" />
<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://unixorn.github.io/">Home</a>&nbsp;¬ª&nbsp;<a href="https://unixorn.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      Creating a Talos cluster with a Cilium CNI on Proxmox
    </h1>
    <div class="post-meta"><span title='2026-01-04 09:27:42 -0700 MST'>January 4, 2026</span>&nbsp;¬∑&nbsp;13 min&nbsp;¬∑&nbsp;2567 words&nbsp;¬∑&nbsp;Me

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#create-a-proxmox-vm-control-plane-node">Create a Proxmox VM control plane node</a></li>
    <li><a href="#configure-the-cluster-control-plane">Configure the cluster control plane</a>
      <ul>
        <li><a href="#setup-some-environment-variables">Setup some environment variables</a></li>
        <li><a href="#find-out-what-disks-are-on-the-server">Find out what disks are on the server</a></li>
        <li><a href="#create-a-cluster-patch-file">Create a cluster patch file</a></li>
        <li><a href="#generate-the-talos-configuration">Generate the talos configuration</a></li>
        <li><a href="#initialize-the-cluster">Initialize the cluster</a></li>
        <li><a href="#bootstrap-etcd-in-the-cluster">Bootstrap etcd in the cluster</a></li>
        <li><a href="#create-a-kubeconfig-file">Create a kubeconfig file</a></li>
        <li><a href="#confirm-that-the-cluster-came-up">Confirm that the cluster came up</a></li>
      </ul>
    </li>
    <li><a href="#install-cilium">Install cilium</a>
      <ul>
        <li><a href="#first-install-the-crds">First install the CRDs</a></li>
        <li><a href="#confirm-the-gateway-classes-are-present">Confirm the gateway classes are present</a></li>
        <li><a href="#set-up-the-cilium-helm-repo">Set up the cilium helm repo</a></li>
        <li><a href="#install-cilium-1">Install cilium</a></li>
        <li><a href="#confirm-cilium-status">Confirm cilium status</a></li>
        <li><a href="#update-talosconfig">Update talosconfig</a></li>
        <li><a href="#confirm-that-the-cluster-is-showing-healthy">Confirm that the cluster is showing healthy</a></li>
      </ul>
    </li>
    <li><a href="#check-external-connectivity-to-cluster-services">Check external connectivity to cluster services</a>
      <ul>
        <li><a href="#first-test-a-loadbalancer-service">First, test a <code>LoadBalancer</code> service</a></li>
        <li><a href="#create-an-ip-pool-and-announcement-policy">Create an IP Pool and Announcement Policy</a></li>
        <li><a href="#confirm-connectivity">Confirm Connectivity</a></li>
      </ul>
    </li>
    <li><a href="#test-ciliums-gateway-api">Test Cilium&rsquo;s Gateway API</a>
      <ul>
        <li><a href="#create-a-gateway">Create a Gateway</a></li>
        <li><a href="#update-the-playground-nginx-service">Update the <code>playground-nginx-service</code></a></li>
        <li><a href="#create-a-httproute">Create a HTTPRoute</a></li>
        <li><a href="#create-the-gateway-test-resources">Create the Gateway test resources</a></li>
        <li><a href="#confirm-it-worked">Confirm it worked</a></li>
      </ul>
    </li>
    <li><a href="#adding-a-worker-node">Adding a worker node</a>
      <ul>
        <li><a href="#create-another-vm">Create another VM</a></li>
        <li><a href="#add-it-to-the-cluster">Add it to the cluster</a></li>
      </ul>
    </li>
    <li><a href="#problems-i-ran-into">Problems I ran into</a>
      <ul>
        <li><a href="#curl-fails-to-connect">Curl fails to connect</a></li>
        <li><a href="#curl-connects-but-you-get-a-404">curl connects, but you get a 404</a></li>
        <li><a href="#you-changed-cilium-settings-but-they-dont-appear-to-have-any-affect">You changed cilium settings but they don&rsquo;t appear to have any affect</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>I&rsquo;ve been meaning to set up a talos cluster in my homelab for a while and set one up over the holiday break. Here&rsquo;s how I did it.</p>
<p>All the blogs and videos I looked at used the nginx ingress, which would be fine, except that the nginx ingress is a dead man walking and will be unsupported starting in March of 2026. No patches, no security updates, completely unsupported.</p>
<p>Based on some advice on the hangops slack (Thanks, Brandon!) I wanted to use Cilium since it supports the Gateway API and can also do ARP announcements like MetallB.</p>
<h2 id="create-a-proxmox-vm-control-plane-node">Create a Proxmox VM control plane node<a hidden class="anchor" aria-hidden="true" href="#create-a-proxmox-vm-control-plane-node">#</a></h2>
<p>There are a ton of videos and blogs so I&rsquo;m not going to go into a lot of detail here. The TL;DR is:</p>
<ol>
<li>Go to the Talos <a href="https://factory.talos.dev/">image factory</a>.</li>
<li>Create an image.</li>
<li>Start with the <strong>Cloud Server</strong> option</li>
<li>Select the latest Talos version</li>
<li>Pick <code>nocloud</code> from the cloud type screen since it explicitly mentions proxmox in the description</li>
<li>Select your architecture</li>
<li>You should now be on the <strong>System Extensions</strong> page. Pick <code>qemu-guest-agent</code> and <code>util-linux-tools</code></li>
<li>Pick <code>auto</code> for the bootloader.</li>
<li>You should now see <strong>Schematic Ready</strong>. Copy the ISO link</li>
<li>Download the ISO into your Proxmox host&rsquo;s ISO storage</li>
<li>Start a new VM with at least 4 CPUs, 4 GB of RAM and a 16GB drive. Make sure you enable the qemu agent. If you&rsquo;re planning to use this for real workloads later, you&rsquo;ll want to go bigger - have a look at Sidero&rsquo;s <a href="https://docs.siderolabs.com/talos/v1.9/getting-started/system-requirements">System Requirements</a> page.</li>
<li>Wait until the Talos Dashboard appears, then copy the new node&rsquo;s IP address</li>
<li>On your DHCP server, find the IP from step 6, and set that as a static assignment. The server will reboot multiple times during installation, and if it changes IP you will have to update your <code>kubeconfig</code> and <code>talosconfig</code> files. If it changes IP addresses after you add a worker node, things will break so spare yourself future aggravation and give it a static assignment.</li>
</ol>
<p>Once the Talos dashboard on the VM console shows that is in maintenance mode you can start to configure it. Again, make sure your DHCP is assigning it a static IP, that will save you aggravation later.</p>
<p>We&rsquo;re going to make this a single node cluster to simplify things since it&rsquo;s just for learning. You can add worker nodes later very easily once you want to put real workloads in the cluster.</p>
<h2 id="configure-the-cluster-control-plane">Configure the cluster control plane<a hidden class="anchor" aria-hidden="true" href="#configure-the-cluster-control-plane">#</a></h2>
<h3 id="setup-some-environment-variables">Setup some environment variables<a hidden class="anchor" aria-hidden="true" href="#setup-some-environment-variables">#</a></h3>
<p>Set a <code>CONTROL_PLANE_IP</code> environment variable to make copying commands from the post easier.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CLUSTER_NAME</span><span class="o">=</span>sisyphus
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CONTROL_PLANE_IP</span><span class="o">=</span>10.0.1.51
</span></span></code></pre></div><h3 id="find-out-what-disks-are-on-the-server">Find out what disks are on the server<a hidden class="anchor" aria-hidden="true" href="#find-out-what-disks-are-on-the-server">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">talosctl get disks --insecure --nodes <span class="s2">&#34;</span><span class="nv">$CONTROL_PLANE_IP</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p>You&rsquo;ll see something like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">NODE        NAMESPACE   TYPE   ID      VERSION   SIZE     READ ONLY   TRANSPORT   ROTATIONAL   WWID   MODEL           SERIAL
</span></span><span class="line"><span class="cl">10.0.1.51   runtime     Disk   loop0   <span class="m">2</span>         <span class="m">73</span> MB    <span class="nb">true</span>
</span></span><span class="line"><span class="cl">10.0.1.51   runtime     Disk   sda     <span class="m">2</span>         <span class="m">17</span> GB    <span class="nb">false</span>       virtio      <span class="nb">true</span>                QEMU HARDDISK
</span></span><span class="line"><span class="cl">10.0.1.51   runtime     Disk   sr0     <span class="m">2</span>         <span class="m">317</span> MB   <span class="nb">false</span>       ata         <span class="nb">true</span>                QEMU DVD-ROM    QEMU_DVD-ROM_QM00003
</span></span></code></pre></div><p>Our node&rsquo;s hard drive is <code>sda</code>, so</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DISK_NAME</span><span class="o">=</span>sda
</span></span></code></pre></div><h3 id="create-a-cluster-patch-file">Create a cluster patch file<a hidden class="anchor" aria-hidden="true" href="#create-a-cluster-patch-file">#</a></h3>
<p>We&rsquo;re going to use Cilium as the CNI and also have it replace <code>kube-proxy</code>, so let&rsquo;s create the cluster with no CNI and disable <code>kube-proxy</code>. To do that, we&rsquo;re going to create a patch file we can use when we generate the cluster&rsquo;s configuration with <code>talosctl</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># cluster-patch.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">cluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cni</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">proxy</span><span class="p">:</span><span class="w"> </span><span class="c"># Disable kube-proxy, Cilium will replace it too</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">disabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><h3 id="generate-the-talos-configuration">Generate the talos configuration<a hidden class="anchor" aria-hidden="true" href="#generate-the-talos-configuration">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">talosctl gen config <span class="nv">$CLUSTER_NAME</span> <span class="s2">&#34;https://</span><span class="nv">$CONTROL_PLANE_IP</span><span class="s2">:6443&#34;</span> --install-disk <span class="s2">&#34;/dev/</span><span class="nv">$DISK_NAME</span><span class="s2">&#34;</span> --config-patch @cluster-patch.yaml
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TALOSCONFIG</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/talosconfig&#34;</span>
</span></span></code></pre></div><h3 id="initialize-the-cluster">Initialize the cluster<a hidden class="anchor" aria-hidden="true" href="#initialize-the-cluster">#</a></h3>
<p>I like to test things in short-lived clusters so I don&rsquo;t have to worry about breaking things that my internal services depend on. I like naming nodes <code>clustername-role-number</code> so that when I look at their proxmox console, it&rsquo;s nice and clear what cluster the node is and what its role is.</p>
<p>Here&rsquo;s how to create a patch file that sets the node name when we apply our configuration. We also want to enable scheduling on the control plane node since we&rsquo;re setting up a single-node cluster.</p>
<p>Create a <code>controlplane-1-patch.yaml</code> that includes the hostname you want and sets <code>allowSchedulingOnControlPlanes</code> to <code>true</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># controlplane-1-hostname-patch.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">sisyphus-cn-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">cluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">allowSchedulingOnControlPlanes</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>Apply the configuration to your control plane node to initialize the cluster with the merged <code>controlpane.yaml</code> and <code>controlplane-1-patch.yaml</code> files.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">talosctl apply-config --insecure <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --nodes <span class="nv">$CONTROL_PLANE_IP</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --file controlplane.yaml <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --insecure <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --config-patch @controlplane-1-patch.yaml
</span></span></code></pre></div><h3 id="bootstrap-etcd-in-the-cluster">Bootstrap etcd in the cluster<a hidden class="anchor" aria-hidden="true" href="#bootstrap-etcd-in-the-cluster">#</a></h3>
<p><em>ONLY DO THIS ONCE!</em> Wait until you see <code>etcd is waiting to join the cluster</code> in the bottom portion of the dashboard. Depending on how fast your proxmox host is, this can take 5-10 minutes.</p>
<h3 id="create-a-kubeconfig-file">Create a kubeconfig file<a hidden class="anchor" aria-hidden="true" href="#create-a-kubeconfig-file">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">talosctl kubeconfig sisyphus-kubeconfig --nodes <span class="k">$(</span>CONTROL_PLANE_IP<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/sisyphus-kubeconfig&#34;</span>
</span></span></code></pre></div><h3 id="confirm-that-the-cluster-came-up">Confirm that the cluster came up<a hidden class="anchor" aria-hidden="true" href="#confirm-that-the-cluster-came-up">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get nodes
</span></span></code></pre></div><p>You&rsquo;ll see something similar to</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">NAME              STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE          KERNEL-VERSION   CONTAINER-RUNTIME
</span></span><span class="line"><span class="cl">sisyphus-cn-1     Ready    control-plane   5m      v1.34.1   10.0.1.51     &lt;none&gt;        Talos (v1.11.5)   6.12.57-talos    containerd://2.1.5
</span></span></code></pre></div><h2 id="install-cilium">Install cilium<a hidden class="anchor" aria-hidden="true" href="#install-cilium">#</a></h2>
<h3 id="first-install-the-crds">First install the CRDs<a hidden class="anchor" aria-hidden="true" href="#first-install-the-crds">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_grpcroutes.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># Confirm gateway classes</span>
</span></span><span class="line"><span class="cl">kubectl get crd gatewayclasses.gateway.networking.k8s.io gateways.gateway.networking.k8s.io httproutes.gateway.networking.k8s.io
</span></span></code></pre></div><h3 id="confirm-the-gateway-classes-are-present">Confirm the gateway classes are present<a hidden class="anchor" aria-hidden="true" href="#confirm-the-gateway-classes-are-present">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get crd gatewayclasses.gateway.networking.k8s.io gateways.gateway.networking.k8s.io httproutes.gateway.networking.k8s.io
</span></span></code></pre></div><p>You should see something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">NAME                                       CREATED AT
</span></span><span class="line"><span class="cl">gatewayclasses.gateway.networking.k8s.io   2026-01-02T04:20:13Z
</span></span><span class="line"><span class="cl">gateways.gateway.networking.k8s.io         2026-01-02T04:20:14Z
</span></span><span class="line"><span class="cl">httproutes.gateway.networking.k8s.io       2026-01-02T04:20:15Z
</span></span></code></pre></div><h3 id="set-up-the-cilium-helm-repo">Set up the cilium helm repo<a hidden class="anchor" aria-hidden="true" href="#set-up-the-cilium-helm-repo">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">helm repo add cilium https://helm.cilium.io/
</span></span><span class="line"><span class="cl">helm repo update
</span></span></code></pre></div><h3 id="install-cilium-1">Install cilium<a hidden class="anchor" aria-hidden="true" href="#install-cilium-1">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium install <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --version 1.18.1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span>ipam.mode<span class="o">=</span>kubernetes <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span><span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span>securityContext.capabilities.ciliumAgent<span class="o">=</span><span class="s2">&#34;{CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span>securityContext.capabilities.cleanCiliumState<span class="o">=</span><span class="s2">&#34;{NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span>cgroup.autoMount.enabled<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span>cgroup.hostRoot<span class="o">=</span>/sys/fs/cgroup <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span>l2announcements.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span>externalIPs.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set gatewayAPI.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span><span class="nv">devices</span><span class="o">=</span>e+ <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --helm-set<span class="o">=</span>operator.replicas<span class="o">=</span><span class="m">1</span>
</span></span></code></pre></div><p>You&rsquo;ll see something like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">‚ÑπÔ∏è  Using Cilium version 1.18.1
</span></span><span class="line"><span class="cl">üîÆ Auto-detected cluster name: sisyphus
</span></span><span class="line"><span class="cl">üîÆ Auto-detected kube-proxy has not been installed
</span></span><span class="line"><span class="cl">‚ÑπÔ∏è  Cilium will fully replace all functionalities of kube-proxy
</span></span><span class="line"><span class="cl">I0101 21:25:52.110400   <span class="m">48637</span> warnings.go:110<span class="o">]</span> <span class="s2">&#34;Warning: spec.SessionAffinity is ignored for headless services&#34;</span>
</span></span></code></pre></div><p>This took several minutes to come up on my sisyphus cluster controller with 2 cores and 4GB RAM</p>
<h3 id="confirm-cilium-status">Confirm cilium status<a hidden class="anchor" aria-hidden="true" href="#confirm-cilium-status">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">‚ùØ cilium status
</span></span><span class="line"><span class="cl">    /¬Ø¬Ø<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="cl"> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Envoy DaemonSet:    OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Hubble Relay:       disabled
</span></span><span class="line"><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DaemonSet              cilium                   Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">DaemonSet              cilium-envoy             Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Deployment             cilium-operator          Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Containers:            cilium                   Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-envoy             Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-operator          Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       clustermesh-apiserver
</span></span><span class="line"><span class="cl">                       hubble-relay
</span></span><span class="line"><span class="cl">Cluster Pods:          2/2 managed by Cilium
</span></span><span class="line"><span class="cl">Helm chart version:    1.18.1
</span></span><span class="line"><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.18.1@sha256:65ab17c052d8758b2ad157ce766285e04173722df59bdee1ea6d5fda7149f0e9: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-envoy       quay.io/cilium/cilium-envoy:v1.34.4-1754895458-68cffdfa568b6b226d70a7ef81fc65dda3b890bf@sha256:247e908700012f7ef56f75908f8c965215c26a27762f296068645eb55450bda2: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.18.1@sha256:97f4553afa443465bdfbc1cc4927c93f16ac5d78e4dd2706736e7395382201bc: <span class="m">1</span>
</span></span></code></pre></div><h3 id="update-talosconfig">Update talosconfig<a hidden class="anchor" aria-hidden="true" href="#update-talosconfig">#</a></h3>
<p>The beginning of your <code>talosconfig</code> file will start with something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">sisyphus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">contexts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sisyphus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="m">10.0.1.51</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ca</span><span class="p">:</span><span class="w"> 
</span></span></span></code></pre></div><p>Update it to include a nodes entry</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">sisyphus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">contexts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sisyphus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="m">10.0.1.51</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="m">10.0.1.51</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ca</span><span class="p">:</span><span class="w"> 
</span></span></span></code></pre></div><p>This will keep you from contantly having to specify <code>--nodes</code> for your <code>talosctl</code> commands.</p>
<h3 id="confirm-that-the-cluster-is-showing-healthy">Confirm that the cluster is showing healthy<a hidden class="anchor" aria-hidden="true" href="#confirm-that-the-cluster-is-showing-healthy">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">talosctl health
</span></span></code></pre></div><h2 id="check-external-connectivity-to-cluster-services">Check external connectivity to cluster services<a hidden class="anchor" aria-hidden="true" href="#check-external-connectivity-to-cluster-services">#</a></h2>
<h3 id="first-test-a-loadbalancer-service">First, test a <code>LoadBalancer</code> service<a hidden class="anchor" aria-hidden="true" href="#first-test-a-loadbalancer-service">#</a></h3>
<p>Make a <code>playground</code> directory and put the following files in it.</p>
<h4 id="create-the-playground-namespace">Create the playground namespace<a hidden class="anchor" aria-hidden="true" href="#create-the-playground-namespace">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 01-create-namespace.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">playground</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">playground</span><span class="w">
</span></span></span></code></pre></div><h3 id="create-an-ip-pool-and-announcement-policy">Create an IP Pool and Announcement Policy<a hidden class="anchor" aria-hidden="true" href="#create-an-ip-pool-and-announcement-policy">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 02-cilium-setup.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Create our list of IPs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumLoadBalancerIPPool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;default-pool&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">blocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">start</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.1.160&#34;</span><span class="w"> </span><span class="c"># Use IPs that are outside of your DHCP range but on</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.1.170&#34;</span><span class="w">  </span><span class="c"># the same /24 as your talos VM.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumL2AnnouncementPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">l2-announcement-policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># On a multi-node cluster, you may not want the control-plane nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># making arp announcements. Uncomment the nodeSelector stanza here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># to disable that.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># nodeSelector:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   matchExpressions:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#     - key: node-role.kubernetes.io/control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#       operator: DoesNotExist</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">externalIPs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancerIPs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Different hardware will show different network device names.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># This list of regexes (in Golang format) will find all the common</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># naming schemes I&#39;ve seen for network devices so that Cilium can</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># find a network interface to make arp announcements.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">interfaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">^eth+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">^enp+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">^ens+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">^wlan+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">^vmbr+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">^wlp+</span><span class="w">
</span></span></span></code></pre></div><h4 id="create-a-deployment-and-service-in-the-playground">Create a deployment and service in the playground<a hidden class="anchor" aria-hidden="true" href="#create-a-deployment-and-service-in-the-playground">#</a></h4>
<p>Talos is focused on giving you a default secure cluster out of the box, so you can&rsquo;t just use <code>kubectl create deployment hello-server --image=gcr.io/google-samples/hello-app:1.0</code> - talos requires you to configure the <code>securityContext</code>. Here&rsquo;s an example deployment for nginx that runs as a non-root user and specifies the pod&rsquo;s resource requirements to satisfy the Pod Security Admission configuration that ships with talos. More info about that <a href="https://docs.siderolabs.com/kubernetes-guides/security/pod-security">here</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 03-playground-nginx.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">playground-nginx-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">playground</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Tells Cilium to manage this IP via LB IPAM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cilium.io/lb-ipam-pool-name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;default-pool&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Optional: For L2/BGP to announce this IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cilium.io/assign-internal-ip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># Or use externalIPs:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># If using externalIPs:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># kubernetes.io/ingress.class: &#34;cilium&#34; # For Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># For a specific IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># lbipam.cilium.io/ips: &#34;192.168.1.50&#34; # The specific IP you want Cilium to answer on</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">playground-nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">playground-nginx-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">playground</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">playground-nginx-pod </span><span class="w"> </span><span class="c"># &lt;-- must match pod labels exactly</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">playground-nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Talos is very security oriented, so we have to set up the</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># security context explicitly</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># ---------- Pod‚Äëlevel security settings ----------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">101</span><span class="w"> </span><span class="c"># non‚Äëroot UID that the image can run as</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># Uncomment if you need a shared FS group for volume writes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># fsGroup: 101</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># ---------- Containers ----------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-playground-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginxinc/nginx-unprivileged:latest</span><span class="w"> </span><span class="c"># Alpine, but we force a non‚Äëroot UID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># talos requires us to specify our resources instead of</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># letting k8s YOLO them</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;64Mi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;250m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;128Mi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;500m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">drop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">ALL</span><span class="w">
</span></span></span></code></pre></div><h4 id="deploy-the-playground">Deploy the playground<a hidden class="anchor" aria-hidden="true" href="#deploy-the-playground">#</a></h4>
<p>If you pass a directory name to <code>kubectl</code> with <code>-f</code>, it will apply (or delete) all resources found in the <code>.yaml</code> files in that directory.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f playground
</span></span></code></pre></div><h5 id="see-what-ip-the-playground-is-using">See what IP the playground is using<a hidden class="anchor" aria-hidden="true" href="#see-what-ip-the-playground-is-using">#</a></h5>
<p>It will almost certainly be the first IP address in your IP Pool, but confirm that.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get service -n playground
</span></span></code></pre></div><p>You&rsquo;ll see something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">NAME                       TYPE           CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">playground-nginx-service   LoadBalancer   10.111.180.4   10.0.1.160    80:30597/TCP   1m15s
</span></span></code></pre></div><h3 id="confirm-connectivity">Confirm Connectivity<a hidden class="anchor" aria-hidden="true" href="#confirm-connectivity">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://THE_EXTERNAL_IP
</span></span></code></pre></div><p>You should see the nginx default page! Don&rsquo;t delete the playground yet, we&rsquo;re going to use it to confirm that the Cilium Gateway API is working.</p>
<h2 id="test-ciliums-gateway-api">Test Cilium&rsquo;s Gateway API<a hidden class="anchor" aria-hidden="true" href="#test-ciliums-gateway-api">#</a></h2>
<p>We configured Cilium to provide Gateway API services to the cluster when we installed it. Let&rsquo;s confirm that it&rsquo;s working correctly.</p>
<p>Make a new <code>gateway-tests</code> directory.</p>
<h3 id="create-a-gateway">Create a Gateway<a hidden class="anchor" aria-hidden="true" href="#create-a-gateway">#</a></h3>
<p>Create <code>gateway-tests/01-create-gateway.yaml</code>. For ease of testing we&rsquo;re going to configure the gateway to allow it to be used by services in any namespace.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">playground-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gatewayClassName</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">allowedRoutes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l">All</span><span class="w">
</span></span></span></code></pre></div><h3 id="update-the-playground-nginx-service">Update the <code>playground-nginx-service</code><a hidden class="anchor" aria-hidden="true" href="#update-the-playground-nginx-service">#</a></h3>
<p>Before we can add a <code>HTTPRoute</code>, we&rsquo;re going to need to update the <code>playground-nginx-service</code> so it isn&rsquo;t a <code>LoadBalancer</code>, so create <code>gateway-tests/02-playground-service.yaml</code> with the following contents:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">playground-nginx-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">playground</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">playground-nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># Port _service_ is listening on, not pods!</span><span class="w">
</span></span></span></code></pre></div><h3 id="create-a-httproute">Create a HTTPRoute<a hidden class="anchor" aria-hidden="true" href="#create-a-httproute">#</a></h3>
<p>Create <code>gateway-tests/03-http-route.yaml</code> to route all incoming requests for <code>ip-160.mydomain.com</code> to our <code>playground-nginx-service</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">playground-http-route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">playground</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">playground-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;ip-160.mydomain.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">playground-nginx-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><h3 id="create-the-gateway-test-resources">Create the Gateway test resources<a hidden class="anchor" aria-hidden="true" href="#create-the-gateway-test-resources">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f gateway-tests
</span></span></code></pre></div><h3 id="confirm-it-worked">Confirm it worked<a hidden class="anchor" aria-hidden="true" href="#confirm-it-worked">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://ip-160.mydomain.com
</span></span></code></pre></div><p>It should display a &ldquo;Welcome to nginx!&rdquo; document that looks like this:</p>
<pre tabindex="0"><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&#34;http://nginx.org/&#34;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&#34;http://nginx.com/&#34;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>Congrats, you have a working talos cluster.</p>
<p>I will cover setting up SSL by creating certificates with cert-manager, LetsEncrypt and Route 53 in a follow-up post.</p>
<h2 id="adding-a-worker-node">Adding a worker node<a hidden class="anchor" aria-hidden="true" href="#adding-a-worker-node">#</a></h2>
<p>I originally planned to make that another post, but it&rsquo;s only two steps.</p>
<h3 id="create-another-vm">Create another VM<a hidden class="anchor" aria-hidden="true" href="#create-another-vm">#</a></h3>
<p>The talos website recommends at least 2 CPUs and 2 GB RAM. I set mine to 16G of disk. You can use the same ISO you used when creating the control plane node.</p>
<p>Make sure it has a static IP assignment in DHCP.</p>
<h3 id="add-it-to-the-cluster">Add it to the cluster<a hidden class="anchor" aria-hidden="true" href="#add-it-to-the-cluster">#</a></h3>
<p>Create a patch file with the node name you want</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># worker-1-patch.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">clustername-worker-1</span><span class="w">
</span></span></span></code></pre></div><p>When the worker node console gets to Maintenance, you can add it with a one line talosctl command</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">talosctl apply-config --insecure --nodes <span class="s2">&#34;</span><span class="nv">$WORKER_IP</span><span class="s2">&#34;</span> --file worker.yaml --config-patch @worker-1-patch.yaml
</span></span></code></pre></div><p>My proxmox cluster isn&rsquo;t on beefy hardware so it took a couple of minutes for the new node to join the cluster and start accepting workload.</p>
<h2 id="problems-i-ran-into">Problems I ran into<a hidden class="anchor" aria-hidden="true" href="#problems-i-ran-into">#</a></h2>
<p>When I was making this post, I ran into a couple of problems because I was redoing everything to run on a single node blog cluster and made some mistakes tidying things up for a post.</p>
<h3 id="curl-fails-to-connect">Curl fails to connect<a hidden class="anchor" aria-hidden="true" href="#curl-fails-to-connect">#</a></h3>
<p>While testing the <code>LoadBalancer</code> service, even though the service <code>LoadBalancer</code> shows that it has an external IP, when you test with <code>curl</code>, it gives an error message similar to this:</p>
<pre tabindex="0"><code>$ curl http://10.0.1.160/
curl: (7) Failed to connect to 10.0.1.160 port 80 after 16 ms: Could not connect to server
</code></pre><p>And when you check the pods</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pods -n playground
</span></span></code></pre></div><p>it shows the worker pod as pending, not crash loop backoff, not creating, just pending.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">NAMESPACE     NAME                                          READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">playground    pod/playground-nginx-app-6d7ddb5b95-lv82x     0/1     Pending   <span class="m">0</span>             12s
</span></span></code></pre></div><p>When I ran into this with the fresh blog cluster while writing this post, it was because I made it a single node cluster and then forgot to set <code>allowSchedulingOnControlPlanes</code> to <code>true</code>, so there was no place to schedule the pods. You can fix this by applying an updated configuration.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">talosctl apply-config --insecure <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --nodes <span class="k">$(</span>CONTROL_PLANE_IP<span class="k">)</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --file controlplane.yaml <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --config-patch @controlplane-1-patch.yaml
</span></span></code></pre></div><h3 id="curl-connects-but-you-get-a-404">curl connects, but you get a 404<a hidden class="anchor" aria-hidden="true" href="#curl-connects-but-you-get-a-404">#</a></h3>
<p>While testing the gateway, <code>curl</code> connects to the IP but you get a 404 error.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -v http://ip-160.mydomain.com/index.html
</span></span><span class="line"><span class="cl">* Host ip-160.mydomain.com:80 was resolved.
</span></span><span class="line"><span class="cl">* IPv6: <span class="o">(</span>none<span class="o">)</span>
</span></span><span class="line"><span class="cl">* IPv4: 10.0.1.160
</span></span><span class="line"><span class="cl">*   Trying 10.0.1.160:80...
</span></span><span class="line"><span class="cl">* Established connection to ip-160.mydomain.com <span class="o">(</span>10.0.1.160 port 80<span class="o">)</span> from 10.0.1.121 port <span class="m">61150</span>
</span></span><span class="line"><span class="cl">* using HTTP/1.x
</span></span><span class="line"><span class="cl">&gt; GET /index.html HTTP/1.1
</span></span><span class="line"><span class="cl">&gt; Host: ip-160.mydomain.com
</span></span><span class="line"><span class="cl">&gt; User-Agent: curl/8.17.0
</span></span><span class="line"><span class="cl">&gt; Accept: */*
</span></span><span class="line"><span class="cl">&gt;
</span></span><span class="line"><span class="cl">* Request completely sent off
</span></span><span class="line"><span class="cl">&lt; HTTP/1.1 <span class="m">404</span> Not Found
</span></span><span class="line"><span class="cl">&lt; date: Sun, <span class="m">04</span> Jan <span class="m">2026</span> 00:36:07 GMT
</span></span><span class="line"><span class="cl">&lt; server: envoy
</span></span><span class="line"><span class="cl">&lt; content-length: <span class="m">0</span>
</span></span><span class="line"><span class="cl">&lt;
</span></span><span class="line"><span class="cl">* Connection <span class="c1">#0 to host ip-160.mydomain.com:80 left intact</span>
</span></span></code></pre></div><p>I ran into this during testing because I forgot to update the gateway yaml file to allow all namespaces after I moved all the test manifests into the <code>playground</code> namespace.</p>
<p>Talos reboots so fast that when I make settings changes to a single node cluster I always reboot the control plane node with <code>talosctl reboot -n $CONTROL_PLANE_IP</code>.</p>
<h3 id="you-changed-cilium-settings-but-they-dont-appear-to-have-any-affect">You changed cilium settings but they don&rsquo;t appear to have any affect<a hidden class="anchor" aria-hidden="true" href="#you-changed-cilium-settings-but-they-dont-appear-to-have-any-affect">#</a></h3>
<p>Some changes to cilium settings require you to restart cilium pods to pick them up.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl -n kube-system rollout restart ds/cilium
</span></span><span class="line"><span class="cl">kubectl -n kube-system rollout restart ds/cilium-envoy
</span></span><span class="line"><span class="cl">kubectl -n kube-system rollout restart deployment/cilium-operator
</span></span></code></pre></div>

  </div>
  <div>
    
<div class="article-content">
  <h2>Comments</h2>
  <p>You can use your Mastodon account to reply to this<a class="button" href="https://hachyderm.io/@unixorn/115837850698893516">post</a></p>
  <p><button class="button" id="replyButton" href="https://hachyderm.io/@unixorn/115837850698893516">Reply</button></p>
  <dialog id="toot-reply" class="mastodon" data-component="dialog">
    <h3>Reply to unixorn's post</h3>
    <p>
      With an account on the Fediverse or Mastodon, you can respond to this post.
      Since Mastodon is decentralized, you can use your existing account hosted by another Mastodon server or compatible platform if you don't have an account on this one.
    </p>
    <p>Copy and paste this URL into the search field of your favourite Fediverse app or the web interface of your Mastodon server.</p>
    <div class="copypaste">
      <input type="text" readonly="" value="https://hachyderm.io/@unixorn/115837850698893516">
      <button class="button" id="copyButton">Copy</button>
      <button class="button" id="cancelButton">Close</button>
    </div>
  </dialog>
  <p id="mastodon-comments-list"><button id="load-comment" class="button">Load comments</button></p>
  <noscript><p>You need JavaScript to view the comments.</p></noscript>
  <script src="https://unixorn.github.io/assets/js/purify.min.js"></script>
  <script type="text/javascript">
    const dialog = document.querySelector('dialog');

    document.getElementById('replyButton').addEventListener('click', () => {
      dialog.showModal();
    });

    document.getElementById('copyButton').addEventListener('click', () => {
      navigator.clipboard.writeText('https://hachyderm.io/@unixorn/115837850698893516');
    });

    document.getElementById('cancelButton').addEventListener('click', () => {
      dialog.close();
    });

    dialog.addEventListener('keydown', e => {
      if (e.key === 'Escape') dialog.close();
    });

    const dateOptions = {
      year: "numeric",
      month: "numeric",
      day: "numeric",
      hour: "numeric",
      minute: "numeric",
    };

    function escapeHtml(unsafe) {
      return unsafe
           .replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#039;");
   }

    document.getElementById("load-comment").addEventListener("click", function() {
      document.getElementById("load-comment").innerHTML = "Loading";
      fetch('https://hachyderm.io/api/v1/statuses/115837850698893516/context')
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          if(data['descendants'] &&
             Array.isArray(data['descendants']) &&
            data['descendants'].length > 0) {
              document.getElementById('mastodon-comments-list').innerHTML = "";
              data['descendants'].forEach(function(reply) {
                reply.account.display_name = escapeHtml(reply.account.display_name);
                reply.account.reply_class = reply.in_reply_to_id == "115837850698893516" ? "reply-original" : "reply-child";
                reply.account.emojis.forEach(emoji => {
                  reply.account.display_name = reply.account.display_name.replace(`:${emoji.shortcode}:`,
                    `<img src="${escapeHtml(emoji.static_url)}" alt="Emoji ${emoji.shortcode}" height="20" width="20" />`);
                });
                mastodonComment =
                  `<div class="mastodon-wrapper">
                    <div class="comment-level ${reply.account.reply_class}"><svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="none" transform="rotate(180)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path stroke="#535358" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.608 12.526l7.04-6.454C13.931 4.896 16 5.806 16 7.546V11c13 0 11 16 11 16s-4-10-11-10v3.453c0 1.74-2.069 2.65-3.351 1.475l-7.04-6.454a2 2 0 010-2.948z"></path> </g></svg></div>
                    <div class="mastodon-comment">
                     <div class="avatar">
                       <img src="${escapeHtml(reply.account.avatar_static)}" height=60 width=60 alt="">
                     </div>
                     <div class="content">
                       <div class="author">
                         <a href="${reply.account.url}" rel="nofollow">
                           <span>${reply.account.display_name}</span>
                           <span class="disabled">${escapeHtml(reply.account.acct)}</span>
                         </a>
                         <a class="date" href="${reply.uri}" rel="nofollow">
                           ${reply.created_at.substr(0, 10)}
                         </a>
                       </div>
                       <div class="mastodon-comment-content">${reply.content}</div>
                     </div>
                   </div>
                  </div>`;
                document.getElementById('mastodon-comments-list').appendChild(DOMPurify.sanitize(mastodonComment, {'RETURN_DOM_FRAGMENT': true}));
              });
          } else {
            document.getElementById('mastodon-comments-list').innerHTML = "<p>No comments found</p>";
          }
        });
      });
  </script>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://unixorn.github.io/tags/cert-manager/">Cert-Manager</a></li>
      <li><a href="https://unixorn.github.io/tags/homelab/">Homelab</a></li>
      <li><a href="https://unixorn.github.io/tags/k8s/">K8s</a></li>
      <li><a href="https://unixorn.github.io/tags/letsencrypt/">Letsencrypt</a></li>
      <li><a href="https://unixorn.github.io/tags/r53/">R53</a></li>
      <li><a href="https://unixorn.github.io/tags/talos/">Talos</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://unixorn.github.io/post/2025-12-26-advice-for-switching-to-proton-hosted-email/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>Switching to Proton.me eMail Advice</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Creating a Talos cluster with a Cilium CNI on Proxmox on x"
            href="https://x.com/intent/tweet/?text=Creating%20a%20Talos%20cluster%20with%20a%20Cilium%20CNI%20on%20Proxmox&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f01-talos-with-cilium-cni-on-proxmox%2f&amp;hashtags=cert-manager%2chomelab%2ck8s%2cletsencrypt%2cr53%2ctalos">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Creating a Talos cluster with a Cilium CNI on Proxmox on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f01-talos-with-cilium-cni-on-proxmox%2f&amp;title=Creating%20a%20Talos%20cluster%20with%20a%20Cilium%20CNI%20on%20Proxmox&amp;summary=Creating%20a%20Talos%20cluster%20with%20a%20Cilium%20CNI%20on%20Proxmox&amp;source=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f01-talos-with-cilium-cni-on-proxmox%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Creating a Talos cluster with a Cilium CNI on Proxmox on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f01-talos-with-cilium-cni-on-proxmox%2f&title=Creating%20a%20Talos%20cluster%20with%20a%20Cilium%20CNI%20on%20Proxmox">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Creating a Talos cluster with a Cilium CNI on Proxmox on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f01-talos-with-cilium-cni-on-proxmox%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Creating a Talos cluster with a Cilium CNI on Proxmox on whatsapp"
            href="https://api.whatsapp.com/send?text=Creating%20a%20Talos%20cluster%20with%20a%20Cilium%20CNI%20on%20Proxmox%20-%20https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f01-talos-with-cilium-cni-on-proxmox%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Creating a Talos cluster with a Cilium CNI on Proxmox on telegram"
            href="https://telegram.me/share/url?text=Creating%20a%20Talos%20cluster%20with%20a%20Cilium%20CNI%20on%20Proxmox&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f01-talos-with-cilium-cni-on-proxmox%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Creating a Talos cluster with a Cilium CNI on Proxmox on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Creating%20a%20Talos%20cluster%20with%20a%20Cilium%20CNI%20on%20Proxmox&u=https%3a%2f%2funixorn.github.io%2fpost%2fhomelab%2fk8s%2f01-talos-with-cilium-cni-on-proxmox%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>Copyright 2019-2024, Joe Block. All rights reserved.</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <a rel="me" href="https://hachyderm.io/@unixorn">Mastodon</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
