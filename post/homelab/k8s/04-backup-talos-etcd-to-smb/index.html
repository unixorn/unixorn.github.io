<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Back up your Talos etcd cluster to a smb share | unixorn.github.io</title>
<meta name="keywords" content="backups, etcd, homelab, k8s, smb, talos">
<meta name="description" content="In this post, I will show how to access smb shares outside the cluster from a Kubernetes Pod. I will be backing up the etcd cluster in my Talos k8s cluster to a share, but you can use this for any service (like Plex or Jellyfin) that need access to files on a NAS.
This is part four of my Homelab Kubernetes series.

Part 1 - Setting up Talos with a Cilium CNI on proxmox
Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53
Part 3 - Secret Management with SOPS
Part 4 - Back up your Talos etcd cluster to a SMB share

The Kubernetes project has created a standardized API specification to make it possible for third parties to write plugins that allow clusters to interact with file or block based storage systems without having to have code merged into the core project.">
<meta name="author" content="Me">
<link rel="canonical" href="http://localhost:1313/post/homelab/k8s/04-backup-talos-etcd-to-smb/">
<meta name="google-site-verification" content="UA-100853138-2">
<link crossorigin="anonymous" href="http://localhost:1313/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css" integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF&#43;13Dyqob6ASlTrTye8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/post/homelab/k8s/04-backup-talos-etcd-to-smb/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://localhost:1313/post/homelab/k8s/04-backup-talos-etcd-to-smb/">
  <meta property="og:site_name" content="unixorn.github.io">
  <meta property="og:title" content="Back up your Talos etcd cluster to a smb share">
  <meta property="og:description" content="In this post, I will show how to access smb shares outside the cluster from a Kubernetes Pod. I will be backing up the etcd cluster in my Talos k8s cluster to a share, but you can use this for any service (like Plex or Jellyfin) that need access to files on a NAS.
This is part four of my Homelab Kubernetes series.
Part 1 - Setting up Talos with a Cilium CNI on proxmox Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53 Part 3 - Secret Management with SOPS Part 4 - Back up your Talos etcd cluster to a SMB share The Kubernetes project has created a standardized API specification to make it possible for third parties to write plugins that allow clusters to interact with file or block based storage systems without having to have code merged into the core project.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2026-01-24T12:20:42-07:00">
    <meta property="article:modified_time" content="2026-01-24T12:20:42-07:00">
    <meta property="article:tag" content="Backups">
    <meta property="article:tag" content="Etcd">
    <meta property="article:tag" content="Homelab">
    <meta property="article:tag" content="K8s">
    <meta property="article:tag" content="Smb">
    <meta property="article:tag" content="Talos">
      <meta property="og:image" content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:title" content="Back up your Talos etcd cluster to a smb share">
<meta name="twitter:description" content="In this post, I will show how to access smb shares outside the cluster from a Kubernetes Pod. I will be backing up the etcd cluster in my Talos k8s cluster to a share, but you can use this for any service (like Plex or Jellyfin) that need access to files on a NAS.
This is part four of my Homelab Kubernetes series.

Part 1 - Setting up Talos with a Cilium CNI on proxmox
Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53
Part 3 - Secret Management with SOPS
Part 4 - Back up your Talos etcd cluster to a SMB share

The Kubernetes project has created a standardized API specification to make it possible for third parties to write plugins that allow clusters to interact with file or block based storage systems without having to have code merged into the core project.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Back up your Talos etcd cluster to a smb share",
      "item": "http://localhost:1313/post/homelab/k8s/04-backup-talos-etcd-to-smb/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Back up your Talos etcd cluster to a smb share",
  "name": "Back up your Talos etcd cluster to a smb share",
  "description": "In this post, I will show how to access smb shares outside the cluster from a Kubernetes Pod. I will be backing up the etcd cluster in my Talos k8s cluster to a share, but you can use this for any service (like Plex or Jellyfin) that need access to files on a NAS.\nThis is part four of my Homelab Kubernetes series.\nPart 1 - Setting up Talos with a Cilium CNI on proxmox Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53 Part 3 - Secret Management with SOPS Part 4 - Back up your Talos etcd cluster to a SMB share The Kubernetes project has created a standardized API specification to make it possible for third parties to write plugins that allow clusters to interact with file or block based storage systems without having to have code merged into the core project.\n",
  "keywords": [
    "backups", "etcd", "homelab", "k8s", "smb", "talos"
  ],
  "articleBody": "In this post, I will show how to access smb shares outside the cluster from a Kubernetes Pod. I will be backing up the etcd cluster in my Talos k8s cluster to a share, but you can use this for any service (like Plex or Jellyfin) that need access to files on a NAS.\nThis is part four of my Homelab Kubernetes series.\nPart 1 - Setting up Talos with a Cilium CNI on proxmox Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53 Part 3 - Secret Management with SOPS Part 4 - Back up your Talos etcd cluster to a SMB share The Kubernetes project has created a standardized API specification to make it possible for third parties to write plugins that allow clusters to interact with file or block based storage systems without having to have code merged into the core project.\nIn this article, we’re going to:\nInstall the SMB CSI Driver Create a StorageClass, PersistentVolume and PersistentVolumeClaim Used a demo Deployment to confirm things are working Set up a backups PersistentVolume and PersistentVolumeClaim Create a CronJob that backs up the talos etcd cluster every night at 1:11 am Prerequisites A working kubernetes cluster. I’m using Talos for mine, but regular kubernetes or k3s clusters will work too. If you need to set up a new cluster, or configure an existing one to use Cilum, read part one of this series. helm \u0026 kubectl - if you don’t want to brew install them, install instructions are at helm.sh and kubectl. A SMB share on a NAS A separate user on the NAS that the cluster will use to access the share. Don’t just use your main NAS account, you want to be able to restrict what the cluster can do and which shares it can access. Software Versions Here are the versions of the software I used while writing this post. Later versions should work, but this is what these instructions were tested with.\nSoftware Version helm 4.0.1 kubectl 1.34 kubernetes 1.34.1 talos 1.11.5 SMB CSI Driver for Kubernetes 1.19.1 Installation Install with helm We’re going to use helm to install the SMB CSI Driver for Kubernetes from kubernetes-csi/csi-driver-smb.\n# Install the helm repository and CSI driver helm repo add csi-driver-smb https://raw.githubusercontent.com/kubernetes-csi/csi-driver-smb/master/charts helm install csi-driver-smb csi-driver-smb/csi-driver-smb --namespace kube-system --version 1.19.1 Confirm pods are running kubectl --namespace=kube-system get pods --selector=\"app.kubernetes.io/name=csi-driver-smb\" You should see one copy of the csi-smb-controller pod, and one for each node in your cluster. On my homelab main talos cluster it looks like this:\nNAME READY STATUS RESTARTS AGE csi-smb-controller-66588dccff-4lfkt 4/4 Running 3 (7d6h ago) 7d16h csi-smb-node-5q22s 3/3 Running 3 (7d16h ago) 7d16h csi-smb-node-hzrss 3/3 Running 0 6d5h csi-smb-node-ms4gh 3/3 Running 0 6d6h csi-smb-node-nhk84 3/3 Running 0 7d16h Configuration Create a namespace We’re going to put all the resources used in this post into a separate backups namespace, so create it now\nkubectl create namespace backups Create a secret We need to store login credentials for the server we’re going to connect to. We’re going to use sops (see part three - Secret Management with SOPS for install instructions) to create a secret containing the username and password.\nUsing SOPS # backups-smb-sopssecret.yaml apiVersion: isindir.github.com/v1alpha3 kind: SopsSecret metadata: name: backups-smb-sopssecret namespace: backups spec: secretTemplates: - name: backups-smb-secret stringData: username: k8s password: connect-to-nas Encrypt it, then apply it\nsops encrypt -i backups-smb-sopssecret.yaml \u0026\u0026 \\ kubectl apply -f backups-smb-sopssecret.yaml` Insecure Alternative Alternatively we can define login credentials using a Secret manifest file. To do that, we’re going to specify the username and password as stringData fields so we don’t have to encode them ourselves with base64.\n# insecure-secret.yaml apiVersion: v1 kind: Secret metadata: name: backups-smb-secret namespace: backups type: Opaque stringData: username: k8s password: your-password-here and add it by running kubectl apply -f insecure-secret.yaml\nUsing the SMB Storage Class Now that we have our server credentials in a secret, we can set up a storageClass that connects to our server.\n# smb-storage-class.yaml apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: smb-csi provisioner: smb.csi.k8s.io parameters: source: \"//your.servers.fqdn.or.ip.address/blog-demo\" # Define Samba share csi.storage.k8s.io/provisioner-secret-name: \"backups-smb-secret\" csi.storage.k8s.io/provisioner-secret-namespace: \"backups\" createSubDir: \"true\" # Creates subdirectories for each PersistentVolumeClaim csi.storage.k8s.io/node-stage-secret-name: \"backups-smb-secret\" # Define Samba credential secret csi.storage.k8s.io/node-stage-secret-namespace: \"backups\" # Define Samba credential secret namespace # Uncomment these two lines to make this the default storage class # for your cluster # annotations: # storageclass.kubernetes.io/is-default-class: \"true\" mountOptions: - dir_mode=0777 - file_mode=0777 - mfsymlinks - vers=3.0 # Define Samba version reclaimPolicy: Delete volumeBindingMode: Immediate allowVolumeExpansion: true Create a PersistentVolumeClaim This manifest will create a PVC with a 1Gi quota\napiVersion: v1 kind: PersistentVolumeClaim metadata: name: smb-pvc spec: accessModes: - ReadWriteMany storageClassName: smb-csi resources: requests: storage: 1Gi Create a pod that uses your pvc apiVersion: v1 kind: Pod metadata: name: smb-test-pod spec: containers: - name: app image: busybox # talos requires resources specified instead of letting k8s YOLO them resources: requests: memory: \"64Mi\" cpu: \"250m\" limits: memory: \"64Mi\" command: - /bin/sh - -c - | echo 'Demo smb-csi' \u003e /mnt/smb/csi-demo.txt date \u003e\u003e /mnt/smb/csi-demo.txt echo 'Sleeping 300 seconds so it stays visible in kubectl get pods' sleep 300 volumeMounts: - mountPath: \"/mnt/smb\" name: smb-volume volumes: - name: smb-volume persistentVolumeClaim: claimName: smb-pvc You can now see the pvc and pod in the cluster\nkubectl get pod,pvc NAME READY STATUS RESTARTS AGE pod/smb-test-pod 1/1 Running 0 34s NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS VOLUMEATTRIBUTESCLASS AGE persistentvolumeclaim/smb-pvc Bound pvc-5e3acec4-af9e-4cbd-8613-10c64ad7ebaa 1Gi RWX smb-csi 36s And if I log into the NAS, I can see the pvc subdirectory in my blog-demo share\n$ cd /volume2/blog-demo $ ls -lah Permissions Size User Date Modified Name drwxrwx--- - admin 20 Jan 00:30 #recycle drwxrwxrwx@ - root 6 Jan 23:22 @eaDir drwxrwxrwx - talos 25 Jan 13:51 pvc-5e3acec4-af9e-4cbd-8613-10c64ad7ebaa $ cat pvc-5e3acec4-af9e-4cbd-8613-10c64ad7ebaa/csi-demo.txt Demo smb-csi Sun Jan 25 20:56:51 UTC 2026 Practical Usage: Back up Talos’ etcd cluster Now that we’ve confirmed our configuration can connect to our NAS, let’s set up backups for the etcd cluster. These examples are Talos-specific, but still a good example of using SMB storage in cluster cron jobs.\nSet up the PersistentVolue and PersistentVolumeClaim to use for backups First, create a PersistentVolume that connects to our backups share.\nIMPORTANT: You must set persistentVolumeReclaimPolicy to Retain so the CSI doesn’t delete the pvc’s remote directory if we delete the pvc or we could accidentally wipe our backups volume!\nSince we’re doing static provisioning, we also need to set storageClassName to \"\" in both the PersistentVolume and the PersistentVolumeClaim that uses it.\n# backups.smb.setup.yaml apiVersion: v1 kind: PersistentVolume metadata: name: pv-backups-share namespace: backups spec: capacity: storage: 10Gi # Set an appropriate size accessModes: - ReadWriteMany # Allows the volume to be mounted by many nodes # IMPORTANT: Set persistentVolumeReclaimPolicy to Retain so the CSI doesn't # delete the pvc's remote directory if we delete the pvc or we could # accidentally wipe our backups volume! persistentVolumeReclaimPolicy: Retain storageClassName: \"\" # Must be an empty string for static provisioning csi: driver: smb.csi.k8s.io readOnly: false volumeHandle: k8s-backups-smb-unseen # A unique name for the volume handle volumeAttributes: source: \"\\\\\\\\unseen.miniclusters.rocks\\\\k8s-backups\" # Use escaped backslashes or forward slashes nodeStageSecretRef: name: backups-smb-secret namespace: backups # The namespace where you created the secret --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: pvc-backups-share namespace: backups spec: accessModes: - ReadWriteMany resources: requests: storage: 10Gi storageClassName: \"\" # Must match the empty string in the PV volumeName: pv-backups-share --- Create a talosconfig secret The backup script needs to run talosctl to extract a backup from the cluster’s etcd, so let’s create a secret\nkubectl create secret generic backups-talosconfig \\ --from-file talosconfig \\ --namespace backups Our CronJob will mount that into the backup pod at /etc/talos/talosconfig.\nCreate a CronJob We’re going to use my unixorn/talosctl-backup image to run my tal-backup-etcd script to backup etcd. Source for both the docker image and `tal-backup-etcd can be found on Github at unixorn/talosctl-etcd-backups.\nBy default, after a successful backup, tal-backup-etcd deletes any backups in the backup directory older than $KEEP_DAYS old.\n# etcd-backup.cronjob.yaml apiVersion: batch/v1 kind: CronJob metadata: name: cron-backup-void-etcd namespace: backups spec: # Standard cron syntax: minute hour day-of-month month day-of-week schedule: \"11 1 * * *\" timeZone: \"America/Denver\" successfulJobsHistoryLimit: 5 failedJobsHistoryLimit: 10 concurrencyPolicy: Forbid # Prevents a new backup if the old one is still running jobTemplate: spec: backoffLimit: 4 ttlSecondsAfterFinished: 604800 # Keep jobs for a week so I can examine their logs template: spec: restartPolicy: OnFailure containers: - name: app image: unixorn/talosctl-backup:latest env: - name: TZ value: \"America/Denver\" - name: BACKUP_D value: /mnt/backups/etcd-backups - name: KEEP_DAYS value: \"30\" - name: PRUNE_OK value: \"true\" - name: TALOSCONFIG value: \"/etc/talos/talosconfig\" resources: requests: memory: \"64Mi\" cpu: \"250m\" limits: memory: \"64Mi\" command: [ \"sh\", \"-c\", \"/usr/local/bin/tal-backup-etcd ; ls -lah /mnt/backups/void-etcd\" ] volumeMounts: - name: backups-volume mountPath: \"/mnt/backups\" - name: talosconfig mountPath: \"/etc/talos\" readOnly: true volumes: - name: backups-volume persistentVolumeClaim: claimName: pvc-backups-share - name: talosconfig secret: secretName: backups-talosconfig You can now install the CronJob with kubectl apply -f etc-backup.cronjob.yaml\nBonus Job manifest Having a cluster CronJob is great, but you probably don’t want to wait until 1 am to see if it works. It’s also handy to be able to run a backup immediately if you’re planning to do an experiment that might break your etcd.\nHere’s a Job you can use to test or run backups at arbitrary times.\n# immmediate-backup.yaml apiVersion: batch/v1 kind: Job metadata: name: backups-void-etcd namespace: backups spec: ttlSecondsAfterFinished: 604800 # Keep results around for a week backoffLimit: 4 template: spec: restartPolicy: OnFailure containers: - name: app image: unixorn/talosctl-backup env: - name: TZ value: \"America/Denver\" - name: BACKUP_D value: /mnt/backups/etcd-backups - name: KEEP_DAYS value: \"30\" - name: PRUNE_OK value: \"true\" - name: TALOSCONFIG value: \"/etc/talosconfig/talosconfig\" resources: requests: memory: \"64Mi\" cpu: \"250m\" limits: memory: \"64Mi\" command: [ \"sh\", \"-c\", \"/usr/local/bin/tal-backup-etcd ; ls -lah /mnt/backups/etcd-backups\" ] volumeMounts: - name: backups-volume mountPath: \"/mnt/backups\" - name: talosconfig mountPath: \"/etc/talosconfig\" readOnly: true volumes: # Moved inside pod spec - name: backups-volume persistentVolumeClaim: claimName: pvc-backups-share - name: talosconfig secret: secretName: backups-talosconfig Use kubectl apply -f immediate-backup.yaml to run it.\nSummary You should now have:\nInstalled the SMB CSI driver into your cluster Created a StorageClass that stores files on a NAS Created a Deployment that shows how to keep a pod’s work files on an SMB share Created a PersistentVolume that connects to a backups share and does not delete files after pvcs using it have been deleted from your cluster Created a PersistentVolumeClaim that backup jobs can use to write backups to your SMB server Created a CronJob and a Job that you can use to back up your etcd cluster both via cron and at arbitrary times. Backed up your etcd ",
  "wordCount" : "1758",
  "inLanguage": "en",
  "image": "http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished": "2026-01-24T12:20:42-07:00",
  "dateModified": "2026-01-24T12:20:42-07:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/post/homelab/k8s/04-backup-talos-etcd-to-smb/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "unixorn.github.io",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">
                <img src="http://localhost:1313/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects/" title="projects">
                    <span>projects</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://hachyderm.io/@unixorn" title="hachyderm.io/@unixorn">
                    <span>hachyderm.io/@unixorn</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">
<link rel="stylesheet" type="text/css" href="http://localhost:1313/css/mastodon.css" />
<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/post/">Posts</a></div>
    <h1 class="post-title">
      Back up your Talos etcd cluster to a smb share<sup><span class="entry-isdraft">&nbsp;&nbsp;[draft]</span></sup>
    </h1>
    <div class="post-meta"><span title='2026-01-24 12:20:42 -0700 MST'>January 24, 2026</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;1758 words&nbsp;·&nbsp;Me

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisites">Prerequisites</a>
      <ul>
        <li><a href="#software-versions">Software Versions</a></li>
      </ul>
    </li>
    <li><a href="#installation">Installation</a>
      <ul>
        <li><a href="#install-with-helm">Install with helm</a></li>
        <li><a href="#confirm-pods-are-running">Confirm pods are running</a></li>
      </ul>
    </li>
    <li><a href="#configuration">Configuration</a>
      <ul>
        <li><a href="#create-a-namespace">Create a namespace</a></li>
        <li><a href="#create-a-secret">Create a secret</a></li>
        <li><a href="#using-the-smb-storage-class">Using the SMB Storage Class</a></li>
      </ul>
    </li>
    <li><a href="#practical-usage-back-up-talos-etcd-cluster">Practical Usage: Back up Talos&rsquo; etcd cluster</a>
      <ul>
        <li><a href="#set-up-the-persistentvolue-and-persistentvolumeclaim-to-use-for-backups">Set up the PersistentVolue and PersistentVolumeClaim to use for backups</a></li>
        <li><a href="#create-a-talosconfig-secret">Create a talosconfig secret</a></li>
        <li><a href="#create-a-cronjob">Create a CronJob</a></li>
        <li><a href="#bonus-job-manifest">Bonus Job manifest</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>In this post, I will show how to access smb shares outside the cluster from a Kubernetes Pod. I will be backing up the etcd cluster in my Talos k8s cluster to a share, but you can use this for any service (like Plex or Jellyfin) that need access to files on a NAS.</p>
<p>This is part four of my Homelab Kubernetes series.</p>
<ul>
<li><a href="../01-talos-with-cilium-cni-on-proxmox/">Part 1 - Setting up Talos with a Cilium CNI on proxmox</a></li>
<li><a href="../02-k8s-cilium-r53-and-cert-manager/">Part 2 Add SSL to Kubernetes using Cilium, cert-manager and LetsEncrypt with domains hosted on Amazon Route 53</a></li>
<li><a href="../03-secret-management-with-sops/">Part 3 - Secret Management with SOPS</a></li>
<li>Part 4 - Back up your Talos etcd cluster to a SMB share</li>
</ul>
<p>The Kubernetes project has created a standardized API specification to make it possible for third parties to write plugins that allow clusters to interact with file or block based storage systems without having to have code merged into the core project.</p>
<p>In this article, we&rsquo;re going to:</p>
<ul>
<li>Install the SMB CSI Driver</li>
<li>Create a <code>StorageClass</code>, <code>PersistentVolume</code> and <code>PersistentVolumeClaim</code></li>
<li>Used a demo Deployment to confirm things are working</li>
<li>Set up a backups <code>PersistentVolume</code> and <code>PersistentVolumeClaim</code></li>
<li>Create a <code>CronJob</code> that backs up the talos etcd cluster every night at 1:11 am</li>
</ul>
<h2 id="prerequisites">Prerequisites<a hidden class="anchor" aria-hidden="true" href="#prerequisites">#</a></h2>
<ul>
<li>A working kubernetes cluster. I&rsquo;m using <a href="https://www.talos.dev/">Talos</a> for mine, but regular <a href="https://kubernetes.io">kubernetes</a> or <a href="https://k3s.io">k3s</a> clusters will work too. If you need to set up a new cluster, or configure an existing one to use Cilum, read <a href="(../01-talos-with-cilium-cni-on-proxmox/)">part one</a> of this series.</li>
<li><code>helm</code> &amp; <code>kubectl</code> - if you don&rsquo;t want to <code>brew install</code> them, install instructions are at <a href="https://helm.sh">helm.sh</a> and <a href="https://kubernetes.io/docs/tasks/tools/">kubectl</a>.</li>
<li>A SMB share on a NAS</li>
<li>A separate user on the NAS that the cluster will use to access the share. Don&rsquo;t just use your main NAS account, you want to be able to restrict what the cluster can do and which shares it can access.</li>
</ul>
<h3 id="software-versions">Software Versions<a hidden class="anchor" aria-hidden="true" href="#software-versions">#</a></h3>
<p>Here are the versions of the software I used while writing this post. Later versions should work, but this is what these instructions were tested with.</p>
<table>
  <thead>
      <tr>
          <th>Software</th>
          <th>Version</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>helm</code></td>
          <td>4.0.1</td>
      </tr>
      <tr>
          <td><code>kubectl</code></td>
          <td>1.34</td>
      </tr>
      <tr>
          <td><code>kubernetes</code></td>
          <td>1.34.1</td>
      </tr>
      <tr>
          <td><code>talos</code></td>
          <td>1.11.5</td>
      </tr>
      <tr>
          <td><code>SMB CSI Driver for Kubernetes</code></td>
          <td>1.19.1</td>
      </tr>
  </tbody>
</table>
<h2 id="installation">Installation<a hidden class="anchor" aria-hidden="true" href="#installation">#</a></h2>
<h3 id="install-with-helm">Install with helm<a hidden class="anchor" aria-hidden="true" href="#install-with-helm">#</a></h3>
<p>We&rsquo;re going to use <code>helm</code> to install the SMB CSI Driver for Kubernetes from <a href="https://github.com/kubernetes-csi/csi-driver-smb">kubernetes-csi/csi-driver-smb</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Install the helm repository and CSI driver</span>
</span></span><span class="line"><span class="cl">helm repo add csi-driver-smb https://raw.githubusercontent.com/kubernetes-csi/csi-driver-smb/master/charts
</span></span><span class="line"><span class="cl">helm install csi-driver-smb csi-driver-smb/csi-driver-smb --namespace kube-system --version 1.19.1
</span></span></code></pre></div><h3 id="confirm-pods-are-running">Confirm pods are running<a hidden class="anchor" aria-hidden="true" href="#confirm-pods-are-running">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --namespace<span class="o">=</span>kube-system get pods --selector<span class="o">=</span><span class="s2">&#34;app.kubernetes.io/name=csi-driver-smb&#34;</span>
</span></span></code></pre></div><p>You should see one copy of the <code>csi-smb-controller</code> pod, and one for each node in your cluster. On my homelab main talos cluster it looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">NAME                                  READY   STATUS    RESTARTS        AGE
</span></span><span class="line"><span class="cl">csi-smb-controller-66588dccff-4lfkt   4/4     Running   3 (7d6h ago)    7d16h
</span></span><span class="line"><span class="cl">csi-smb-node-5q22s                    3/3     Running   3 (7d16h ago)   7d16h
</span></span><span class="line"><span class="cl">csi-smb-node-hzrss                    3/3     Running   0               6d5h
</span></span><span class="line"><span class="cl">csi-smb-node-ms4gh                    3/3     Running   0               6d6h
</span></span><span class="line"><span class="cl">csi-smb-node-nhk84                    3/3     Running   0               7d16h
</span></span></code></pre></div><h2 id="configuration">Configuration<a hidden class="anchor" aria-hidden="true" href="#configuration">#</a></h2>
<h3 id="create-a-namespace">Create a namespace<a hidden class="anchor" aria-hidden="true" href="#create-a-namespace">#</a></h3>
<p>We&rsquo;re going to put all the resources used in this post into a separate backups namespace, so create it now</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create namespace backups
</span></span></code></pre></div><h3 id="create-a-secret">Create a secret<a hidden class="anchor" aria-hidden="true" href="#create-a-secret">#</a></h3>
<p>We need to store login credentials for the server we&rsquo;re going to connect to. We&rsquo;re going to use <code>sops</code> (see part three - <a href="../03-secret-management-with-sops/">Secret Management with SOPS</a> for install instructions) to create a secret containing the username and password.</p>
<h4 id="using-sops">Using SOPS<a hidden class="anchor" aria-hidden="true" href="#using-sops">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># backups-smb-sopssecret.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">isindir.github.com/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">SopsSecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-smb-sopssecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-smb-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">k8s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">connect-to-nas</span><span class="w">
</span></span></span></code></pre></div><p>Encrypt it, then apply it</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sops encrypt -i backups-smb-sopssecret.yaml <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  kubectl apply -f backups-smb-sopssecret.yaml<span class="sb">`</span>
</span></span></code></pre></div><h4 id="insecure-alternative">Insecure Alternative<a hidden class="anchor" aria-hidden="true" href="#insecure-alternative">#</a></h4>
<p>Alternatively we can define login credentials using a Secret manifest file. To do that, we&rsquo;re going to specify the username and password as <code>stringData</code> fields so we don&rsquo;t have to encode them ourselves with <code>base64</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># insecure-secret.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-smb-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">k8s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">your-password-here</span><span class="w">
</span></span></span></code></pre></div><p>and add it by running <code>kubectl apply -f insecure-secret.yaml</code></p>
<h3 id="using-the-smb-storage-class">Using the SMB Storage Class<a hidden class="anchor" aria-hidden="true" href="#using-the-smb-storage-class">#</a></h3>
<p>Now that we have our server credentials in a secret, we can set up a <code>storageClass</code> that connects to our server.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># smb-storage-class.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">smb-csi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">smb.csi.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;//your.servers.fqdn.or.ip.address/blog-demo&#34;</span><span class="w">  </span><span class="c"># Define Samba share</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">csi.storage.k8s.io/provisioner-secret-name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;backups-smb-secret&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">csi.storage.k8s.io/provisioner-secret-namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;backups&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">createSubDir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># Creates subdirectories for each PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">csi.storage.k8s.io/node-stage-secret-name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;backups-smb-secret&#34;</span><span class="w"> </span><span class="c"># Define Samba credential secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">csi.storage.k8s.io/node-stage-secret-namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;backups&#34;</span><span class="w"> </span><span class="c"># Define Samba credential secret namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Uncomment these two lines to make this the default storage class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># for your cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># annotations:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   storageclass.kubernetes.io/is-default-class: &#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mountOptions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">dir_mode=0777</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">file_mode=0777</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">mfsymlinks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">vers=3.0 </span><span class="w"> </span><span class="c"># Define Samba version</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l">Immediate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">allowVolumeExpansion</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><h4 id="create-a-persistentvolumeclaim">Create a <code>PersistentVolumeClaim</code><a hidden class="anchor" aria-hidden="true" href="#create-a-persistentvolumeclaim">#</a></h4>
<p>This manifest will create a PVC with a 1Gi quota</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">smb-pvc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">smb-csi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></div><h4 id="create-a-pod-that-uses-your-pvc">Create a pod that uses your pvc<a hidden class="anchor" aria-hidden="true" href="#create-a-pod-that-uses-your-pvc">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">smb-test-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># talos requires resources specified instead of letting k8s YOLO them</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;64Mi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;250m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;64Mi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">/bin/sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      echo &#39;Demo smb-csi&#39; &gt; /mnt/smb/csi-demo.txt
</span></span></span><span class="line"><span class="cl"><span class="sd">      date &gt;&gt; /mnt/smb/csi-demo.txt
</span></span></span><span class="line"><span class="cl"><span class="sd">      echo &#39;Sleeping 300 seconds so it stays visible in kubectl get pods&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">      sleep 300</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/mnt/smb&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">smb-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">smb-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">smb-pvc</span><span class="w">
</span></span></span></code></pre></div><p>You can now see the pvc and pod in the cluster</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pod,pvc
</span></span><span class="line"><span class="cl">NAME               READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/smb-test-pod   1/1     Running   <span class="m">0</span>          34s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
</span></span><span class="line"><span class="cl">persistentvolumeclaim/smb-pvc      Bound    pvc-5e3acec4-af9e-4cbd-8613-10c64ad7ebaa   1Gi        RWX            smb-csi        &lt;unset&gt;                 36s
</span></span></code></pre></div><p>And if I log into the NAS, I can see the pvc subdirectory in my <code>blog-demo</code> share</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">cd</span> /volume2/blog-demo
</span></span><span class="line"><span class="cl">$ ls -lah
</span></span><span class="line"><span class="cl">Permissions Size User  Date Modified Name
</span></span><span class="line"><span class="cl">drwxrwx---     - admin <span class="m">20</span> Jan 00:30  <span class="c1">#recycle</span>
</span></span><span class="line"><span class="cl">drwxrwxrwx@    - root   <span class="m">6</span> Jan 23:22  @eaDir
</span></span><span class="line"><span class="cl">drwxrwxrwx     - talos <span class="m">25</span> Jan 13:51  pvc-5e3acec4-af9e-4cbd-8613-10c64ad7ebaa
</span></span><span class="line"><span class="cl">$ cat pvc-5e3acec4-af9e-4cbd-8613-10c64ad7ebaa/csi-demo.txt
</span></span><span class="line"><span class="cl">Demo smb-csi
</span></span><span class="line"><span class="cl">Sun Jan <span class="m">25</span> 20:56:51 UTC <span class="m">2026</span>
</span></span></code></pre></div><h2 id="practical-usage-back-up-talos-etcd-cluster">Practical Usage: Back up Talos&rsquo; etcd cluster<a hidden class="anchor" aria-hidden="true" href="#practical-usage-back-up-talos-etcd-cluster">#</a></h2>
<p>Now that we&rsquo;ve confirmed our configuration can connect to our NAS, let&rsquo;s set up backups for the etcd cluster. These examples are Talos-specific, but still a good example of using SMB storage in cluster cron jobs.</p>
<h3 id="set-up-the-persistentvolue-and-persistentvolumeclaim-to-use-for-backups">Set up the PersistentVolue and PersistentVolumeClaim to use for backups<a hidden class="anchor" aria-hidden="true" href="#set-up-the-persistentvolue-and-persistentvolumeclaim-to-use-for-backups">#</a></h3>
<p>First, create a <code>PersistentVolume</code> that connects to our backups share.</p>
<p><strong>IMPORTANT: You must set <code>persistentVolumeReclaimPolicy</code> to <code>Retain</code> so the CSI doesn&rsquo;t delete the pvc&rsquo;s remote directory if we delete the pvc or we could accidentally wipe our backups volume!</strong></p>
<p>Since we&rsquo;re doing static provisioning, we also need to set <code>storageClassName</code> to <code>&quot;&quot;</code> in both the <code>PersistentVolume</code> and the <code>PersistentVolumeClaim</code> that uses it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># backups.smb.setup.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv-backups-share</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w"> </span><span class="c"># Set an appropriate size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w"> </span><span class="c"># Allows the volume to be mounted by many nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># IMPORTANT: Set persistentVolumeReclaimPolicy to Retain so the CSI doesn&#39;t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># delete the pvc&#39;s remote directory if we delete the pvc or we could</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># accidentally wipe our backups volume!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w"> </span><span class="c"># Must be an empty string for static provisioning</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">csi</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">smb.csi.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeHandle</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-backups-smb-unseen</span><span class="w"> </span><span class="c"># A unique name for the volume handle</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeAttributes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;\\\\unseen.miniclusters.rocks\\k8s-backups&#34;</span><span class="w"> </span><span class="c"># Use escaped backslashes or forward slashes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeStageSecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-smb-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w"> </span><span class="c"># The namespace where you created the secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pvc-backups-share</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w"> </span><span class="c"># Must match the empty string in the PV</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l">pv-backups-share</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span></code></pre></div><h3 id="create-a-talosconfig-secret">Create a talosconfig secret<a hidden class="anchor" aria-hidden="true" href="#create-a-talosconfig-secret">#</a></h3>
<p>The backup script needs to run talosctl to extract a backup from the cluster&rsquo;s etcd, so let&rsquo;s create a secret</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create secret generic backups-talosconfig <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --from-file talosconfig <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --namespace backups
</span></span></code></pre></div><p>Our <code>CronJob</code> will mount that into the backup pod at <code>/etc/talos/talosconfig</code>.</p>
<h3 id="create-a-cronjob">Create a CronJob<a hidden class="anchor" aria-hidden="true" href="#create-a-cronjob">#</a></h3>
<p>We&rsquo;re going to use my <a href="https://hub.docker.com/repository/docker/unixorn/talosctl-backup/general">unixorn/talosctl-backup</a> image to run my <code>tal-backup-etcd</code> script to backup etcd. Source for both the docker image and `tal-backup-etcd can be found on Github at <a href="https://github.com/unixorn/talosctl-etcd-backups">unixorn/talosctl-etcd-backups</a>.</p>
<p>By default, after a successful backup, <code>tal-backup-etcd</code> deletes any backups in the backup directory older than <code>$KEEP_DAYS</code> old.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># etcd-backup.cronjob.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cron-backup-void-etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Standard cron syntax: minute hour day-of-month month day-of-week</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;11 1 * * *&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeZone</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;America/Denver&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">successfulJobsHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">failedJobsHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">concurrencyPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Forbid</span><span class="w"> </span><span class="c"># Prevents a new backup if the old one is still running</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ttlSecondsAfterFinished</span><span class="p">:</span><span class="w"> </span><span class="m">604800</span><span class="w"> </span><span class="c"># Keep jobs for a week so I can examine their logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">unixorn/talosctl-backup:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">TZ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;America/Denver&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">BACKUP_D</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/backups/etcd-backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">KEEP_DAYS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PRUNE_OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">TALOSCONFIG</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/talos/talosconfig&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;64Mi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;250m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;64Mi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;/usr/local/bin/tal-backup-etcd ; ls -lah /mnt/backups/void-etcd&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/mnt/backups&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">talosconfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/talos&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">pvc-backups-share</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">talosconfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">backups-talosconfig</span><span class="w">
</span></span></span></code></pre></div><p>You can now install the <code>CronJob</code> with <code>kubectl apply -f etc-backup.cronjob.yaml</code></p>
<h3 id="bonus-job-manifest">Bonus Job manifest<a hidden class="anchor" aria-hidden="true" href="#bonus-job-manifest">#</a></h3>
<p>Having a cluster <code>CronJob</code> is great, but you probably don&rsquo;t want to wait until 1 am to see if it works. It&rsquo;s also handy to be able to run a backup immediately if you&rsquo;re planning to do an experiment that might break your etcd.</p>
<p>Here&rsquo;s a Job you can use to test or run backups at arbitrary times.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># immmediate-backup.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-void-etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ttlSecondsAfterFinished</span><span class="p">:</span><span class="w"> </span><span class="m">604800</span><span class="w"> </span><span class="c"># Keep results around for a week</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">unixorn/talosctl-backup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">TZ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;America/Denver&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">BACKUP_D</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/backups/etcd-backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">KEEP_DAYS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PRUNE_OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">TALOSCONFIG</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/talosconfig/talosconfig&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;64Mi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;250m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;64Mi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;/usr/local/bin/tal-backup-etcd ; ls -lah /mnt/backups/etcd-backups&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/mnt/backups&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">talosconfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/talosconfig&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">      </span><span class="c"># Moved inside pod spec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backups-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">pvc-backups-share</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">talosconfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">backups-talosconfig</span><span class="w">
</span></span></span></code></pre></div><p>Use <code>kubectl apply -f immediate-backup.yaml</code> to run it.</p>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>You should now have:</p>
<ul>
<li>Installed the SMB CSI driver into your cluster</li>
<li>Created a <code>StorageClass</code> that stores files on a NAS</li>
<li>Created a <code>Deployment</code> that shows how to keep a pod&rsquo;s work files on an SMB share</li>
<li>Created a <code>PersistentVolume</code> that connects to a backups share and does <em>not</em> delete files after pvcs using it have been deleted from your cluster</li>
<li>Created a <code>PersistentVolumeClaim</code> that backup jobs can use to write backups to your SMB server</li>
<li>Created a <code>CronJob</code> and a <code>Job</code> that you can use to back up your etcd cluster both via cron and at arbitrary times.</li>
<li>Backed up your etcd</li>
</ul>


  </div>
  <div>
    
  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/backups/">Backups</a></li>
      <li><a href="http://localhost:1313/tags/etcd/">Etcd</a></li>
      <li><a href="http://localhost:1313/tags/homelab/">Homelab</a></li>
      <li><a href="http://localhost:1313/tags/k8s/">K8s</a></li>
      <li><a href="http://localhost:1313/tags/smb/">Smb</a></li>
      <li><a href="http://localhost:1313/tags/talos/">Talos</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/post/homelab/k8s/03-secret-management-with-sops/">
    <span class="title">Next »</span>
    <br>
    <span>Secret Management with SOPS</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Back up your Talos etcd cluster to a smb share on x"
            href="https://x.com/intent/tweet/?text=Back%20up%20your%20Talos%20etcd%20cluster%20to%20a%20smb%20share&amp;url=http%3a%2f%2flocalhost%3a1313%2fpost%2fhomelab%2fk8s%2f04-backup-talos-etcd-to-smb%2f&amp;hashtags=backups%2cetcd%2chomelab%2ck8s%2csmb%2ctalos">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Back up your Talos etcd cluster to a smb share on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fpost%2fhomelab%2fk8s%2f04-backup-talos-etcd-to-smb%2f&amp;title=Back%20up%20your%20Talos%20etcd%20cluster%20to%20a%20smb%20share&amp;summary=Back%20up%20your%20Talos%20etcd%20cluster%20to%20a%20smb%20share&amp;source=http%3a%2f%2flocalhost%3a1313%2fpost%2fhomelab%2fk8s%2f04-backup-talos-etcd-to-smb%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Back up your Talos etcd cluster to a smb share on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fhomelab%2fk8s%2f04-backup-talos-etcd-to-smb%2f&title=Back%20up%20your%20Talos%20etcd%20cluster%20to%20a%20smb%20share">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Back up your Talos etcd cluster to a smb share on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fpost%2fhomelab%2fk8s%2f04-backup-talos-etcd-to-smb%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Back up your Talos etcd cluster to a smb share on whatsapp"
            href="https://api.whatsapp.com/send?text=Back%20up%20your%20Talos%20etcd%20cluster%20to%20a%20smb%20share%20-%20http%3a%2f%2flocalhost%3a1313%2fpost%2fhomelab%2fk8s%2f04-backup-talos-etcd-to-smb%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Back up your Talos etcd cluster to a smb share on telegram"
            href="https://telegram.me/share/url?text=Back%20up%20your%20Talos%20etcd%20cluster%20to%20a%20smb%20share&amp;url=http%3a%2f%2flocalhost%3a1313%2fpost%2fhomelab%2fk8s%2f04-backup-talos-etcd-to-smb%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Back up your Talos etcd cluster to a smb share on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Back%20up%20your%20Talos%20etcd%20cluster%20to%20a%20smb%20share&u=http%3a%2f%2flocalhost%3a1313%2fpost%2fhomelab%2fk8s%2f04-backup-talos-etcd-to-smb%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>Copyright 2019-2024, Joe Block. All rights reserved.</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <a rel="me" href="https://hachyderm.io/@unixorn">Mastodon</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
