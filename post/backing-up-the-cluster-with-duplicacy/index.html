<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Backing Up the Cluster with Duplicacy | unixorn.github.io</title>
<meta name="keywords" content="arm, arm7, b2, backups, deprecated, docker, k3s, k8s, kubernetes, tech">
<meta name="description" content="Motivation
I wanted to ensure any data I put into my ARM k3s cluster is backed up to prevent data loss.
I no longer recommend duplicacy. Instead, read my article on restic backups on TrueNas instead.">
<meta name="author" content="Me">
<link rel="canonical" href="https://unixorn.github.io/post/backing-up-the-cluster-with-duplicacy/">
<meta name="google-site-verification" content="UA-100853138-2">
<link crossorigin="anonymous" href="https://unixorn.github.io/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="https://unixorn.github.io/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://unixorn.github.io/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Backing Up the Cluster with Duplicacy" />
<meta property="og:description" content="Motivation
I wanted to ensure any data I put into my ARM k3s cluster is backed up to prevent data loss.
I no longer recommend duplicacy. Instead, read my article on restic backups on TrueNas instead." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://unixorn.github.io/post/backing-up-the-cluster-with-duplicacy/" /><meta property="og:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-09-01T15:47:23-06:00" />
<meta property="article:modified_time" content="2019-09-01T15:47:23-06:00" /><meta property="og:site_name" content="The Plural of SRE is an Outage" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://unixorn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"/>

<meta name="twitter:title" content="Backing Up the Cluster with Duplicacy"/>
<meta name="twitter:description" content="Motivation
I wanted to ensure any data I put into my ARM k3s cluster is backed up to prevent data loss.
I no longer recommend duplicacy. Instead, read my article on restic backups on TrueNas instead."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://unixorn.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Backing Up the Cluster with Duplicacy",
      "item": "https://unixorn.github.io/post/backing-up-the-cluster-with-duplicacy/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Backing Up the Cluster with Duplicacy",
  "name": "Backing Up the Cluster with Duplicacy",
  "description": "Motivation I wanted to ensure any data I put into my ARM k3s cluster is backed up to prevent data loss.\nI no longer recommend duplicacy. Instead, read my article on restic backups on TrueNas instead.\n",
  "keywords": [
    "arm", "arm7", "b2", "backups", "deprecated", "docker", "k3s", "k8s", "kubernetes", "tech"
  ],
  "articleBody": "Motivation I wanted to ensure any data I put into my ARM k3s cluster is backed up to prevent data loss.\nI no longer recommend duplicacy. Instead, read my article on restic backups on TrueNas instead.\nBackup Contenders I took a look at CrashPlan, restic and Duplicacy.\nCrashPlan - Even though they have a decent linux client, I eliminated Crashplan because:\nThey’ve already abandoned the home market. I currently use their CrashPlan for Small Business account for my Mac. I suspect they’ll also abandon this market because accounts with a small number of licenses also aren’t worth their time. They bill per-machine instead of by the amount of storage used. restic - Open source, which is great, but I ended up eliminating them because their deduplication wasn’t as strong as Duplicacy. It also seemed a little awkward to prune snapshots when I experimented with it.\nDuplicacy - I chose Duplicacy because it:\nSupports cross-source deduplication Works well with B2 Runs on Linux, Windows and Mac Allows multiple source directories to be backed up simultaneously to the same B2 bucket. Continues backing up where it leaves off after being interrupted and restarted. This eliminates having to completely restart the backup and re-upload everything. It didn’t hurt that I know several people using it with large amounts of data who are happy with it.\nOn to the Backups I made a docker image, thoth-duplicacy, which installs duplicacy and duplicacy-util on top of debian buster-slim, along with some helper scripts to make using it more convenient.\nThe image is published on docker hub, with both an Intel and and ARM7 version - the most current builds are tagged unixorn/thoth-duplicacy:armv7l and unixorn/thoth-duplicacy:x86_64.\nUsage For simplicity, I’m running my backups as kubernetes cron jobs. This allows me to easily run backups of multiple directory trees at once, and the kubernetes scheduler will automagically spread them around the cluster to the least loaded nodes.\nPre-requisites Create a Kubernetes Namespace I like my cluster neat and organized, with different services in their own namespaces, so I created a backups namespace by running kubectl create namespace backup.\nSet up a B2 Storage Bucket for Duplicacy Create a B2 Bucket and App Key Create a bucket in B2. Only use this bucket for duplicacy backups.. Do this first so that when you create the app key, using the dropdown menu you can easily restrict its access to only this bucket. Create an app key in B2 that you only use with Duplicacy. Definitely do not use the root account’s credentials. When you create it, specify that it’s only allowed to use your backups bucket. Make sure to copy the app key information when you create it, it will only be displayed once. Now you’re ready to initialize the bucket for the first directory you want to back up. The easiest way to do this is by running duplicacy inside the thoth-duplicacy container with docker-compose.\nSet up thoth-duplicacy container git clone git@github.com:unixorn/thoth-duplicacy.git BACKUP_LOCATION=/that/first/directory docker-compose run thoth-duplicacy bash cd /data mkdir -p .duplicacy Initialize the B2 Bucket. duplicacy init -encrypt -storage-name b2 STORAGEID b2://yourbucket. STORAGEID cannot have spaces or any special characters besides - and _. duplicacy will prompt you for the B2 app ID, app key, and the encryption password for your backups. Store the password in your secure password manager - without it, you can’t restore any of your data. Annoyingly you have to also set the password, B2 id and key again after initializing the bucket so that backups won’t prompt you for them. Set the B2 ID - duplicacy set -storage b2://net-unixorn-blog-test -key b2_id -value YOUR_APP_ID Set the B2 key - duplicacy set -storage b2://net-unixorn-blog-test -key b2_key -value YOUR_APP_KEY Set the password - duplicacy set -storage b2://net-unixorn-blog-test -key password -value YOURPASSWORD You can now run backup-cronjob and watch the first backup grind.\nAfter I configured duplicacy for the first time, it was much less hassle to copy the .duplicacy/preferences json file to each new directory tree. I wanted to back up the .duplicacy directory and change the id key to a new unique one — don’t put spaces or any special characters in the id other than _ and -. You don’t have to change the storage key, and actually shouldn’t - sharing the same storage bucket is what allows duplicacy to deduplicate your files across multiple source directories, which keeps your storage bill down.\nHere’s an example preferences file -\n[ { \"name\": \"b2\", \"id\": \"UNIQUE_ID_FOR_YOUR_DIRECTORY\", \"repository\": \"\", \"storage\": \"b2://your-backups-bucket\", \"encrypted\": true, \"no_backup\": false, \"no_restore\": false, \"no_save_password\": false, \"nobackup_file\": \"\", \"keys\": { \"b2_id\": \"ROLE_ACCOUNT_B2_ID\", \"b2_key\": \"ROLE_ACCOUNT_B2_KEY\", \"password\": \"SUPER_SECRET_ENCRYPTION_PASSWORD_FOR_YOUR_DATA\" } } ] Backing up a Directory Tree Here’s a sample job that backs up one of my directory trees. I’m using the backups namespace that I created earlier to keep things tidy - if you want to use the default namespace instead, delete the namespace entry in the metadata section.\nHere’s some things you’ll need to customize if you base a job on this example:\nChange the namespace entry in the metadata section to match whichever namespace you decided to use. I run this on Odroid HC2s and Raspberry Pis, which both use ARM CPUs. If you’re using x86, change the image entry to unixorn/thoth-duplicacy:x86_64 in the template spec section. I work from home, so I want to restrict the number of upload threads so that running backups don’t burn all my upload bandwidth. Change DUPLICACY_BACKUP_THEAD_COUNT in the env section if you want more simultaneous threads. The odroids only have 8 cores, but I had no issues running 12 threads other than gobbling up upstream bandwith. The B2_STORAGE_NAME environment variable is used by the backup-cronjob script to determine where to write the backup, so alter the value according to your setup. I’m backing up a moosefs distributed file system. I had already tagged all my chunk servers with kubectl label node NODENAME odroid=true and I use a nodeSelector stanza in the backup cron jobs to restrict the backup to only run on one of the chunk servers where the data resides. The moosefs data is distributed across all the chunk servers and each chunk server in the cluster currently contains 33% of the files, so running the backup on a chunk server maximizes the amount of data that can be local reads and don’t have to go across the network. Update or delete the nodeSelector clause to work with your environment. Once you’ve updated the file, install the cronjob with kubectl apply -f backup-example-directory-tree.yml.\nYou can download this from backup-example-directory-tree.yml instead of hassling with copy and paste.\napiVersion: batch/v1beta1 kind: CronJob metadata: name: backup-exampledir namespace: backups spec: schedule: \"35 */2 * * *\" jobTemplate: spec: # Ensure only one copy of the backup is running, even if it takes # so long to run that it is still running when the next cron slot # occurs concurrencyPolicy: Forbid template: spec: containers: - name: backup-exampledir # I'm running this on the odroids in my cluster, so I'm specifying # the ARM7 build image: unixorn/thoth-duplicacy:arm7l # Use the x86_64 tag if you're on Intel # image: unixorn/thoth-duplicacy:x86_64 args: - /bin/sh - -c - /usr/local/bin/backup-cronjob volumeMounts: - name: data-volume mountPath: /data/ env: # I want to restrict the number of threads used for uploads # so that duplicacy doesn't consume all my upload bandwidth. # I don't care if it makes my backups slower. - name: DUPLICACY_BACKUP_THEAD_COUNT value: \"3\" # backup-cronjob needs to know what defined storage to back up # files to. - name: B2_STORAGE_NAME value: \"b2\" restartPolicy: OnFailure # Keep it running on a chunkserver so that at least part of the # I/O is to local disk instead of across the network. Remove if # you don't care what node backups happen on. nodeSelector: odroid: \"true\" volumes: - name: data-volume hostPath: # This will be remapped to /data which is where duplicacy # expects to find the data it is backing up, and the .duplicacy # directory with its settings. path: /dfs/volumes/exampledir # this field is optional type: Directory Pruning Snapshots I don’t want to keep snapshots forever, so I made a kubernetes cron job to clean them up.\nBriefly, you can specify multiple -keep X:Y arguments, where you keep one snapshot for every X days after the snapshots are older than Y days.\nFor example, in the purge-stale-duplicacy-snapshots.yml job below, I have it set with -keep 0:365 -keep 30:90 -keep 7:30 -keep 1:2, which means keep no snapshots more than 365 days old, for snapshots older than 90 days keep one every 30 days, after fourteen days keep one every seven days, and after two days keep one every day.\nWarning: Notice that I specified the expiration rules starting with the longest (365 days) and continuing in descending age order - a minor annoyance with duplicacy is that you have to specify the -keep clauses starting with the longest age threshold and then specify the rules for shorter thresholds, or duplicacy will ignore the rules specified out of order, which could lead to more snapshots being purged than you would expect. Run with -dry-run first so you can see whether all your rules are being applied as you expect.\nBefore using this job definition, at a minimum you should set the namespace for the cron job, update the image if you’re running on x86, and update the -keep X:Y statements to correspond with your snapshot retention policy.\nOnce you’ve updated the configuration, install the cron job with kubectl apply -f purge-stale-duplicacy-snapshots.yml\nYou can download this from purge-stale-duplicacy-snapshots.yml instead of hassling with copy and paste.\napiVersion: batch/v1beta1 kind: CronJob metadata: name: purge-stale-duplicacy-snapshots namespace: backups spec: schedule: \"48 */3 * * *\" jobTemplate: spec: concurrencyPolicy: Forbid template: spec: containers: - name: purge-stale-duplicacy-snapshots # I'm running this on the odroids in my cluster, so I'm specifying # the ARM7 build image: unixorn/thoth-duplicacy:arm7l # Use the x86_64 tag if you're on Intel # image: unixorn/thoth-duplicacy:x86_64 # Make sure we run inside /data so that duplicacy can find # the configuration directory. workingDir: /data # Remember that the -keep arguments must be listed from longest # time frame to shortest, otherwise the disordered ones will be # ignored, which could mean deleting snapshots you want to keep. # # I'm specifying to keep no snapshots more than 365 days old, keep # a single snapshot every 30 days for snapshots older than 90 days, # a single snapshot a week for snapshots older than 30 days, and # finally keep only a single snapshot per day for snapshots # older than 2 days. # # Also note that the duplicacy verb (prune) has to come before # any of the settings command line options. args: - duplicacy - prune - -storage - b2 - -all - -keep 0:365 - -keep 30:90 - -keep 7:14 - -keep 1:2 - -exhaustive volumeMounts: - name: data-volume mountPath: /data/ env: - name: DUPLICACY_BACKUP_THEAD_COUNT value: \"3\" - name: B2_STORAGE_NAME value: \"b2\" restartPolicy: OnFailure volumes: - name: data-volume hostPath: # This will be remapped to /data which is where duplicacy # expects to find the data it is backing up, and the .duplicacy # directory with its settings. path: /dfs/volumes/exampledir # this field is optional type: Directory Restoring Files Backups are useless if you can’t restore.\nTo restore, use docker-compose and the thoth-duplicacy repository. I only did my test restores with the command line, I haven’t bothered experimenting with the GUI from https://duplicacy.com.\nUse git clone git@github.com:unixorn/thoth-duplicacy.git if you didn’t keep the checkout when you initialized your B2 bucket Make a directory to restore to, and a .duplicacy subdirectory for the configuration with mkdir -p /path/to/restore/.duplicacy. While you can restore in place over the live directory, I’m a bit too cautious to do that especially if I’m doing a restore after having already lost files. Copy the preferences file from the directory tree you want to restore to /path/to/restore/.duplicacy. Start a container with BACKUP_LOCATION=/path/to/restore docker-compose run thoth-duplicacy bash Now that you’re in a running thoth-duplicacy container with your restore directory mounted as /data, you can restore files. cd /data before running duplicacy commands so it can find its configuration.\nYou can look at the available snapshots with duplicacy list. It will list snapshot name, revision number, and the timestamp when each snapshot was created.\nOnce you know what snapshots are in the bucket, you can examine the files available in a specific snapshot with duplicacy list -files -r REVISION_NUMBER.\nNow you can restore files - if you want to restore just the foo directory, from revision 99, you’d run duplicacy restore -r 99 'foo/*'.\n",
  "wordCount" : "2087",
  "inLanguage": "en",
  "datePublished": "2019-09-01T15:47:23-06:00",
  "dateModified": "2019-09-01T15:47:23-06:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://unixorn.github.io/post/backing-up-the-cluster-with-duplicacy/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "unixorn.github.io",
    "logo": {
      "@type": "ImageObject",
      "url": "https://unixorn.github.io/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://unixorn.github.io/" accesskey="h" title="Home (Alt + H)">
                <img src="https://unixorn.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://unixorn.github.io/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/projects/" title="projects">
                    <span>projects</span>
                </a>
            </li>
            <li>
                <a href="https://unixorn.github.io/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://hachyderm.io/@unixorn" title="hachyderm.io/@unixorn">
                    <span>hachyderm.io/@unixorn</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">
<link rel="stylesheet" type="text/css" href="https://unixorn.github.io/css/mastodon.css" />
<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://unixorn.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://unixorn.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      Backing Up the Cluster with Duplicacy
    </h1>
    <div class="post-meta"><span title='2019-09-01 15:47:23 -0600 -0600'>September 1, 2019</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;2087 words&nbsp;·&nbsp;Me

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#motivation">Motivation</a></li>
    <li><a href="#backup-contenders">Backup Contenders</a></li>
    <li><a href="#on-to-the-backups">On to the Backups</a></li>
    <li><a href="#usage">Usage</a></li>
    <li><a href="#pre-requisites">Pre-requisites</a>
      <ul>
        <li><a href="#create-a-kubernetes-namespace">Create a Kubernetes Namespace</a></li>
        <li><a href="#set-up-a-b2-storage-bucket-for-duplicacy">Set up a B2 Storage Bucket for Duplicacy</a></li>
      </ul>
    </li>
    <li><a href="#backing-up-a-directory-tree">Backing up a Directory Tree</a>
      <ul>
        <li><a href="#pruning-snapshots">Pruning Snapshots</a></li>
      </ul>
    </li>
    <li><a href="#restoring-files">Restoring Files</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="motivation">Motivation<a hidden class="anchor" aria-hidden="true" href="#motivation">#</a></h2>
<p>I wanted to ensure any data I put into my <a href="https://unixorn.github.io/post/k3s-on-arm/">ARM k3s cluster</a> is backed up to prevent data loss.</p>
<p>I no longer recommend duplicacy. Instead, read my article on <a href="https://unixorn.github.io/post/restic-backups-on-truenas/">restic backups on TrueNas</a> instead.</p>
<h2 id="backup-contenders">Backup Contenders<a hidden class="anchor" aria-hidden="true" href="#backup-contenders">#</a></h2>
<p>I took a look at <a href="https://www.crashplan.com">CrashPlan</a>, <a href="https://restic.net">restic</a> and <a href="https://github.com/gilbertchen/duplicacy">Duplicacy</a>.</p>
<ul>
<li>
<p><a href="https://www.crashplan.com">CrashPlan</a> - Even though they have a decent linux client, I eliminated Crashplan because:</p>
<ul>
<li>They&rsquo;ve already abandoned the home market. I currently use their CrashPlan for Small Business account for my Mac. I suspect they&rsquo;ll also abandon this market because accounts with a small number of licenses also aren&rsquo;t worth their time.</li>
<li>They bill per-machine instead of by the amount of storage used.</li>
</ul>
</li>
<li>
<p><a href="https://restic.net">restic</a> - Open source, which is great, but I ended up eliminating them because their deduplication wasn&rsquo;t as strong as Duplicacy. It also seemed a little awkward to prune snapshots when I experimented with it.</p>
</li>
<li>
<p><a href="https://github.com/gilbertchen/duplicacy">Duplicacy</a> - I chose <code>Duplicacy</code> because it:</p>
<ul>
<li>Supports cross-source deduplication</li>
<li>Works well with B2</li>
<li>Runs on Linux, Windows and Mac</li>
<li>Allows multiple source directories to be backed up simultaneously to the same B2 bucket.</li>
<li>Continues backing up where it leaves off after being interrupted and restarted. This eliminates having to completely restart the backup and re-upload everything.</li>
</ul>
</li>
</ul>
<p>It didn&rsquo;t hurt that I know several people using it with large amounts of data who are happy with it.</p>
<h2 id="on-to-the-backups">On to the Backups<a hidden class="anchor" aria-hidden="true" href="#on-to-the-backups">#</a></h2>
<p>I made a docker image, <a href="https://github.com/unixorn/thoth-duplicacy">thoth-duplicacy</a>, which installs duplicacy and <a href="https://github.com/jeffaco/duplicacy-util">duplicacy-util</a> on top of debian buster-slim, along with some helper scripts to make using it more convenient.</p>
<p>The image is published on docker hub, with both an Intel and and ARM7 version - the most current builds are tagged <code>unixorn/thoth-duplicacy:armv7l</code> and <code>unixorn/thoth-duplicacy:x86_64</code>.</p>
<h2 id="usage">Usage<a hidden class="anchor" aria-hidden="true" href="#usage">#</a></h2>
<p>For simplicity, I&rsquo;m running my backups as kubernetes cron jobs. This allows me to easily run backups of multiple directory trees at once, and the kubernetes scheduler will automagically spread them around the cluster to the least loaded nodes.</p>
<h2 id="pre-requisites">Pre-requisites<a hidden class="anchor" aria-hidden="true" href="#pre-requisites">#</a></h2>
<h3 id="create-a-kubernetes-namespace">Create a Kubernetes Namespace<a hidden class="anchor" aria-hidden="true" href="#create-a-kubernetes-namespace">#</a></h3>
<p>I like my cluster neat and organized, with different services in their own namespaces, so I created a <strong>backups</strong> namespace by running <code>kubectl create namespace backup</code>.</p>
<h3 id="set-up-a-b2-storage-bucket-for-duplicacy">Set up a B2 Storage Bucket for Duplicacy<a hidden class="anchor" aria-hidden="true" href="#set-up-a-b2-storage-bucket-for-duplicacy">#</a></h3>
<h4 id="create-a-b2-bucket-and-app-key">Create a B2 Bucket and App Key<a hidden class="anchor" aria-hidden="true" href="#create-a-b2-bucket-and-app-key">#</a></h4>
<ol>
<li>Create a bucket in B2. <strong>Only use this bucket for <code>duplicacy</code> backups.</strong>. Do this first so that when you create the app key, using the dropdown menu you can easily restrict its access to only this bucket.</li>
<li>Create an app key in B2 that you only use with Duplicacy. Definitely do <strong>not</strong> use the root account&rsquo;s credentials. <strong>When you create it, specify that it&rsquo;s only allowed to use your backups bucket.</strong> Make sure to copy the app key information when you create it, it will only be displayed once.</li>
</ol>
<p>Now you&rsquo;re ready to initialize the bucket for the first directory you want to back up. The easiest way to do this is by running <code>duplicacy</code> inside the <code>thoth-duplicacy</code> container with <code>docker-compose</code>.</p>
<h4 id="set-up-thoth-duplicacy-container">Set up thoth-duplicacy container<a hidden class="anchor" aria-hidden="true" href="#set-up-thoth-duplicacy-container">#</a></h4>
<ol>
<li><code>git clone git@github.com:unixorn/thoth-duplicacy.git</code></li>
<li><code>BACKUP_LOCATION=/that/first/directory docker-compose run thoth-duplicacy bash</code></li>
<li><code>cd /data</code></li>
<li><code>mkdir -p .duplicacy</code></li>
</ol>
<h4 id="initialize-the-b2-bucket">Initialize the B2 Bucket.<a hidden class="anchor" aria-hidden="true" href="#initialize-the-b2-bucket">#</a></h4>
<ol>
<li><code>duplicacy init -encrypt -storage-name b2 STORAGEID b2://yourbucket</code>. STORAGEID cannot have spaces or any special characters besides <code>-</code> and <code>_</code>. <code>duplicacy</code> will prompt you for the B2 app ID, app key, and the encryption password for your backups. Store the password in your secure password manager - <strong>without it, you can&rsquo;t restore any of your data</strong>. Annoyingly you have to also set the password, B2 id and key again after initializing the bucket so that backups won&rsquo;t prompt you for them.</li>
<li>Set the B2 ID - <code>duplicacy set -storage b2://net-unixorn-blog-test -key b2_id -value YOUR_APP_ID</code></li>
<li>Set the B2 key - <code>duplicacy set -storage b2://net-unixorn-blog-test -key b2_key -value YOUR_APP_KEY</code></li>
<li>Set the password - <code>duplicacy set -storage b2://net-unixorn-blog-test -key password -value YOURPASSWORD</code></li>
</ol>
<p>You can now run <code>backup-cronjob</code> and watch the first backup grind.</p>
<p>After I configured <code>duplicacy</code> for the first time, it was much less hassle to copy the <code>.duplicacy/preferences</code> json file to each new directory tree. I wanted to back up the <code>.duplicacy</code> directory and change the <strong>id</strong> key to a new unique one — don&rsquo;t put spaces or any special characters in the id other than <code>_</code> and <code>-</code>. You don&rsquo;t have to change the storage key, and actually shouldn&rsquo;t - sharing the same storage bucket is what allows <code>duplicacy</code> to deduplicate your files across multiple source directories, which keeps your storage bill down.</p>
<p>Here&rsquo;s an example <code>preferences</code> file -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;b2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;UNIQUE_ID_FOR_YOUR_DIRECTORY&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;repository&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;storage&#34;</span><span class="p">:</span> <span class="s2">&#34;b2://your-backups-bucket&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;encrypted&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;no_backup&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;no_restore&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;no_save_password&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;nobackup_file&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;b2_id&#34;</span><span class="p">:</span> <span class="s2">&#34;ROLE_ACCOUNT_B2_ID&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;b2_key&#34;</span><span class="p">:</span> <span class="s2">&#34;ROLE_ACCOUNT_B2_KEY&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;SUPER_SECRET_ENCRYPTION_PASSWORD_FOR_YOUR_DATA&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h2 id="backing-up-a-directory-tree">Backing up a Directory Tree<a hidden class="anchor" aria-hidden="true" href="#backing-up-a-directory-tree">#</a></h2>
<p>Here&rsquo;s a sample job that backs up one of my directory trees. I&rsquo;m using the <strong>backups</strong> namespace that I created earlier to keep things tidy - if you want to use the default namespace instead, delete the namespace entry in the metadata section.</p>
<p>Here&rsquo;s some things you&rsquo;ll need to customize if you base a job on this example:</p>
<ul>
<li>Change the <strong>namespace</strong> entry in the metadata section to match whichever namespace you decided to use.</li>
<li>I run this on Odroid HC2s and Raspberry Pis, which both use ARM CPUs. If you&rsquo;re using x86, change the <strong>image</strong> entry to <code>unixorn/thoth-duplicacy:x86_64</code> in the template spec section.</li>
<li>I work from home, so I want to restrict the number of upload threads so that running backups don&rsquo;t burn all my upload bandwidth. Change <code>DUPLICACY_BACKUP_THEAD_COUNT</code> in the env section if you want more simultaneous threads. The odroids only have 8 cores, but I had no issues running 12 threads other than gobbling up upstream bandwith.</li>
<li>The <code>B2_STORAGE_NAME</code> environment variable is used by the <a href="https://github.com/unixorn/thoth-duplicacy/blob/master/bin/backup-cronjob">backup-cronjob</a> script to determine where to write the backup, so alter the value according to your setup.</li>
<li>I&rsquo;m backing up a <a href="https://unixorn.github.io/post/adding-a-distributed-filesystem-to-cluster/">moosefs</a> distributed file system. I had already tagged all my chunk servers with <code>kubectl label node NODENAME odroid=true</code> and I use a <code>nodeSelector</code> stanza in the backup cron jobs to restrict the backup to only run on one of the chunk servers where the data resides. The moosefs data is distributed across all the chunk servers and each chunk server in the cluster currently contains 33% of the files, so running the backup on a chunk server maximizes the amount of data that can be local reads and don&rsquo;t have to go across the network. Update or delete the <code>nodeSelector</code> clause to work with your environment.</li>
</ul>
<p>Once you&rsquo;ve updated the file, install the cronjob with <code>kubectl apply -f backup-example-directory-tree.yml</code>.</p>
<p>You can download this from <a href="https://github.com/unixorn/blog-scripts/blob/master/duplicacy-examples/backup-example-directory-tree.yml">backup-example-directory-tree.yml</a> instead of hassling with copy and paste.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backup-exampledir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;35 */2 * * *&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Ensure only one copy of the backup is running, even if it takes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># so long to run that it is still running when the next cron slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># occurs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">concurrencyPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Forbid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">backup-exampledir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># I&#39;m running this on the odroids in my cluster, so I&#39;m specifying</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># the ARM7 build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">unixorn/thoth-duplicacy:arm7l</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># Use the x86_64 tag if you&#39;re on Intel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># image: unixorn/thoth-duplicacy:x86_64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/bin/sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/usr/local/bin/backup-cronjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># I want to restrict the number of threads used for uploads</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># so that duplicacy doesn&#39;t consume all my upload bandwidth.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># I don&#39;t care if it makes my backups slower.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DUPLICACY_BACKUP_THEAD_COUNT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># backup-cronjob needs to know what defined storage to back up</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># files to.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">B2_STORAGE_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;b2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># Keep it running on a chunkserver so that at least part of the</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># I/O is to local disk instead of across the network. Remove if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># you don&#39;t care what node backups happen on.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">odroid</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># This will be remapped to /data which is where duplicacy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># expects to find the data it is backing up, and the .duplicacy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># directory with its settings.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/dfs/volumes/exampledir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># this field is optional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Directory</span><span class="w">
</span></span></span></code></pre></div><h3 id="pruning-snapshots">Pruning Snapshots<a hidden class="anchor" aria-hidden="true" href="#pruning-snapshots">#</a></h3>
<p>I don&rsquo;t want to keep snapshots forever, so I made a kubernetes cron job to clean them up.</p>
<p>Briefly, you can specify multiple <code>-keep X:Y</code> arguments, where you keep one snapshot for every <code>X</code> days after the snapshots are older than <code>Y</code> days.</p>
<p>For example, in the <code>purge-stale-duplicacy-snapshots.yml</code> job below, I have it set with <code>-keep 0:365 -keep 30:90 -keep 7:30 -keep 1:2</code>, which means keep <em>no</em> snapshots more than 365 days old, for snapshots older than 90 days keep one every 30 days, after fourteen days keep one every seven days, and after two days keep one every day.</p>
<p><strong>Warning:</strong> Notice that I specified the expiration rules starting with the longest (365 days) and continuing in descending age order - a minor annoyance with <code>duplicacy</code> is that you have to specify the <code>-keep</code> clauses starting with the longest age threshold and then specify the rules for shorter thresholds, or <code>duplicacy</code> will ignore the rules specified out of order, which could lead to more snapshots being purged than you would expect. Run with <code>-dry-run</code> first so you can see whether all your rules are being applied as you expect.</p>
<p>Before using this job definition, at a minimum you should set the namespace for the cron job, update the image if you&rsquo;re running on x86, and update the <code>-keep X:Y</code> statements to correspond with your snapshot retention policy.</p>
<p>Once you&rsquo;ve updated the configuration, install the cron job with <code>kubectl apply -f purge-stale-duplicacy-snapshots.yml</code></p>
<p>You can download this from <a href="https://github.com/unixorn/blog-scripts/blob/master/duplicacy-examples/purge-stale-duplicacy-snapshots.yml">purge-stale-duplicacy-snapshots.yml</a> instead of hassling with copy and paste.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">purge-stale-duplicacy-snapshots</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">backups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;48 */3 * * *&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">concurrencyPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Forbid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">purge-stale-duplicacy-snapshots</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># I&#39;m running this on the odroids in my cluster, so I&#39;m specifying</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># the ARM7 build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">unixorn/thoth-duplicacy:arm7l</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># Use the x86_64 tag if you&#39;re on Intel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># image: unixorn/thoth-duplicacy:x86_64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># Make sure we run inside /data so that duplicacy can find</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># the configuration directory.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># Remember that the -keep arguments must be listed from longest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># time frame to shortest, otherwise the disordered ones will be</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># ignored, which could mean deleting snapshots you want to keep.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># I&#39;m specifying to keep no snapshots more than 365 days old, keep</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># a single snapshot every 30 days for snapshots older than 90 days,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># a single snapshot a week for snapshots older than 30 days, and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># finally keep only a single snapshot per day for snapshots</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># older than 2 days.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># Also note that the duplicacy verb (prune) has to come before</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># any of the settings command line options.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">duplicacy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">prune</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">storage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">b2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">keep 0:365</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">keep 30:90</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">keep 7:14</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">keep 1:2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">exhaustive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DUPLICACY_BACKUP_THEAD_COUNT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">B2_STORAGE_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;b2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># This will be remapped to /data which is where duplicacy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># expects to find the data it is backing up, and the .duplicacy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># directory with its settings.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/dfs/volumes/exampledir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c"># this field is optional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Directory</span><span class="w">
</span></span></span></code></pre></div><h2 id="restoring-files">Restoring Files<a hidden class="anchor" aria-hidden="true" href="#restoring-files">#</a></h2>
<p>Backups are useless if you can&rsquo;t restore.</p>
<p>To restore, use <code>docker-compose</code> and the thoth-duplicacy repository. I only did my test restores with the command line, I haven&rsquo;t bothered experimenting with the GUI from <a href="https://duplicacy.com">https://duplicacy.com</a>.</p>
<ol>
<li>Use <code>git clone git@github.com:unixorn/thoth-duplicacy.git</code> if you didn&rsquo;t keep the checkout when you initialized your B2 bucket</li>
<li>Make a directory to restore to, and a <code>.duplicacy</code> subdirectory for the configuration with <code>mkdir -p /path/to/restore/.duplicacy</code>. While you can restore in place over the live directory, I&rsquo;m a bit too cautious to do that especially if I&rsquo;m doing a restore after having already lost files.</li>
<li>Copy the <code>preferences</code> file from the directory tree you want to restore to <code>/path/to/restore/.duplicacy</code>.</li>
<li>Start a container with <code>BACKUP_LOCATION=/path/to/restore docker-compose run thoth-duplicacy bash</code></li>
</ol>
<p>Now that you&rsquo;re in a running <code>thoth-duplicacy</code> container with your restore directory mounted as <code>/data</code>, you can restore files. <code>cd /data</code> before running <code>duplicacy</code> commands so it can find its configuration.</p>
<ul>
<li>
<p>You can look at the available snapshots with <code>duplicacy list</code>. It will list snapshot name, revision number, and the timestamp when each snapshot was created.</p>
</li>
<li>
<p>Once you know what snapshots are in the bucket, you can examine the files available in a specific snapshot with <code>duplicacy list -files -r REVISION_NUMBER</code>.</p>
</li>
<li>
<p>Now you can restore files - if you want to restore just the <code>foo</code> directory, from revision 99, you&rsquo;d run <code>duplicacy restore -r 99 'foo/*'</code>.</p>
</li>
</ul>

  </div>
  <div>
    
  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://unixorn.github.io/tags/arm/">arm</a></li>
      <li><a href="https://unixorn.github.io/tags/arm7/">arm7</a></li>
      <li><a href="https://unixorn.github.io/tags/b2/">b2</a></li>
      <li><a href="https://unixorn.github.io/tags/backups/">backups</a></li>
      <li><a href="https://unixorn.github.io/tags/deprecated/">deprecated</a></li>
      <li><a href="https://unixorn.github.io/tags/docker/">docker</a></li>
      <li><a href="https://unixorn.github.io/tags/k3s/">k3s</a></li>
      <li><a href="https://unixorn.github.io/tags/k8s/">k8s</a></li>
      <li><a href="https://unixorn.github.io/tags/kubernetes/">kubernetes</a></li>
      <li><a href="https://unixorn.github.io/tags/tech/">tech</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://unixorn.github.io/post/setting-up-an-n2/">
    <span class="title">« Prev</span>
    <br>
    <span>Setting up an ODROID N2</span>
  </a>
  <a class="next" href="https://unixorn.github.io/post/growing-ebs-volumes-in-place/">
    <span class="title">Next »</span>
    <br>
    <span>Growing EBS Volumes in Place</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Backing Up the Cluster with Duplicacy on twitter"
        href="https://twitter.com/intent/tweet/?text=Backing%20Up%20the%20Cluster%20with%20Duplicacy&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fbacking-up-the-cluster-with-duplicacy%2f&amp;hashtags=arm%2carm7%2cb2%2cbackups%2cdeprecated%2cdocker%2ck3s%2ck8s%2ckubernetes%2ctech">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Backing Up the Cluster with Duplicacy on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fbacking-up-the-cluster-with-duplicacy%2f&amp;title=Backing%20Up%20the%20Cluster%20with%20Duplicacy&amp;summary=Backing%20Up%20the%20Cluster%20with%20Duplicacy&amp;source=https%3a%2f%2funixorn.github.io%2fpost%2fbacking-up-the-cluster-with-duplicacy%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Backing Up the Cluster with Duplicacy on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2funixorn.github.io%2fpost%2fbacking-up-the-cluster-with-duplicacy%2f&title=Backing%20Up%20the%20Cluster%20with%20Duplicacy">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Backing Up the Cluster with Duplicacy on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2funixorn.github.io%2fpost%2fbacking-up-the-cluster-with-duplicacy%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Backing Up the Cluster with Duplicacy on whatsapp"
        href="https://api.whatsapp.com/send?text=Backing%20Up%20the%20Cluster%20with%20Duplicacy%20-%20https%3a%2f%2funixorn.github.io%2fpost%2fbacking-up-the-cluster-with-duplicacy%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Backing Up the Cluster with Duplicacy on telegram"
        href="https://telegram.me/share/url?text=Backing%20Up%20the%20Cluster%20with%20Duplicacy&amp;url=https%3a%2f%2funixorn.github.io%2fpost%2fbacking-up-the-cluster-with-duplicacy%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>Copyright 2019-2023, Joe Block. All rights reserved.</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <a rel="me" href="https://hachyderm.io/@unixorn">Mastodon</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
